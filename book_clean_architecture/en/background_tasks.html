<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Background Tasks - Clean Architecture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&family=Merriweather:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script>hljs.highlightAll();</script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        h1, h2, h3, h4 { color: #0f172a; font-weight: 800; letter-spacing: -0.025em; }
        p, li { font-family: 'Merriweather', serif; line-height: 1.8; color: #334155; margin-bottom: 1em; }
        
        .sidebar { background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); border-right: 1px solid #334155; height: 100vh; position: fixed; width: 18rem; overflow-y: auto; z-index: 50; }
        .sidebar-title { color: #f8fafc; }
        .sidebar-subtitle { color: #60a5fa; }
        .nav-section { color: #94a3b8; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; padding: 1rem 1rem 0.5rem; }
        .nav-link { display: block; padding: 0.6rem 1rem; color: #94a3b8; font-weight: 500; font-size: 0.875rem; transition: all 0.2s; border-left: 3px solid transparent; text-decoration: none; }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: #f1f5f9; border-left-color: #475569; }
        .nav-link.active { background: rgba(59, 130, 246, 0.1); color: #60a5fa; border-left-color: #3b82f6; }

        pre {
            font-family: 'JetBrains Mono', monospace;
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 0.75rem;
            overflow-x: auto;
            font-size: 0.85rem;
            line-height: 1.6;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin: 1.5rem 0;
        }
        .code-keyword { color: #c084fc; font-weight: bold; } 
        .code-class { color: #fbbf24; font-weight: bold; }   
        .code-func { color: #60a5fa; font-weight: bold; }    
        .code-str { color: #a3e635; }                        
        .hljs-comment, .hljs-quote { color: #475569 !important; font-weight: 700 !important; font-style: normal !important; }
        .code-comment { color: #475569; font-style: normal; font-weight: 700; }
    </style>
</head>
<body class="flex bg-slate-50">

    <!-- SIDEBAR -->
    <aside class="sidebar hidden md:block">
        <div class="p-6 border-b border-gray-700">
            <h1 class="text-xl font-bold sidebar-title">Clean Architecture</h1>
            <span class="sidebar-subtitle text-sm">Author: Alex | InkyWorld</span>
        </div>
        
        <nav class="py-4">
            <div class="px-4 mb-4">
                <div class="flex gap-2 text-xs font-bold text-slate-400">
                    <a href="background_tasks.html" class="text-blue-400 font-bold">RU</a>
                    <span class="text-slate-600">|</span>
                    <a href="../en/background_tasks.html" class="hover:text-white transition">EN</a>
                    <span class="text-slate-600">|</span>
                    <a href="../ua/background_tasks.html" class="hover:text-white transition">UA</a>
                </div>
            </div>

            <div class="nav-section">Fundamentals</div>
            <a href="index.html" class="nav-link">ğŸ“˜ Introduction</a>
            <a href="solid.html" class="nav-link">ğŸ“ SOLID Principles</a>
            <a href="project_structure.html" class="nav-link">ğŸ§­ Project Structure (DDD)</a>
            <a href="dependency.html" class="nav-link">ğŸ’‰ Dependency Injection</a>

            <div class="nav-section">Architecture Layers</div>
            <a href="domain.html" class="nav-link">ğŸ¯ Domain Layer</a>
            <a href="application.html" class="nav-link">âš™ï¸ Application Layer</a>
            <a href="infrastructure.html" class="nav-link">ğŸ”§ Infrastructure Layer</a>
            <a href="presentation.html" class="nav-link">ğŸŒ Presentation Layer</a>
            <a href="middleware.html" class="nav-link">ğŸ”Œ Middleware</a>

            <div class="nav-section">Tactical DDD</div>
            <a href="aggregates.html" class="nav-link">ğŸ“¦ Aggregates</a>
            <a href="invariants.html" class="nav-link">ğŸ›¡ï¸ Invariants</a>
            <a href="repository_uow.html" class="nav-link">ğŸ—„ï¸ Repository & UoW</a>
            <a href="specification.html" class="nav-link">ğŸ“‹ Specification</a>
            <a href="domain_events.html" class="nav-link">ğŸ“£ Domain Events</a>
            <a href="policies.html" class="nav-link">ğŸ“œ Policies</a>
            <a href="versioning.html" class="nav-link">ğŸ”„ Versioning</a>

            <div class="nav-section">Strategic DDD</div>
            <a href="bounded_context.html" class="nav-link">ğŸŒ Bounded Contexts</a>
            <a href="ubiquitous_language.html" class="nav-link">ğŸ—£ï¸ Ubiquitous Language</a>
            <a href="context_relationships.html" class="nav-link">ğŸ¤ Context Relationships</a>
            <a href="acl.html" class="nav-link">ğŸ›¡ï¸ Anti-Corruption Layer</a>
            <a href="subdomains.html" class="nav-link">ğŸ§¬ Subdomains</a>
            <a href="modular_monolith.html" class="nav-link">ğŸ—ï¸ Modular Monolith</a>
            <a href="strategic_integration.html" class="nav-link">ğŸŒ Strategic Integration</a>
            <a href="big_ball_of_mud.html" class="nav-link">ğŸ· Big Ball of Mud</a>
            <a href="boundaries_first.html" class="nav-link">ğŸ§  Boundaries First</a>

            <div class="nav-section">CQRS & Distributed Systems</div>
            <a href="cqrs_es.html" class="nav-link">âš¡ CQRS & ES</a>
            <a href="saga.html" class="nav-link">ğŸ”„ Saga Pattern</a>
            <a href="outbox.html" class="nav-link">ğŸ“® Outbox Pattern</a>
            <a href="background_tasks.html" class="nav-link active">â³ Background Tasks</a>
            <a href="observability.html" class="nav-link">ğŸ” Observability</a>

            <div class="nav-section">Reliability & Security</div>
            <a href="security.html" class="nav-link">ğŸ” Auth & Permissions</a>
            <a href="error_handling.html" class="nav-link">ğŸš« Error Handling</a>
            <a href="concurrency.html" class="nav-link">ğŸ›‘ Concurrency & Migrations</a>
            <a href="config_logging.html" class="nav-link">âš™ï¸ Config & Observability</a>

            <div class="nav-section">Quality & Practice</div>
            <a href="testing.html" class="nav-link">ğŸ§ª Testing</a>
            <a href="overengineering.html" class="nav-link">ğŸ›‘ Overengineering</a>
            <a href="deployment.html" class="nav-link">ğŸš€ Deployment & Protection</a>
            <a href="frameworks_django.html" class="nav-link">ğŸ Django & Others</a>
            <a href="projects.html" class="nav-link">ğŸš€ Mini Projects</a>
            <a href="antipatterns.html" class="nav-link">âš ï¸ Antipatterns</a>
            <a href="advanced_techniques.html" class="nav-link">ğŸš€ Advanced Tech</a>

            <div class="nav-section">About</div>
            <a href="afterword.html" class="nav-link">ğŸ‘‹ Afterword</a>
        </nav>

    </aside>

    <!-- CONTENT -->
    <main class="flex-1 md:ml-72 p-8 md:p-12 max-w-5xl mx-auto">
        <header class="mb-12 pb-8 border-b border-gray-200">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-4">Background Tasks</h1>
            <p class="text-xl text-gray-600">Celery, Workers and asynchronous tasks in Clean Architecture.</p>
        </header>

        <section class="mb-16">
            <div class="prose prose-slate max-w-none text-gray-700">

        <p>In Clean Architecture, the Domain should not know about Celery, Redis, or RabbitMQ. But how do you send emails or process videos?</p>

        <h2 class="text-2xl font-bold text-gray-800 mt-12 mb-6">1. Problem: Importing Celery into Use Case</h2>
        <div class="bg-red-50 p-4 rounded border border-red-200 mb-4">
             <code>from worker import celery_app</code> within Use Case â€” is a violation of the Dependency Rule. Your business code now depends on the task queue.
        </div>

        <h2 class="text-2xl font-bold text-gray-800 mt-12 mb-6">2. Solution: Task Dispatcher</h2>
        
        <p>1. <strong>Interface (Application Layer):</strong> Declare that we can send tasks.</p>
        <pre><code class="language-python"># application/interfaces/tasks.py
from typing import Protocol, Any, Dict

class ITaskDispatcher(Protocol):
    def dispatch(self, task_name: str, payload: Dict[str, Any]):
        ...
</code></pre>

        <p>2. <strong>Implementation (Infrastructure Layer):</strong> Celery lives here.</p>
        <pre><code class="language-python"># infrastructure/tasks/celery_adapter.py
from celery import Celery
from application.interfaces.tasks import ITaskDispatcher

celery_app = Celery("app", broker="redis://localhost")

class CeleryTaskDispatcher(ITaskDispatcher):
    def dispatch(self, task_name: str, payload: Dict[str, Any]):
        # Send the task by name (loose coupling)
        celery_app.send_task(task_name, kwargs=payload)
</code></pre>

        <p>3. <strong>Usage in Use Case:</strong></p>
        <pre><code class="language-python">class RegisterUserUseCase:
    def __init__(self, tasks: ITaskDispatcher):
        self.tasks = tasks

    def execute(self, dto):
        user = User.create(dto)
        self.repo.save(user)
        
        # We simply say "Send email", not knowing HOW
        self.tasks.dispatch(
            "send_welcome_email", 
            {"email": user.email, "name": user.name}
        )
</code></pre>

        <h2 class="text-2xl font-bold text-gray-800 mt-12 mb-6">3. Where does the worker live?</h2>
        <p>The worker can be a separate process in the same repository or even in a different project. The key is to clearly define boundaries and dependency flow:</p>
        <ul class="list-disc list-inside space-y-2 mb-6">
            <li><strong>Separate repository/service:</strong> ideal if the worker runs on different infrastructure or requires a different environment (for example, a large Kubernetes job). Maintain a common library of interfaces/DTOs so both projects know how to exchange tasks.</li>
            <li><strong>Same repository, separate package:</strong> convenient when you want to reuse business logic and configuration. Restore the Worker from the shared library, but keep Infrastructure dependencies (Celery, Redis) only in its package so the rest of the service remains clean.</li>
            <li><strong>Part of the same application:</strong> acceptable for small projects. The Worker starts from the same code and uses the same modules, but you need to make sure the running service doesn't import Celery into the Application. You can do this through a separate entrypoint that only configures and runs tasks.</li>
        </ul>
        <p>In any case, don't mix worker and HTTP handlers in one thread: tasks should be called through the dispatcher, and the worker should only read Application Interfaces. This keeps the Clean Architecture rules intact.</p>

        <h2 class="text-2xl font-bold text-gray-800 mt-12 mb-6">4. Transactional Outbox</h2>
        <p>What if the database transaction rolls back, but the task in Celery already goes out? The user will receive an email "You are registered", but they don't exist in the database.</p>
        <p>See the <a href="outbox.html" class="text-blue-600 underline">Outbox Pattern</a> chapter for a solution to this problem (saving the task to the same database in one transaction).</p>

        <h2 class="text-2xl font-bold text-gray-800 mt-12 mb-6">4. Retry Strategies (Retries and Backoff)</h2>
        <p>Tasks can fail due to temporary issues (SMTP, network). Use exponential backoff with jitter and a maximum number of attempts.</p>
<pre><code class="language-python"># Celery example
from celery import shared_task

@shared_task(bind=True, max_retries=5)
def send_email(self, to, subject, body):
    try:
        smtp.send(to, subject, body)
    except Exception as exc:
        # exponential backoff
        raise self.retry(exc=exc, countdown=min(60, 2 ** self.request.retries))
</code></pre>

        <h2 class="text-2xl font-bold text-gray-800 mt-12 mb-6">5. Dead-letter Queues (DLQ) and Observability</h2>
        <p>Tasks that fail permanently should go to the DLQ with the error reason and metadata. Monitor metrics: failure rate, retry latency, task duration.</p>

        <h2 class="text-2xl font-bold text-gray-800 mt-12 mb-6">6. Idempotency & Deduplication</h2>
        <p>Handlers should be idempotent. Use business keys for dedup (for example, event_id or external_id).</p>
<pre><code class="language-python"># Example of an idempotent task
def process_payment(event):
    if payment_exists(event.id):
        return
    # processing
    save_payment(event)
</code></pre>

        <h2 class="text-2xl font-bold text-gray-800 mt-12 mb-6">7. Task Timeouts & Resource Limits</h2>
        <p>Each task should have a timeout and an acceptable set of resources. For long-running processes, use orchestration through steps (chaining) or Saga.</p>

        <h2 class="text-2xl font-bold text-gray-800 mt-12 mb-6">8. Batching & Rate Limiting</h2>
        <p>For bulk operations (sending emails, webhooks), group records into batches and set rate limits to avoid being banned by an external provider.</p>

        <h2 class="text-2xl font-bold text-gray-800 mt-12 mb-6">9. Testing Background Tasks</h2>
        <ul class="list-disc list-inside space-y-2 mb-6">
            <li>Run the worker and broker locally (for example, redis) in docker-compose for integration tests.</li>
            <li>Cover handlers with unit tests (without broker): test business logic, mock adapters.</li>
            <li>Check retry logic and marks for processed event_ids.</li>
        </ul>

        <h3 class="font-bold text-lg mt-8 mb-4">Pitfalls & Lifehacks</h3>
        <ul class="list-disc list-inside space-y-2 mb-6">
            <li><strong>Don't execute long tasks inside the HTTP handler:</strong> return 202 and send the task to the background.</li>
            <li><strong>Idempotency Key:</strong> use keys not only in HTTP, but also inside tasks (event_id) to avoid double processing.</li>
            <li><strong>Dead-letter monitoring:</strong> automate alerts when DLQ grows.</li>
            <li><strong>Local development:</strong> use sync-adapter (in development mode) that executes tasks synchronously â€” this speeds up debugging.</li>
        </ul>

            </div>
        </section>
    <div class="mt-12 pt-8 border-t border-gray-200"><div class="flex flex-col md:flex-row justify-between items-center gap-4"><a href="concurrency.html" class="group border border-gray-300 rounded-lg p-4 w-full md:w-1/2 hover:border-blue-500 hover:shadow-md transition text-right"><span class="block text-xs text-gray-500 font-bold uppercase tracking-wide mb-1 flex justify-end">Previous</span><span class="block text-lg font-bold text-gray-800 group-hover:text-blue-600">&larr; Concurrency Ideas</span></a><a href="error_handling.html" class="group border border-gray-300 rounded-lg p-4 w-full md:w-1/2 hover:border-blue-500 hover:shadow-md transition text-left"><span class="block text-xs text-gray-500 font-bold uppercase tracking-wide mb-1">Next</span><span class="block text-lg font-bold text-gray-800 group-hover:text-blue-600">Error Handling &rarr;</span></a></div></div>

        <!-- NAVIGATION FOOTER -->
        <div class="mt-24 pt-10 border-t border-slate-200">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <a href="outbox.html" class="group border border-slate-300 rounded-xl p-4 w-full md:w-1/2 hover:border-blue-500 hover:shadow-md transition text-right bg-white">
                    <span class="block text-xs text-slate-400 font-bold uppercase tracking-wider mb-1 flex justify-end">Previous</span>
                    <span class="block text-lg font-bold text-slate-800 group-hover:text-blue-600 transition">&larr; ğŸ“® Outbox Pattern</span>
                </a>
                <a href="observability.html" class="group border border-slate-300 rounded-xl p-4 w-full md:w-1/2 hover:border-blue-500 hover:shadow-md transition text-left bg-white">
                    <span class="block text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Next</span>
                    <span class="block text-lg font-bold text-slate-800 group-hover:text-blue-600 transition">ğŸ” Observability &rarr;</span>
                </a>
            </div>
        </div>
    </main>
</body>
</html>