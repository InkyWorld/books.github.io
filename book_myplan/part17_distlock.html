<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>17.3 Distributed Locks ‚Äî ScaleTrade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="book-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üìà</div>
                    <span>ScaleTrade</span>
                </a>
            </div>
            <nav class="sidebar-nav">
    <div class="nav-section">
        <div class="nav-section-title">Intro</div>
        <a href="index.html" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
        <a href="setup.html" class="nav-link">üõ† Setup</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 0: Fundamentals</div>
        <a href="part0_internals.html" class="nav-link">0.1 Internals</a>
        <a href="part0_networking.html" class="nav-link">0.2 Networking</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 1: Postgres</div>
        <a href="part1_schema.html" class="nav-link">1.1 Schema</a>
        <a href="part1_indexes.html" class="nav-link">1.2 Indexes</a>
        <a href="part1_transactions.html" class="nav-link">1.3 Transactions</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 2: Litestar</div>
        <a href="part2_litestar.html" class="nav-link">2.1 Framework</a>
        <a href="part2_dishka.html" class="nav-link">2.2 DI (Dishka)</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 3: Brokers</div>
        <a href="part3_redis.html" class="nav-link">3.1 Redis</a>
        <a href="part3_faststream.html" class="nav-link">3.2 FastStream</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 4: Quality</div>
        <a href="part4_testing.html" class="nav-link">4.1 Pytest</a>
        <a href="part4_resiliency.html" class="nav-link">4.2 Resilience</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 5: Observability</div>
        <a href="part5_clickhouse.html" class="nav-link">5.1 Clickhouse</a>
        <a href="part5_logging.html" class="nav-link">5.2 Structured Logs</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 6: Django</div>
        <a href="part6_django.html" class="nav-link">6.1 ORM</a>
        <a href="part6_migrations.html" class="nav-link">6.2 Migrations</a>
        <a href="part6_quality.html" class="nav-link">6.3 Quality</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 7: Microservices</div>
        <a href="part7_grpc.html" class="nav-link">7.1 gRPC</a>
        <a href="part7_graphql.html" class="nav-link">7.2 GraphQL</a>
        <a href="part7_federation.html" class="nav-link">7.3 Federation</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 8: Async</div>
        <a href="part8_asyncio.html" class="nav-link">8.1 Asyncio</a>
        <a href="part8_celery.html" class="nav-link">8.2 Celery</a>
        <a href="part8_dramatiq.html" class="nav-link">8.3 Dramatiq</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 9: API</div>
        <a href="part9_restdesign.html" class="nav-link">9.1 REST Design</a>
        <a href="part9_idempotency.html" class="nav-link">9.2 Idempotency</a>
        <a href="part9_openapi.html" class="nav-link">9.3 OpenAPI</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 10: Culture</div>
        <a href="part10_git.html" class="nav-link">10.1 Git</a>
        <a href="part10_commits.html" class="nav-link">10.2 Commits</a>
        <a href="part10_codereview.html" class="nav-link">10.3 Post-Review</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 11: Security</div>
        <a href="part11_oauth.html" class="nav-link">11.1 OAuth2</a>
        <a href="part11_vault.html" class="nav-link">11.2 Vault</a>
        <a href="part11_owasp.html" class="nav-link">11.3 OWASP</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 12: Kubernetes</div>
        <a href="part12_kubernetes.html" class="nav-link">12.1 K8s Basics</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 13: High Load</div>
        <a href="part13_profiling.html" class="nav-link">13.1 Profiling</a>
        <a href="part13_caching.html" class="nav-link">13.2 Caching</a>
        <a href="part13_loadbalancing.html" class="nav-link">13.3 Load Balancing</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 14: ML Ops</div>
        <a href="part14_mlflow.html" class="nav-link">14.1 MLflow</a>
        <a href="part14_embeddings.html" class="nav-link">14.2 Embeddings</a>
        <a href="part14_llm.html" class="nav-link">14.3 LLM</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 15: Debugging</div>
        <a href="part15_debugging.html" class="nav-link">15.1 Debugging</a>
        <a href="part15_postmortem.html" class="nav-link">15.2 Postmortem</a>
        <a href="part15_chaos.html" class="nav-link">15.3 Chaos Eng</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 16: DB Advanced</div>
        <a href="part16_indexes.html" class="nav-link">16.1 Indexes Deep</a>
        <a href="part16_isolation.html" class="nav-link">16.2 Isolation</a>
        <a href="part16_sharding.html" class="nav-link">16.3 Sharding</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 17: System Design</div>
        <a href="part17_circuit.html" class="nav-link">17.1 Circuit Breaker</a>
        <a href="part17_ratelimit.html" class="nav-link">17.2 Rate Limit</a>
        <a href="part17_distlock.html" class="nav-link active">17.3 Dist Lock</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 18: Soft Skills</div>
        <a href="part18_estimation.html" class="nav-link">18.1 Estimation</a>
        <a href="part18_burnout.html" class="nav-link">18.2 Burnout</a>
        <a href="part18_interview.html" class="nav-link">18.3 Interview</a>
    </div>
</nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="breadcrumb">
                    <a href="index.html">ScaleTrade</a>
                    <span>/</span>
                    <span>–ß–∞—Å—Ç—å 17</span>
                    <span>/</span>
                    <span>17.3 Distributed Locks</span>
                </div>
            </header>

            <div class="page-content">
                <h1>–ú–æ–¥—É–ª—å 17.3: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</h1>
                <p class="lead">–ö–∞–∫ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ CRON-–∑–∞–¥–∞—á—É –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä –∏–∑ –¥–µ—Å—è—Ç–∏?</p>

                <h2>–ü—Ä–æ–±–ª–µ–º–∞</h2>
                <p>–£ –≤–∞—Å 5 —Ä–µ–ø–ª–∏–∫ —Å–µ—Ä–≤–∏—Å–∞ `Billing`. –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –æ–Ω–∏ –ø—Ä–æ—Å—ã–ø–∞—é—Ç—Å—è, —á—Ç–æ–±—ã —Å–ø–∏—Å–∞—Ç—å –∞–±–æ–Ω–µ–Ω—Ç—Å–∫—É—é –ø–ª–∞—Ç—É. –ï—Å–ª–∏ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Ö, –∫–ª–∏–µ–Ω—Ç –∑–∞–ø–ª–∞—Ç–∏—Ç 5 —Ä–∞–∑.</p>

                <h2>–†–µ—à–µ–Ω–∏—è</h2>

                <h3>1. Postgres Advisory Locks</h3>
                <p>–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±, –µ—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å Postgres.</p>
                <div class="code-block">
                    <pre><code>-- Try to acquire lock. Returns true/false instantly.
SELECT pg_try_advisory_lock(12345); 

-- Release
SELECT pg_advisory_unlock(12345);</code></pre>
                </div>
                <p>–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —Å–µ—Å—Å–∏–∏ (—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—é). –ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å —É–ø–∞–¥–µ—Ç, Postgres —Å–∞–º —Å–Ω–∏–º–µ—Ç –ª–æ–∫. –û—á–µ–Ω—å –Ω–∞–¥–µ–∂–Ω–æ.</p>

                <h3>2. Redis (Simple Lock)</h3>
                <div class="code-block">
                    <pre><code>SET resource_name my_random_value NX PX 30000</code></pre>
                </div>
                <ul>
                    <li><code>NX</code>: –ü–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç.</li>
                    <li><code>PX 30000</code>: Expire —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ (—á—Ç–æ–±—ã –ª–æ–∫ –Ω–µ –∑–∞–≤–∏—Å –Ω–∞–≤–µ—á–Ω–æ, –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å —É–ø–∞–¥–µ—Ç).</li>
                </ul>
                <div class="info-box danger">
                    <p>–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç–æ `SETNX` –∏ –ø–æ—Ç–æ–º `EXPIRE` –¥–≤—É–º—è –∫–æ–º–∞–Ω–¥–∞–º–∏! –≠—Ç–æ –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–æ.</p>
                </div>

                <h3>3. Redlock (Redis Distributed Lock)</h3>
                <p>–ê–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ Redis. –ü–∏—à–µ–º –ª–æ–∫ –Ω–∞ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ (N/2 + 1) –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥. –°—á–∏—Ç–∞–µ—Ç—Å—è —Å–ø–æ—Ä–Ω—ã–º (–ú–∞—Ä—Ç–∏–Ω –ö–ª–µ–ø–ø–º–∞–Ω –∫—Ä–∏—Ç–∏–∫–æ–≤–∞–ª –µ–≥–æ –∏–∑-–∑–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —á–∞—Å–æ–≤), –Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∑–∞–¥–∞—á –ø–æ–¥—Ö–æ–¥–∏—Ç.</p>

                <h2>ü™® –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏</h2>
                
                <h3>Zombie Processes –∏ Fencing Tokens</h3>
                <p>–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ:</p>
                <ol>
                    <li>–í–æ—Ä–∫–µ—Ä 1 –±–µ—Ä–µ—Ç –ª–æ–∫.</li>
                    <li>–í–æ—Ä–∫–µ—Ä 1 –∑–∞—Å—ã–ø–∞–µ—Ç (GC pause) –Ω–∞ 40 —Å–µ–∫—É–Ω–¥. –õ–æ–∫ –∏—Å—Ç–µ–∫–∞–µ—Ç (TTL 30c).</li>
                    <li>–í–æ—Ä–∫–µ—Ä 2 –±–µ—Ä–µ—Ç –ª–æ–∫.</li>
                    <li>–í–æ—Ä–∫–µ—Ä 1 –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è –∏ –¥—É–º–∞–µ—Ç, —á—Ç–æ –ª–æ–∫ —É –Ω–µ–≥–æ. –û–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–∏—Å–∞—Ç—å –≤ –±–∞–∑—É.</li>
                    <li>–í–æ—Ä–∫–µ—Ä 2 —Ç–æ–∂–µ –ø–∏—à–µ—Ç –≤ –±–∞–∑—É. <strong>Data Corruption!</strong></li>
                </ol>
                <p><strong>–†–µ—à–µ–Ω–∏–µ (Fencing Tokens):</strong> –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤–∑—è—Ç–∏–∏ –ª–æ–∫–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —á–∏—Å–ª–æ (epoch). –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å: "–ï—Å–ª–∏ epoch –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ, –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å".</p>
            </div>
        </main>
    </div>
</body>
</html>