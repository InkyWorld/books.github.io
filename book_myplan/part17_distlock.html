<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>17.3 Distributed Locks ‚Äî ScaleTrade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="book-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üìà</div>
                    <span>ScaleTrade</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">–í–≤–µ–¥–µ–Ω–∏–µ</div>
                    <a href="index.html" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 17: System Design</div>
                    <a href="part17_circuit.html" class="nav-link">17.1 Resilience</a>
                    <a href="part17_ratelimit.html" class="nav-link">17.2 Rate Limiting</a>
                    <a href="part17_distlock.html" class="nav-link active">17.3 Dist Locks</a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="breadcrumb">
                    <a href="index.html">ScaleTrade</a>
                    <span>/</span>
                    <span>–ß–∞—Å—Ç—å 17</span>
                    <span>/</span>
                    <span>17.3 Distributed Locks</span>
                </div>
            </header>

            <div class="page-content">
                <h1>–ú–æ–¥—É–ª—å 17.3: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</h1>
                <p class="lead">–ö–∞–∫ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ CRON-–∑–∞–¥–∞—á—É –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä –∏–∑ –¥–µ—Å—è—Ç–∏?</p>

                <h2>–ü—Ä–æ–±–ª–µ–º–∞</h2>
                <p>–£ –≤–∞—Å 5 —Ä–µ–ø–ª–∏–∫ —Å–µ—Ä–≤–∏—Å–∞ `Billing`. –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –æ–Ω–∏ –ø—Ä–æ—Å—ã–ø–∞—é—Ç—Å—è, —á—Ç–æ–±—ã —Å–ø–∏—Å–∞—Ç—å –∞–±–æ–Ω–µ–Ω—Ç—Å–∫—É—é –ø–ª–∞—Ç—É. –ï—Å–ª–∏ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Ö, –∫–ª–∏–µ–Ω—Ç –∑–∞–ø–ª–∞—Ç–∏—Ç 5 —Ä–∞–∑.</p>

                <h2>–†–µ—à–µ–Ω–∏—è</h2>

                <h3>1. Postgres Advisory Locks</h3>
                <p>–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±, –µ—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å Postgres.</p>
                <div class="code-block">
                    <pre><code>-- Try to acquire lock. Returns true/false instantly.
SELECT pg_try_advisory_lock(12345); 

-- Release
SELECT pg_advisory_unlock(12345);</code></pre>
                </div>
                <p>–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —Å–µ—Å—Å–∏–∏ (—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—é). –ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å —É–ø–∞–¥–µ—Ç, Postgres —Å–∞–º —Å–Ω–∏–º–µ—Ç –ª–æ–∫. –û—á–µ–Ω—å –Ω–∞–¥–µ–∂–Ω–æ.</p>

                <h3>2. Redis (Simple Lock)</h3>
                <div class="code-block">
                    <pre><code>SET resource_name my_random_value NX PX 30000</code></pre>
                </div>
                <ul>
                    <li><code>NX</code>: –ü–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç.</li>
                    <li><code>PX 30000</code>: Expire —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ (—á—Ç–æ–±—ã –ª–æ–∫ –Ω–µ –∑–∞–≤–∏—Å –Ω–∞–≤–µ—á–Ω–æ, –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å —É–ø–∞–¥–µ—Ç).</li>
                </ul>
                <div class="info-box danger">
                    <p>–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç–æ `SETNX` –∏ –ø–æ—Ç–æ–º `EXPIRE` –¥–≤—É–º—è –∫–æ–º–∞–Ω–¥–∞–º–∏! –≠—Ç–æ –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–æ.</p>
                </div>

                <h3>3. Redlock (Redis Distributed Lock)</h3>
                <p>–ê–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ Redis. –ü–∏—à–µ–º –ª–æ–∫ –Ω–∞ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ (N/2 + 1) –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥. –°—á–∏—Ç–∞–µ—Ç—Å—è —Å–ø–æ—Ä–Ω—ã–º (–ú–∞—Ä—Ç–∏–Ω –ö–ª–µ–ø–ø–º–∞–Ω –∫—Ä–∏—Ç–∏–∫–æ–≤–∞–ª –µ–≥–æ –∏–∑-–∑–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —á–∞—Å–æ–≤), –Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∑–∞–¥–∞—á –ø–æ–¥—Ö–æ–¥–∏—Ç.</p>

                <h2>ü™® –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏</h2>
                
                <h3>Zombie Processes –∏ Fencing Tokens</h3>
                <p>–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ:</p>
                <ol>
                    <li>–í–æ—Ä–∫–µ—Ä 1 –±–µ—Ä–µ—Ç –ª–æ–∫.</li>
                    <li>–í–æ—Ä–∫–µ—Ä 1 –∑–∞—Å—ã–ø–∞–µ—Ç (GC pause) –Ω–∞ 40 —Å–µ–∫—É–Ω–¥. –õ–æ–∫ –∏—Å—Ç–µ–∫–∞–µ—Ç (TTL 30c).</li>
                    <li>–í–æ—Ä–∫–µ—Ä 2 –±–µ—Ä–µ—Ç –ª–æ–∫.</li>
                    <li>–í–æ—Ä–∫–µ—Ä 1 –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è –∏ –¥—É–º–∞–µ—Ç, —á—Ç–æ –ª–æ–∫ —É –Ω–µ–≥–æ. –û–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–∏—Å–∞—Ç—å –≤ –±–∞–∑—É.</li>
                    <li>–í–æ—Ä–∫–µ—Ä 2 —Ç–æ–∂–µ –ø–∏—à–µ—Ç –≤ –±–∞–∑—É. <strong>Data Corruption!</strong></li>
                </ol>
                <p><strong>–†–µ—à–µ–Ω–∏–µ (Fencing Tokens):</strong> –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤–∑—è—Ç–∏–∏ –ª–æ–∫–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —á–∏—Å–ª–æ (epoch). –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å: "–ï—Å–ª–∏ epoch –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ, –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å".</p>
            </div>
        </main>
    </div>
</body>
</html>