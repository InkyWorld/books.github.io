–ß–∞—Å—Ç—å 11

12.2, 12.3, 12.4

–ß–∞—Å—Ç—å 18

–ß–∞—Å—Ç—å 9

–ß–∞—Å—Ç—å 10

–ß–∞—Å—Ç—å 17

–ß–∞—Å—Ç—å 19

–ß–∞—Å—Ç—å 20<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2.1 Litestar + DDD ‚Äî ScaleTrade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="book-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üìà</div>
                    <span>ScaleTrade</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">–í–≤–µ–¥–µ–Ω–∏–µ</div>
                    <a href="index.html" class="nav-link"><span class="nav-link-icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="setup.html" class="nav-link"><span class="nav-link-icon">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 1: PostgreSQL</div>
                    <a href="part1_schema.html" class="nav-link"><span class="nav-link-icon">üìä</span>1.1 –°—Ö–µ–º–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ</a>
                    <a href="part1_transactions.html" class="nav-link"><span class="nav-link-icon">üîÑ</span>1.2 –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</a>
                    <a href="part1_indexes.html" class="nav-link"><span class="nav-link-icon">üîç</span>1.3 –ò–Ω–¥–µ–∫—Å—ã</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</div>
                    <a href="part2_litestar.html" class="nav-link active"><span class="nav-link-icon">üöÄ</span>2.1 Litestar + DDD</a>
                    <a href="part2_dishka.html" class="nav-link"><span class="nav-link-icon">üíâ</span>2.2 DI —Å Dishka</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 3: –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ</div>
                    <a href="part3_faststream.html" class="nav-link"><span class="nav-link-icon">üì®</span>3.1 RabbitMQ + Faststream</a>
                    <a href="part3_redis.html" class="nav-link"><span class="nav-link-icon">‚ö°</span>3.2 Redis Patterns</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 4: –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å</div>
                    <a href="part4_testing.html" class="nav-link"><span class="nav-link-icon">üß™</span>4.1 Advanced Testing</a>
                    <a href="part4_resiliency.html" class="nav-link"><span class="nav-link-icon">üõ°Ô∏è</span>4.2 Resiliency</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 5: Observability</div>
                    <a href="part5_logging.html" class="nav-link"><span class="nav-link-icon">üìù</span>5.1 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</a>
                    <a href="part5_clickhouse.html" class="nav-link"><span class="nav-link-icon">üìà</span>5.2 ClickHouse</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 6: Production</div>
                    <a href="part6_migrations.html" class="nav-link"><span class="nav-link-icon">üîÄ</span>6.1 Zero-Downtime</a>
                    <a href="part6_quality.html" class="nav-link"><span class="nav-link-icon">‚úÖ</span>6.2 Code Quality</a>
                    <a href="part6_django.html" class="nav-link"><span class="nav-link-icon">üîó</span>6.3 Django Admin</a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="breadcrumb">
                    <a href="index.html">ScaleTrade</a>
                    <span>/</span>
                    <span>–ß–∞—Å—Ç—å 2</span>
                    <span>/</span>
                    <span>2.1 Litestar + DDD</span>
                </div>
            </header>

            <div class="page-content">
                <h1>–ú–æ–¥—É–ª—å 2.1: –ö–∞—Ä–∫–∞—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Litestar + DDD Lite)</h1>
                <p class="lead">
                    –°—Ç—Ä–æ–∏–º —á–∏—Å—Ç—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É: –¥–æ–º–µ–Ω –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞, 
                    –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —Ç—Ä–∏–≤–∏–∞–ª—å–Ω–æ.
                </p>

                <h2>–ü–æ—á–µ–º—É Litestar, –∞ –Ω–µ FastAPI?</h2>
                
                <table>
                    <thead>
                        <tr>
                            <th>–ê—Å–ø–µ–∫—Ç</th>
                            <th>FastAPI</th>
                            <th>Litestar</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>DI</td>
                            <td>–ü—Ä–æ—Å—Ç–æ–π <code>Depends()</code></td>
                            <td>–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π IoC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä</td>
                        </tr>
                        <tr>
                            <td>Validation</td>
                            <td>Pydantic</td>
                            <td>Pydantic, msgspec, attrs</td>
                        </tr>
                        <tr>
                            <td>OpenAPI</td>
                            <td>–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è</td>
                            <td>–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è + –±–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è</td>
                        </tr>
                        <tr>
                            <td>Middleware</td>
                            <td>Starlette</td>
                            <td>–°–≤–æ–π, –±–æ–ª–µ–µ –≥–∏–±–∫–∏–π</td>
                        </tr>
                        <tr>
                            <td>DTO</td>
                            <td>–ù–µ—Ç</td>
                            <td>–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ DTO</td>
                        </tr>
                        <tr>
                            <td>–ë–∞—Ç–∞—Ä–µ–π–∫–∏</td>
                            <td>–ú–∏–Ω–∏–º—É–º</td>
                            <td>Guards, Channels, Stores</td>
                        </tr>
                    </tbody>
                </table>

                <div class="info-box info">
                    <div class="info-box-title">üí° –í—ã–±–æ—Ä —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞</div>
                    <p>
                        FastAPI –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö API. Litestar ‚Äî –¥–ª—è enterprise-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, 
                        –≥–¥–µ –≤–∞–∂–Ω—ã DI, —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å.
                    </p>
                </div>

                <h2>Layered Architecture (DDD Lite)</h2>
                
                <p>–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–∑ 4 —Å–ª–æ—ë–≤ —Å —á—ë—Ç–∫–∏–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏:</p>

                <div class="card">
                    <h4>üéØ Domain (–î–æ–º–µ–Ω)</h4>
                    <p>–ß–∏—Å—Ç–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞. –ù–∏–∫–∞–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤, ORM, HTTP.</p>
                    <ul>
                        <li><strong>Entities</strong> ‚Äî –±–∏–∑–Ω–µ—Å-—Å—É—â–Ω–æ—Å—Ç–∏ (Order, Account)</li>
                        <li><strong>Value Objects</strong> ‚Äî –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (Money, OrderId)</li>
                        <li><strong>Domain Services</strong> ‚Äî –ª–æ–≥–∏–∫–∞, –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∞—è –æ–¥–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏</li>
                        <li><strong>Exceptions</strong> ‚Äî –¥–æ–º–µ–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è</li>
                    </ul>
                </div>

                <div class="card">
                    <h4>üîß Infrastructure (–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)</h4>
                    <p>–†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π: –ë–î, –∫–µ—à, –±—Ä–æ–∫–µ—Ä—ã, –≤–Ω–µ—à–Ω–∏–µ API.</p>
                    <ul>
                        <li><strong>Repositories</strong> ‚Äî SQLAlchemy —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏</li>
                        <li><strong>Messaging</strong> ‚Äî RabbitMQ publishers/subscribers</li>
                        <li><strong>Cache</strong> ‚Äî Redis –∫–ª–∏–µ–Ω—Ç—ã</li>
                    </ul>
                </div>

                <div class="card">
                    <h4>‚öôÔ∏è Application (–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)</h4>
                    <p>Use Cases ‚Äî –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.</p>
                    <ul>
                        <li><strong>Services</strong> ‚Äî –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –¥–æ–º–µ–Ω–∞ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã</li>
                        <li><strong>DTOs</strong> ‚Äî Data Transfer Objects</li>
                        <li><strong>Unit of Work</strong> ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏</li>
                    </ul>
                </div>

                <div class="card">
                    <h4>üåê Interface (–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å)</h4>
                    <p>–¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞: HTTP, CLI, —Å–æ–±—ã—Ç–∏—è.</p>
                    <ul>
                        <li><strong>Controllers</strong> ‚Äî Litestar handlers</li>
                        <li><strong>Schemas</strong> ‚Äî Pydantic –º–æ–¥–µ–ª–∏ –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤</li>
                        <li><strong>Middleware</strong> ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</li>
                    </ul>
                </div>

                <h2>Domain Layer: —á–∏—Å—Ç—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏</h2>

<pre><code><span class="comment"># src/scaletrade/domain/entities/order.py</span>
<span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime
<span class="keyword">from</span> enum <span class="keyword">import</span> StrEnum
<span class="keyword">from</span> typing <span class="keyword">import</span> Self

<span class="keyword">from</span> scaletrade.domain.value_objects.money <span class="keyword">import</span> Money
<span class="keyword">from</span> scaletrade.domain.value_objects.identifiers <span class="keyword">import</span> OrderId, UserId
<span class="keyword">from</span> scaletrade.domain.exceptions.order <span class="keyword">import</span> (
    OrderAlreadyFilledError,
    OrderAlreadyCancelledError,
)


<span class="keyword">class</span> <span class="class-name">OrderSide</span>(StrEnum):
    BUY = <span class="string">"BUY"</span>
    SELL = <span class="string">"SELL"</span>


<span class="keyword">class</span> <span class="class-name">OrderStatus</span>(StrEnum):
    PENDING = <span class="string">"pending"</span>
    FILLED = <span class="string">"filled"</span>
    CANCELLED = <span class="string">"cancelled"</span>
    REJECTED = <span class="string">"rejected"</span>


<span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class-name">Order</span>:
    <span class="string">"""
    –î–æ–º–µ–Ω–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å Order.
    
    –°–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∏ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã.
    –ù–ï –∑–Ω–∞–µ—Ç –æ –ë–î, HTTP, —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏.
    """</span>
    id: OrderId
    user_id: UserId
    symbol: <span class="type">str</span>
    side: OrderSide
    quantity: Money
    price: Money
    status: OrderStatus = field(default=OrderStatus.PENDING)
    created_at: datetime = field(default_factory=datetime.utcnow)
    filled_at: datetime | <span class="keyword">None</span> = field(default=<span class="keyword">None</span>)
    
    <span class="comment"># === –ë–∏–∑–Ω–µ—Å-–º–µ—Ç–æ–¥—ã ===</span>
    
    <span class="keyword">def</span> <span class="function">fill</span>(self) -> <span class="keyword">None</span>:
        <span class="string">"""–ò—Å–ø–æ–ª–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä."""</span>
        <span class="keyword">if</span> self.status == OrderStatus.FILLED:
            <span class="keyword">raise</span> OrderAlreadyFilledError(self.id)
        <span class="keyword">if</span> self.status == OrderStatus.CANCELLED:
            <span class="keyword">raise</span> OrderAlreadyCancelledError(self.id)
        
        self.status = OrderStatus.FILLED
        self.filled_at = datetime.utcnow()
    
    <span class="keyword">def</span> <span class="function">cancel</span>(self) -> <span class="keyword">None</span>:
        <span class="string">"""–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä."""</span>
        <span class="keyword">if</span> self.status == OrderStatus.FILLED:
            <span class="keyword">raise</span> OrderAlreadyFilledError(self.id)
        <span class="keyword">if</span> self.status == OrderStatus.CANCELLED:
            <span class="keyword">raise</span> OrderAlreadyCancelledError(self.id)
        
        self.status = OrderStatus.CANCELLED
    
    <span class="decorator">@property</span>
    <span class="keyword">def</span> <span class="function">total_value</span>(self) -> Money:
        <span class="string">"""–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ—Ä–¥–µ—Ä–∞."""</span>
        <span class="keyword">return</span> self.quantity * self.price.amount
    
    <span class="decorator">@property</span>
    <span class="keyword">def</span> <span class="function">is_active</span>(self) -> <span class="type">bool</span>:
        <span class="keyword">return</span> self.status == OrderStatus.PENDING
    
    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">create</span>(
        cls,
        user_id: UserId,
        symbol: <span class="type">str</span>,
        side: OrderSide,
        quantity: Money,
        price: Money,
    ) -> Self:
        <span class="string">"""–§–∞–±—Ä–∏—á–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ—Ä–¥–µ—Ä–∞."""</span>
        <span class="keyword">return</span> cls(
            id=OrderId.generate(),
            user_id=user_id,
            symbol=symbol.upper(),
            side=side,
            quantity=quantity,
            price=price,
        )</code></pre>

                <h2>Infrastructure: Repository Pattern</h2>

<pre><code><span class="comment"># src/scaletrade/infrastructure/database/repositories/order.py</span>
<span class="keyword">from</span> typing <span class="keyword">import</span> Protocol
<span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> select
<span class="keyword">from</span> sqlalchemy.ext.asyncio <span class="keyword">import</span> AsyncSession

<span class="keyword">from</span> scaletrade.domain.entities.order <span class="keyword">import</span> Order
<span class="keyword">from</span> scaletrade.domain.value_objects.identifiers <span class="keyword">import</span> OrderId, UserId
<span class="keyword">from</span> scaletrade.infrastructure.database.models <span class="keyword">import</span> OrderModel


<span class="comment"># –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è (–≤ domain –∏–ª–∏ application)</span>
<span class="keyword">class</span> <span class="class-name">OrderRepositoryProtocol</span>(Protocol):
    <span class="keyword">async def</span> <span class="function">get_by_id</span>(self, order_id: OrderId) -> Order | <span class="keyword">None</span>: ...
    <span class="keyword">async def</span> <span class="function">get_active_by_user</span>(self, user_id: UserId) -> <span class="type">list</span>[Order]: ...
    <span class="keyword">async def</span> <span class="function">save</span>(self, order: Order) -> <span class="keyword">None</span>: ...


<span class="comment"># –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (–≤ infrastructure)</span>
<span class="keyword">class</span> <span class="class-name">SQLAlchemyOrderRepository</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(self, session: AsyncSession) -> <span class="keyword">None</span>:
        self._session = session
    
    <span class="keyword">async def</span> <span class="function">get_by_id</span>(self, order_id: OrderId) -> Order | <span class="keyword">None</span>:
        stmt = select(OrderModel).where(OrderModel.public_id == <span class="type">str</span>(order_id))
        result = <span class="keyword">await</span> self._session.execute(stmt)
        model = result.scalar_one_or_none()
        
        <span class="keyword">if</span> model <span class="keyword">is None</span>:
            <span class="keyword">return</span> <span class="keyword">None</span>
        
        <span class="keyword">return</span> self._to_domain(model)
    
    <span class="keyword">async def</span> <span class="function">get_active_by_user</span>(self, user_id: UserId) -> <span class="type">list</span>[Order]:
        stmt = (
            select(OrderModel)
            .where(
                OrderModel.user_id == user_id.value,
                OrderModel.status == <span class="string">"pending"</span>
            )
            .order_by(OrderModel.created_at.desc())
        )
        result = <span class="keyword">await</span> self._session.execute(stmt)
        <span class="keyword">return</span> [self._to_domain(m) <span class="keyword">for</span> m <span class="keyword">in</span> result.scalars()]
    
    <span class="keyword">async def</span> <span class="function">save</span>(self, order: Order) -> <span class="keyword">None</span>:
        model = self._to_model(order)
        self._session.add(model)
        <span class="comment"># flush –±–µ–∑ commit ‚Äî commit –¥–µ–ª–∞–µ—Ç UoW</span>
        <span class="keyword">await</span> self._session.flush()
    
    <span class="keyword">def</span> <span class="function">_to_domain</span>(self, model: OrderModel) -> Order:
        <span class="string">"""–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –ë–î –≤ –¥–æ–º–µ–Ω–Ω—É—é —Å—É—â–Ω–æ—Å—Ç—å."""</span>
        <span class="keyword">return</span> Order(
            id=OrderId.from_string(<span class="type">str</span>(model.public_id)),
            user_id=UserId(model.user_id),
            symbol=model.symbol,
            side=OrderSide(model.side),
            quantity=Money(model.quantity, Currency.USD),
            price=Money(model.price, Currency.USD),
            status=OrderStatus(model.status),
            created_at=model.created_at,
            filled_at=model.filled_at,
        )
    
    <span class="keyword">def</span> <span class="function">_to_model</span>(self, order: Order) -> OrderModel:
        <span class="string">"""–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–æ–º–µ–Ω–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏ –≤ –º–æ–¥–µ–ª—å –ë–î."""</span>
        <span class="keyword">return</span> OrderModel(
            public_id=<span class="type">str</span>(order.id),
            user_id=order.user_id.value,
            symbol=order.symbol,
            side=order.side.value,
            quantity=order.quantity.amount,
            price=order.price.amount,
            status=order.status.value,
        )</code></pre>

                <h2>Application: Service Layer</h2>

<pre><code><span class="comment"># src/scaletrade/application/services/order_service.py</span>
<span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass

<span class="keyword">from</span> scaletrade.domain.entities.order <span class="keyword">import</span> Order, OrderSide
<span class="keyword">from</span> scaletrade.domain.value_objects <span class="keyword">import</span> Money, UserId, OrderId
<span class="keyword">from</span> scaletrade.application.dto.order <span class="keyword">import</span> CreateOrderDTO, OrderDTO
<span class="keyword">from</span> scaletrade.application.uow <span class="keyword">import</span> UnitOfWork


<span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class-name">OrderService</span>:
    <span class="string">"""
    Application Service ‚Äî –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –¥–æ–º–µ–Ω–∞ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
    
    –ù–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏, —Ç–æ–ª—å–∫–æ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—é.
    """</span>
    uow: UnitOfWork
    
    <span class="keyword">async def</span> <span class="function">create_order</span>(self, dto: CreateOrderDTO) -> OrderDTO:
        <span class="string">"""–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ—Ä–¥–µ—Ä–∞."""</span>
        <span class="keyword">async with</span> self.uow:
            <span class="comment"># –°–æ–∑–¥–∞—ë–º –¥–æ–º–µ–Ω–Ω—É—é —Å—É—â–Ω–æ—Å—Ç—å</span>
            order = Order.create(
                user_id=UserId(dto.user_id),
                symbol=dto.symbol,
                side=OrderSide(dto.side),
                quantity=Money.from_string(dto.quantity),
                price=Money.from_string(dto.price),
            )
            
            <span class="comment"># –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å</span>
            account = <span class="keyword">await</span> self.uow.accounts.get_by_user_id(order.user_id)
            <span class="keyword">if</span> order.side == OrderSide.BUY:
                account.reserve(order.total_value)
            
            <span class="comment"># –°–æ—Ö—Ä–∞–Ω—è–µ–º</span>
            <span class="keyword">await</span> self.uow.orders.save(order)
            <span class="keyword">await</span> self.uow.commit()
            
            <span class="keyword">return</span> OrderDTO.from_domain(order)
    
    <span class="keyword">async def</span> <span class="function">cancel_order</span>(self, order_id: <span class="type">str</span>, user_id: <span class="type">int</span>) -> OrderDTO:
        <span class="string">"""–û—Ç–º–µ–Ω–∞ –æ—Ä–¥–µ—Ä–∞."""</span>
        <span class="keyword">async with</span> self.uow:
            order = <span class="keyword">await</span> self.uow.orders.get_by_id(OrderId.from_string(order_id))
            
            <span class="keyword">if</span> order <span class="keyword">is None</span>:
                <span class="keyword">raise</span> OrderNotFoundError(order_id)
            
            <span class="keyword">if</span> order.user_id.value != user_id:
                <span class="keyword">raise</span> PermissionDeniedError()
            
            <span class="comment"># –î–æ–º–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞</span>
            order.cancel()
            
            <span class="comment"># –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞</span>
            <span class="keyword">if</span> order.side == OrderSide.BUY:
                account = <span class="keyword">await</span> self.uow.accounts.get_by_user_id(order.user_id)
                account.release_reserve(order.total_value)
            
            <span class="keyword">await</span> self.uow.commit()
            <span class="keyword">return</span> OrderDTO.from_domain(order)</code></pre>

                <h2>Interface: Litestar Controller</h2>

<pre><code><span class="comment"># src/scaletrade/interface/http/orders.py</span>
<span class="keyword">from</span> litestar <span class="keyword">import</span> Controller, get, post, delete
<span class="keyword">from</span> litestar.di <span class="keyword">import</span> Provide
<span class="keyword">from</span> litestar.params <span class="keyword">import</span> Parameter

<span class="keyword">from</span> scaletrade.application.services.order_service <span class="keyword">import</span> OrderService
<span class="keyword">from</span> scaletrade.interface.schemas.order <span class="keyword">import</span> (
    CreateOrderRequest,
    OrderResponse,
    OrderListResponse,
)


<span class="keyword">class</span> <span class="class-name">OrderController</span>(Controller):
    <span class="string">"""HTTP –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—Ä–¥–µ—Ä–∞–º–∏."""</span>
    
    path = <span class="string">"/orders"</span>
    tags = [<span class="string">"Orders"</span>]
    
    <span class="decorator">@post</span>()
    <span class="keyword">async def</span> <span class="function">create_order</span>(
        self,
        data: CreateOrderRequest,
        order_service: OrderService,
    ) -> OrderResponse:
        <span class="string">"""–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –æ—Ä–¥–µ—Ä."""</span>
        dto = <span class="keyword">await</span> order_service.create_order(data.to_dto())
        <span class="keyword">return</span> OrderResponse.from_dto(dto)
    
    <span class="decorator">@get</span>(<span class="string">"/{order_id:str}"</span>)
    <span class="keyword">async def</span> <span class="function">get_order</span>(
        self,
        order_id: <span class="type">str</span>,
        order_service: OrderService,
    ) -> OrderResponse:
        <span class="string">"""–ü–æ–ª—É—á–∏—Ç—å –æ—Ä–¥–µ—Ä –ø–æ ID."""</span>
        dto = <span class="keyword">await</span> order_service.get_order(order_id)
        <span class="keyword">return</span> OrderResponse.from_dto(dto)
    
    <span class="decorator">@get</span>()
    <span class="keyword">async def</span> <span class="function">list_orders</span>(
        self,
        order_service: OrderService,
        status: <span class="type">str</span> | <span class="keyword">None</span> = Parameter(default=<span class="keyword">None</span>),
        limit: <span class="type">int</span> = Parameter(default=<span class="number">20</span>, ge=<span class="number">1</span>, le=<span class="number">100</span>),
    ) -> OrderListResponse:
        <span class="string">"""–°–ø–∏—Å–æ–∫ –æ—Ä–¥–µ—Ä–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""</span>
        dtos = <span class="keyword">await</span> order_service.list_orders(status=status, limit=limit)
        <span class="keyword">return</span> OrderListResponse(
            items=[OrderResponse.from_dto(dto) <span class="keyword">for</span> dto <span class="keyword">in</span> dtos],
            total=len(dtos),
        )
    
    <span class="decorator">@delete</span>(<span class="string">"/{order_id:str}"</span>)
    <span class="keyword">async def</span> <span class="function">cancel_order</span>(
        self,
        order_id: <span class="type">str</span>,
        order_service: OrderService,
    ) -> OrderResponse:
        <span class="string">"""–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä."""</span>
        dto = <span class="keyword">await</span> order_service.cancel_order(order_id)
        <span class="keyword">return</span> OrderResponse.from_dto(dto)</code></pre>

                <h2>Pydantic V2: Request/Response Schemas</h2>

<pre><code><span class="comment"># src/scaletrade/interface/schemas/order.py</span>
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime
<span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal
<span class="keyword">from</span> typing <span class="keyword">import</span> Self

<span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field, computed_field, field_validator


<span class="keyword">class</span> <span class="class-name">CreateOrderRequest</span>(BaseModel):
    <span class="string">"""–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞."""</span>
    
    symbol: <span class="type">str</span> = Field(..., min_length=<span class="number">1</span>, max_length=<span class="number">20</span>, examples=[<span class="string">"BTC/USD"</span>])
    side: <span class="type">str</span> = Field(..., pattern=<span class="string">"^(BUY|SELL)$"</span>)
    quantity: Decimal = Field(..., gt=<span class="number">0</span>, decimal_places=<span class="number">8</span>)
    price: Decimal = Field(..., gt=<span class="number">0</span>, decimal_places=<span class="number">4</span>)
    
    <span class="decorator">@field_validator</span>(<span class="string">"symbol"</span>)
    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">normalize_symbol</span>(cls, v: <span class="type">str</span>) -> <span class="type">str</span>:
        <span class="keyword">return</span> v.upper().strip()
    
    <span class="keyword">def</span> <span class="function">to_dto</span>(self) -> CreateOrderDTO:
        <span class="keyword">return</span> CreateOrderDTO(
            symbol=self.symbol,
            side=self.side,
            quantity=<span class="type">str</span>(self.quantity),
            price=<span class="type">str</span>(self.price),
        )


<span class="keyword">class</span> <span class="class-name">OrderResponse</span>(BaseModel):
    <span class="string">"""–û—Ç–≤–µ—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –æ—Ä–¥–µ—Ä–∞."""</span>
    
    id: <span class="type">str</span>
    symbol: <span class="type">str</span>
    side: <span class="type">str</span>
    quantity: Decimal
    price: Decimal
    status: <span class="type">str</span>
    created_at: datetime
    filled_at: datetime | <span class="keyword">None</span> = <span class="keyword">None</span>
    
    <span class="decorator">@computed_field</span>
    <span class="decorator">@property</span>
    <span class="keyword">def</span> <span class="function">total_value</span>(self) -> Decimal:
        <span class="string">"""–í—ã—á–∏—Å–ª—è–µ–º–æ–µ –ø–æ–ª–µ: –æ–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å."""</span>
        <span class="keyword">return</span> self.quantity * self.price
    
    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">from_dto</span>(cls, dto: OrderDTO) -> Self:
        <span class="keyword">return</span> cls(
            id=dto.id,
            symbol=dto.symbol,
            side=dto.side,
            quantity=Decimal(dto.quantity),
            price=Decimal(dto.price),
            status=dto.status,
            created_at=dto.created_at,
            filled_at=dto.filled_at,
        )


<span class="keyword">class</span> <span class="class-name">OrderListResponse</span>(BaseModel):
    <span class="string">"""–°–ø–∏—Å–æ–∫ –æ—Ä–¥–µ—Ä–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""</span>
    
    items: <span class="type">list</span>[OrderResponse]
    total: <span class="type">int</span></code></pre>

                <h2>–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: main.py</h2>

<pre><code><span class="comment"># src/scaletrade/main.py</span>
<span class="keyword">from</span> litestar <span class="keyword">import</span> Litestar
<span class="keyword">from</span> litestar.openapi <span class="keyword">import</span> OpenAPIConfig

<span class="keyword">from</span> scaletrade.interface.http.orders <span class="keyword">import</span> OrderController
<span class="keyword">from</span> scaletrade.interface.http.accounts <span class="keyword">import</span> AccountController
<span class="keyword">from</span> scaletrade.di.providers <span class="keyword">import</span> create_dishka_container
<span class="keyword">from</span> scaletrade.config <span class="keyword">import</span> get_settings


<span class="keyword">def</span> <span class="function">create_app</span>() -> Litestar:
    settings = get_settings()
    container = create_dishka_container(settings)
    
    <span class="keyword">return</span> Litestar(
        route_handlers=[
            OrderController,
            AccountController,
        ],
        openapi_config=OpenAPIConfig(
            title=<span class="string">"ScaleTrade API"</span>,
            version=<span class="string">"1.0.0"</span>,
            description=<span class="string">"Order Execution & Analytics System"</span>,
        ),
        debug=settings.debug,
        <span class="comment"># DI —á–µ—Ä–µ–∑ Dishka ‚Äî —Å–º. —Å–ª–µ–¥—É—é—â–∏–π –º–æ–¥—É–ª—å</span>
    )


app = create_app()</code></pre>

                <h2>ü™® –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏</h2>
                <div class="accordion">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>1. ORM –ú–æ–¥–µ–ª–∏ –≤ API</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ SQLAlchemy –º–æ–¥–µ–ª—å –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –Ω–∞–ø—Ä—è–º—É—é. –≠—Ç–æ (1) –ø—Ä–æ–≤–æ—Ü–∏—Ä—É–µ—Ç N+1 –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –µ—Å–ª–∏ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã —Å–≤—è–∑–∏, –∏ (2) –º–æ–∂–µ—Ç "—Å–ª–∏—Ç—å" –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –ø–æ–ª—è (–ø–∞—Ä–æ–ª–∏, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ ID). –í—Å–µ–≥–¥–∞ –º–∞–ø–ø—å—Ç–µ –≤ Pydantic/Msgspec DTO.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>2. –¢–æ–ª—Å—Ç—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–æ–ª–∂–µ–Ω —Ç–æ–ª—å–∫–æ: –ø—Ä–∏–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å, –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å, –≤—ã–∑–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å, –≤–µ—Ä–Ω—É—Ç—å –æ—Ç–≤–µ—Ç. –õ–æ–≥–∏–∫–∞ "–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏ —Å–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ Service Layer, –∞ –Ω–µ –≤ —Ö–µ–Ω–¥–ª–µ—Ä–µ.</p>
                        </div>
                    </div>
                </div>

                <h2>üí° –õ–∞–π—Ñ—Ö–∞–∫–∏</h2>
                <ul>
                    <li><strong>Polyfactory:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É <code>polyfactory</code> (–±—ã–≤—à–∞—è <code>pydantic-factories</code>), —á—Ç–æ–±—ã –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∞—à–∏—Ö DTO. –û–Ω–∞ –ø–æ–Ω–∏–º–∞–µ—Ç —Ç–∏–ø—ã Pydantic –∏ —Å–æ–∑–¥–∞–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–µ —Å–ª—É—á–∞–π–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.</li>
                    <li><strong>msgspec:</strong> Litestar "–∏–∑ –∫–æ—Ä–æ–±–∫–∏" –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç <code>msgspec</code>. –≠—Ç–æ –≤ —Ä–∞–∑—ã –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º stdlib json –∏ –¥–∞–∂–µ orjson (–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä).</li>
                    <li><strong>Vertical Sciles:</strong> –í–º–µ—Å—Ç–æ –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –ø–∞–ø–∫–∏ <code>controllers/</code>, <code>services/</code>, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–µ–ª–∏—Ç—å –ø–æ —Ñ–∏—á–∞–º: <code>features/orders/</code>, <code>features/auth/</code>. –≠—Ç–æ —É–ª—É—á—à–∞–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏—é –≤ –±–æ–ª—å—à–æ–º –ø—Ä–æ–µ–∫—Ç–µ.</li>
                </ul>

                <div class="task-box">
                    <h4>üìã –ó–∞–¥–∞–Ω–∏–µ</h4>
                    <ul class="task-list">
                        <li>–°–æ–∑–¥–∞–π –¥–æ–º–µ–Ω–Ω—É—é —Å—É—â–Ω–æ—Å—Ç—å <code>Account</code> —Å –º–µ—Ç–æ–¥–∞–º–∏ deposit/withdraw</li>
                        <li>–†–µ–∞–ª–∏–∑—É–π <code>AccountRepository</code> —Å –º–∞–ø–ø–∏–Ω–≥–æ–º domain ‚Üî model</li>
                        <li>–°–æ–∑–¥–∞–π <code>AccountService</code> –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è/—Å–ø–∏—Å–∞–Ω–∏—è</li>
                        <li>–ù–∞–ø–∏—à–∏ Pydantic —Å—Ö–µ–º—ã —Å –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞–º–∏ –∏ computed_field</li>
                        <li>–°–æ–±–µ—Ä–∏ Litestar –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –¥–≤—É–º—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º–∏</li>
                    </ul>
                </div>

                <div class="nav-footer">
                    <a href="part1_indexes.html">
                        <div>
                            <div class="nav-label">–ù–∞–∑–∞–¥</div>
                            <div class="nav-title">‚Üê 1.3 –ò–Ω–¥–µ–∫—Å—ã</div>
                        </div>
                    </a>
                    <a href="part2_dishka.html">
                        <div>
                            <div class="nav-label">–î–∞–ª–µ–µ</div>
                            <div class="nav-title">2.2 DI —Å Dishka ‚Üí</div>
                        </div>
                    </a>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
