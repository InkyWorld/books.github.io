<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8.1 Asyncio Advanced ‚Äî ScaleTrade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="book-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üìà</div>
                    <span>ScaleTrade</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">–í–≤–µ–¥–µ–Ω–∏–µ</div>
                    <a href="index.html" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 8: Async</div>
                    <a href="part8_asyncio.html" class="nav-link active">8.1 Asyncio Advanced</a>
                    <a href="part8_celery.html" class="nav-link">8.2 Celery</a>
                    <a href="part8_dramatiq.html" class="nav-link">8.3 Dramatiq</a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="breadcrumb">
                    <a href="index.html">ScaleTrade</a>
                    <span>/</span>
                    <span>–ß–∞—Å—Ç—å 8</span>
                    <span>/</span>
                    <span>8.1 Asyncio</span>
                </div>
            </header>

            <div class="page-content">
                <h1>–ú–æ–¥—É–ª—å 8.1: Asyncio Advanced</h1>
                <p class="lead">Asyncio –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ await. –≠—Ç–æ –≥—Ä–∞—Ü–∏–æ–∑–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ, –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ —Ñ–æ–Ω–µ.</p>

                <h2>Structured Concurrency (TaskGroup)</h2>
                <p>–í Python 3.11+ –ø–æ—è–≤–∏–ª—Å—è `TaskGroup`. –≠—Ç–æ –∫–∞–∫ `try...except` –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á. –ï—Å–ª–∏ –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –ø–∞–¥–∞–µ—Ç, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è.</p>

<pre><code class="language-python">async def main():
    try:
        async with asyncio.TaskGroup() as tg:
            tg.create_task(task1())
            tg.create_task(db_query())
    except ExceptionGroup as e:
         # –í—Å–µ –æ—à–∏–±–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∑–¥–µ—Å—å
        print(f"Caught errors: {e}")
</code></pre>

                <h2>–ö–æ–Ω—Ç—Ä–æ–ª—å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞ (Semaphore)</h2>
                <p>–ï—Å–ª–∏ –≤—ã –∑–∞–ø—É—Å—Ç–∏—Ç–µ `await asyncio.gather(*[fetch(url) for url in urls])`, –≥–¥–µ 1000 url'–æ–≤, –≤—ã –ø–æ–ª–æ–∂–∏—Ç–µ –∏–ª–∏ —Å–µ—Ç—å, –∏–ª–∏ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å.</p>

<pre><code class="language-python">sem = asyncio.Semaphore(10) # –ú–∞–∫—Å–∏–º—É–º 10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á

async def safe_fetch(url):
    async with sem:
        return await client.get(url)

await asyncio.gather(*[safe_fetch(u) for u in urls])
</code></pre>

                <h2>Blocking Code in Asyncio</h2>
                <p>–ò–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ —É–º–µ–µ—Ç async (–Ω–∞–ø—Ä–∏–º–µ—Ä, requests, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π open(), cpu-bound –∑–∞–¥–∞—á–∞). –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å Event Loop –Ω–µ–ª—å–∑—è!</p>

<pre><code class="language-python"># –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –≤—ã–Ω–æ—Å–∏–º –≤ thread pool
result = await asyncio.to_thread(sync_function, arg1)
</code></pre>

                <h2>Graceful Shutdown</h2>
                <p>–ö–æ–≥–¥–∞ Kubernetes —É–±–∏–≤–∞–µ—Ç –ø–æ–¥, –æ–Ω —à–ª–µ—Ç SIGTERM. –£ –≤–∞—Å –µ—Å—Ç—å 30 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã.</p>
                <ol>
                    <li>–ü–æ–π–º–∞—Ç—å SIGTERM.</li>
                    <li>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–µ–º –Ω–æ–≤—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π.</li>
                    <li>–û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ `BackgroundTasks`.</li>
                    <li>–î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.</li>
                    <li>–ó–∞–∫—Ä—ã—Ç—å –∫–æ–Ω–Ω–µ–∫—Ç—ã –∫ –ë–î.</li>
                    <li>–í—ã–π—Ç–∏.</li>
                </ol>

            <span class="keyword">await</span> asyncio.sleep(self._buffer.flush_interval)</code></pre>

                <h2>ü™® –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏</h2>
                <div class="accordion">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>1. Garbage Collection —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ï—Å–ª–∏ –≤—ã –¥–µ–ª–∞–µ—Ç–µ <code>asyncio.create_task(db_op())</code> –∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, Garbage Collector –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è!). Python 3.14+ –æ–±–µ—â–∞–µ—Ç —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å, –Ω–æ –ø–æ–∫–∞ –≤—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å—Å—ã–ª–∫–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π <code>set</code>.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ Event Loop</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–û–¥–∏–Ω –≤—ã–∑–æ–≤ <code>requests.get()</code> –∏–ª–∏ <code>time.sleep(1)</code> –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –í–ï–°–¨ —Å–µ—Ä–≤–µ—Ä. –ù–∏–∫—Ç–æ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è, –Ω–∏–∫—Ç–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>asyncio.to_thread</code> –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –ª–µ–≥–∞—Å–∏ –∫–æ–¥–∞.</p>
                        </div>
                    </div>
                </div>

                <h2>üí° –õ–∞–π—Ñ—Ö–∞–∫–∏</h2>
                <ul>
                    <li><strong>asyncio.shield():</strong> –ó–∞—â–∏—â–∞–µ—Ç –∑–∞–¥–∞—á—É –æ—Ç –æ—Ç–º–µ–Ω—ã. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª –±—Ä–∞—É–∑–µ—Ä –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞, Litestar –ø–æ—à–ª–µ—Ç CancelledError. –û–±–µ—Ä–Ω–∏—Ç–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é —Å–µ–∫—Ü–∏—é –≤ <code>shield</code>, —á—Ç–æ–±—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–æ—à–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞.</li>
                    <li><strong>uvloop:</strong> Drop-in –∑–∞–º–µ–Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Å–æ–±—ã—Ç–∏–π. –ü—Ä–æ—Å—Ç–æ <code>uvloop.install()</code> ‚Äî –∏ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ Node.js.</li>
                    <li><strong>TaskGroup (Python 3.11):</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–º–µ—Å—Ç–æ <code>gather</code>. –≠—Ç–æ Structured Concurrency: –µ—Å–ª–∏ –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –ø–∞–¥–∞–µ—Ç, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è, –∞ –æ—à–∏–±–∫–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è.</li>
                </ul>

                <div class="task-box">
                    <h4>üéØ –ü—Ä–∞–∫—Ç–∏–∫–∞</h4>
                    <ul class="task-list">
                        <li>–†–µ–∞–ª–∏–∑—É–π Graceful Shutdown –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞</li>
                        <li>–ù–∞–ø–∏—à–∏ worker pool –Ω–∞ asyncio.Queue</li>
                        <li>–ò—Å–ø–æ–ª—å–∑—É–π TaskGroup –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</li>
                        <li>–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π uvloop</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>
</body>
</html>