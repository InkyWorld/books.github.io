<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6.2 Code Quality ‚Äî ScaleTrade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="book-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üìà</div>
                    <span>ScaleTrade</span>
                </a>
            </div>
            <nav class="sidebar-nav">
    <div class="nav-section">
        <div class="nav-section-title">Intro</div>
        <a href="index.html" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
        <a href="setup.html" class="nav-link">üõ† Setup</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 0: Fundamentals</div>
        <a href="part0_internals.html" class="nav-link">0.1 Internals</a>
        <a href="part0_networking.html" class="nav-link">0.2 Networking</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 1: Postgres</div>
        <a href="part1_schema.html" class="nav-link">1.1 Schema</a>
        <a href="part1_indexes.html" class="nav-link">1.2 Indexes</a>
        <a href="part1_transactions.html" class="nav-link">1.3 Transactions</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 2: Litestar</div>
        <a href="part2_litestar.html" class="nav-link">2.1 Framework</a>
        <a href="part2_dishka.html" class="nav-link">2.2 DI (Dishka)</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 3: Brokers</div>
        <a href="part3_redis.html" class="nav-link">3.1 Redis</a>
        <a href="part3_faststream.html" class="nav-link">3.2 FastStream</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 4: Quality</div>
        <a href="part4_testing.html" class="nav-link">4.1 Pytest</a>
        <a href="part4_resiliency.html" class="nav-link">4.2 Resilience</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 5: Observability</div>
        <a href="part5_clickhouse.html" class="nav-link">5.1 Clickhouse</a>
        <a href="part5_logging.html" class="nav-link">5.2 Structured Logs</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 6: Django</div>
        <a href="part6_django.html" class="nav-link">6.1 ORM</a>
        <a href="part6_migrations.html" class="nav-link">6.2 Migrations</a>
        <a href="part6_quality.html" class="nav-link active">6.3 Quality</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 7: Microservices</div>
        <a href="part7_grpc.html" class="nav-link">7.1 gRPC</a>
        <a href="part7_graphql.html" class="nav-link">7.2 GraphQL</a>
        <a href="part7_federation.html" class="nav-link">7.3 Federation</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 8: Async</div>
        <a href="part8_asyncio.html" class="nav-link">8.1 Asyncio</a>
        <a href="part8_celery.html" class="nav-link">8.2 Celery</a>
        <a href="part8_dramatiq.html" class="nav-link">8.3 Dramatiq</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 9: API</div>
        <a href="part9_restdesign.html" class="nav-link">9.1 REST Design</a>
        <a href="part9_idempotency.html" class="nav-link">9.2 Idempotency</a>
        <a href="part9_openapi.html" class="nav-link">9.3 OpenAPI</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 10: Culture</div>
        <a href="part10_git.html" class="nav-link">10.1 Git</a>
        <a href="part10_commits.html" class="nav-link">10.2 Commits</a>
        <a href="part10_codereview.html" class="nav-link">10.3 Post-Review</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 11: Security</div>
        <a href="part11_oauth.html" class="nav-link">11.1 OAuth2</a>
        <a href="part11_vault.html" class="nav-link">11.2 Vault</a>
        <a href="part11_owasp.html" class="nav-link">11.3 OWASP</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 12: Kubernetes</div>
        <a href="part12_kubernetes.html" class="nav-link">12.1 K8s Basics</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 13: High Load</div>
        <a href="part13_profiling.html" class="nav-link">13.1 Profiling</a>
        <a href="part13_caching.html" class="nav-link">13.2 Caching</a>
        <a href="part13_loadbalancing.html" class="nav-link">13.3 Load Balancing</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 14: ML Ops</div>
        <a href="part14_mlflow.html" class="nav-link">14.1 MLflow</a>
        <a href="part14_embeddings.html" class="nav-link">14.2 Embeddings</a>
        <a href="part14_llm.html" class="nav-link">14.3 LLM</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 15: Debugging</div>
        <a href="part15_debugging.html" class="nav-link">15.1 Debugging</a>
        <a href="part15_postmortem.html" class="nav-link">15.2 Postmortem</a>
        <a href="part15_chaos.html" class="nav-link">15.3 Chaos Eng</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 16: DB Advanced</div>
        <a href="part16_indexes.html" class="nav-link">16.1 Indexes Deep</a>
        <a href="part16_isolation.html" class="nav-link">16.2 Isolation</a>
        <a href="part16_sharding.html" class="nav-link">16.3 Sharding</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 17: System Design</div>
        <a href="part17_circuit.html" class="nav-link">17.1 Circuit Breaker</a>
        <a href="part17_ratelimit.html" class="nav-link">17.2 Rate Limit</a>
        <a href="part17_distlock.html" class="nav-link">17.3 Dist Lock</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 18: Soft Skills</div>
        <a href="part18_estimation.html" class="nav-link">18.1 Estimation</a>
        <a href="part18_burnout.html" class="nav-link">18.2 Burnout</a>
        <a href="part18_interview.html" class="nav-link">18.3 Interview</a>
    </div>
</nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="breadcrumb">
                    <a href="index.html">ScaleTrade</a>
                    <span>/</span>
                    <span>–ß–∞—Å—Ç—å 6</span>
                    <span>/</span>
                    <span>6.2 Code Quality</span>
                </div>
            </header>

            <div class="page-content">
                <h1>–ú–æ–¥—É–ª—å 6.2: Code Quality & Security</h1>
                <p class="lead">
                    Ruff, strict Mypy, JWT/RBAC, –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞.
                </p>

                <h2>Ruff: –±—ã—Å—Ç—Ä—ã–π –ª–∏–Ω—Ç–µ—Ä</h2>
                
                <p>
                    Ruff –∑–∞–º–µ–Ω—è–µ—Ç flake8, isort, black, pyupgrade ‚Äî –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ 10-100x –±—ã—Å—Ç—Ä–µ–µ.
                </p>

<pre><code><span class="comment"># pyproject.toml</span>
[tool.ruff]
target-version = <span class="string">"py311"</span>
line-length = <span class="number">88</span>
exclude = [
    <span class="string">".git"</span>,
    <span class="string">".venv"</span>,
    <span class="string">"__pycache__"</span>,
    <span class="string">"migrations"</span>,
]

[tool.ruff.lint]
select = [
    <span class="string">"E"</span>,      <span class="comment"># pycodestyle errors</span>
    <span class="string">"W"</span>,      <span class="comment"># pycodestyle warnings</span>
    <span class="string">"F"</span>,      <span class="comment"># pyflakes</span>
    <span class="string">"I"</span>,      <span class="comment"># isort</span>
    <span class="string">"B"</span>,      <span class="comment"># flake8-bugbear</span>
    <span class="string">"C4"</span>,     <span class="comment"># flake8-comprehensions</span>
    <span class="string">"UP"</span>,     <span class="comment"># pyupgrade</span>
    <span class="string">"ARG"</span>,    <span class="comment"># flake8-unused-arguments</span>
    <span class="string">"SIM"</span>,    <span class="comment"># flake8-simplify</span>
    <span class="string">"TCH"</span>,    <span class="comment"># flake8-type-checking</span>
    <span class="string">"PTH"</span>,    <span class="comment"># flake8-use-pathlib</span>
    <span class="string">"RUF"</span>,    <span class="comment"># ruff-specific rules</span>
    <span class="string">"ASYNC"</span>,  <span class="comment"># flake8-async</span>
    <span class="string">"S"</span>,      <span class="comment"># flake8-bandit (security)</span>
]
ignore = [
    <span class="string">"E501"</span>,   <span class="comment"># line too long (handled by formatter)</span>
    <span class="string">"B008"</span>,   <span class="comment"># function call in default argument (OK for Depends)</span>
]

[tool.ruff.lint.per-file-ignores]
<span class="string">"tests/*"</span> = [<span class="string">"S101"</span>]  <span class="comment"># assert OK in tests</span>

[tool.ruff.lint.isort]
known-first-party = [<span class="string">"scaletrade"</span>]

[tool.ruff.format]
quote-style = <span class="string">"double"</span>
indent-style = <span class="string">"space"</span></code></pre>

                <h2>Strict Mypy: —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è</h2>

<pre><code><span class="comment"># pyproject.toml</span>
[tool.mypy]
python_version = <span class="string">"3.11"</span>
strict = <span class="keyword">true</span>

<span class="comment"># –í–∫–ª—é—á–∞–µ–º –≤—Å–µ strict –ø—Ä–æ–≤–µ—Ä–∫–∏</span>
warn_return_any = <span class="keyword">true</span>
warn_unused_configs = <span class="keyword">true</span>
warn_redundant_casts = <span class="keyword">true</span>
warn_unused_ignores = <span class="keyword">true</span>
no_implicit_reexport = <span class="keyword">true</span>
strict_equality = <span class="keyword">true</span>
strict_concatenate = <span class="keyword">true</span>

<span class="comment"># Disallow untyped</span>
disallow_untyped_defs = <span class="keyword">true</span>
disallow_untyped_calls = <span class="keyword">true</span>
disallow_incomplete_defs = <span class="keyword">true</span>
disallow_untyped_decorators = <span class="keyword">true</span>

<span class="comment"># Plugins</span>
plugins = [
    <span class="string">"pydantic.mypy"</span>,
    <span class="string">"sqlalchemy.ext.mypy.plugin"</span>,
]

<span class="comment"># Per-module overrides</span>
[[tool.mypy.overrides]]
module = [
    <span class="string">"tests.*"</span>,
]
disallow_untyped_defs = <span class="keyword">false</span>

[[tool.mypy.overrides]]
module = [
    <span class="string">"clickhouse_connect.*"</span>,
]
ignore_missing_imports = <span class="keyword">true</span></code></pre>

                <h2>–¢–∏–ø–∏–∑–∞—Ü–∏—è: –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã</h2>

<pre><code><span class="comment"># src/scaletrade/domain/entities/order.py</span>
<span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime
<span class="keyword">from</span> typing <span class="keyword">import</span> Self  <span class="comment"># Python 3.11+</span>


<span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class-name">Order</span>:
    id: OrderId
    user_id: UserId
    symbol: <span class="type">str</span>
    side: OrderSide
    quantity: Money
    price: Money
    status: OrderStatus = OrderStatus.PENDING
    created_at: datetime = field(default_factory=datetime.utcnow)
    filled_at: datetime | <span class="keyword">None</span> = <span class="keyword">None</span>
    
    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">create</span>(
        cls,
        user_id: UserId,
        symbol: <span class="type">str</span>,
        side: OrderSide,
        quantity: Money,
        price: Money,
    ) -> Self:
        <span class="string">"""Factory method —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π."""</span>
        <span class="keyword">return</span> cls(
            id=OrderId.generate(),
            user_id=user_id,
            symbol=symbol,
            side=side,
            quantity=quantity,
            price=price,
        )
    
    <span class="keyword">def</span> <span class="function">fill</span>(self) -> <span class="keyword">None</span>:
        <span class="string">"""–ò—Å–ø–æ–ª–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä."""</span>
        <span class="keyword">if</span> self.status == OrderStatus.FILLED:
            <span class="keyword">raise</span> OrderAlreadyFilledError(self.id)
        <span class="keyword">if</span> self.status == OrderStatus.CANCELLED:
            <span class="keyword">raise</span> OrderAlreadyCancelledError(self.id)
        
        self.status = OrderStatus.FILLED
        self.filled_at = datetime.utcnow()


<span class="comment"># Generic Repository —Å —Ç–∏–ø–∞–º–∏</span>
<span class="keyword">from</span> typing <span class="keyword">import</span> Generic, TypeVar, Protocol
<span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod

T = TypeVar(<span class="string">"T"</span>)
ID = TypeVar(<span class="string">"ID"</span>)


<span class="keyword">class</span> <span class="class-name">Repository</span>(ABC, Generic[T, ID]):
    <span class="string">"""Generic repository interface."""</span>
    
    <span class="decorator">@abstractmethod</span>
    <span class="keyword">async def</span> <span class="function">get_by_id</span>(self, id: ID) -> T | <span class="keyword">None</span>:
        ...
    
    <span class="decorator">@abstractmethod</span>
    <span class="keyword">async def</span> <span class="function">save</span>(self, entity: T) -> <span class="keyword">None</span>:
        ...
    
    <span class="decorator">@abstractmethod</span>
    <span class="keyword">async def</span> <span class="function">delete</span>(self, entity: T) -> <span class="keyword">None</span>:
        ...</code></pre>

                <h2>JWT Authentication</h2>

<pre><code><span class="comment"># src/scaletrade/infrastructure/auth/jwt.py</span>
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta
<span class="keyword">from</span> typing <span class="keyword">import</span> Any

<span class="keyword">import</span> jwt
<span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel


<span class="keyword">class</span> <span class="class-name">TokenPayload</span>(BaseModel):
    <span class="string">"""JWT payload."""</span>
    sub: <span class="type">str</span>  <span class="comment"># user_id</span>
    exp: datetime
    iat: datetime
    roles: <span class="type">list</span>[<span class="type">str</span>]


<span class="keyword">class</span> <span class="class-name">JWTService</span>:
    <span class="string">"""JWT token management."""</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(
        self,
        secret_key: <span class="type">str</span>,
        algorithm: <span class="type">str</span> = <span class="string">"HS256"</span>,
        access_token_expire: timedelta = timedelta(minutes=<span class="number">30</span>),
        refresh_token_expire: timedelta = timedelta(days=<span class="number">7</span>),
    ):
        self._secret_key = secret_key
        self._algorithm = algorithm
        self._access_expire = access_token_expire
        self._refresh_expire = refresh_token_expire
    
    <span class="keyword">def</span> <span class="function">create_access_token</span>(
        self, 
        user_id: <span class="type">str</span>, 
        roles: <span class="type">list</span>[<span class="type">str</span>]
    ) -> <span class="type">str</span>:
        <span class="string">"""–°–æ–∑–¥–∞—Ç—å access token."""</span>
        now = datetime.utcnow()
        payload = {
            <span class="string">"sub"</span>: user_id,
            <span class="string">"iat"</span>: now,
            <span class="string">"exp"</span>: now + self._access_expire,
            <span class="string">"roles"</span>: roles,
            <span class="string">"type"</span>: <span class="string">"access"</span>,
        }
        <span class="keyword">return</span> jwt.encode(payload, self._secret_key, self._algorithm)
    
    <span class="keyword">def</span> <span class="function">verify_token</span>(self, token: <span class="type">str</span>) -> TokenPayload:
        <span class="string">"""–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å token."""</span>
        <span class="keyword">try</span>:
            payload = jwt.decode(
                token, 
                self._secret_key, 
                algorithms=[self._algorithm]
            )
            <span class="keyword">return</span> TokenPayload.model_validate(payload)
        <span class="keyword">except</span> jwt.ExpiredSignatureError:
            <span class="keyword">raise</span> TokenExpiredError()
        <span class="keyword">except</span> jwt.InvalidTokenError <span class="keyword">as</span> e:
            <span class="keyword">raise</span> InvalidTokenError(<span class="type">str</span>(e))</code></pre>

                <h2>RBAC: Role-Based Access Control</h2>

<pre><code><span class="comment"># src/scaletrade/infrastructure/auth/rbac.py</span>
<span class="keyword">from</span> enum <span class="keyword">import</span> Enum
<span class="keyword">from</span> functools <span class="keyword">import</span> wraps
<span class="keyword">from</span> typing <span class="keyword">import</span> Callable, ParamSpec, TypeVar

<span class="keyword">from</span> litestar <span class="keyword">import</span> Request
<span class="keyword">from</span> litestar.exceptions <span class="keyword">import</span> NotAuthorizedException


<span class="keyword">class</span> <span class="class-name">Permission</span>(Enum):
    <span class="string">"""Permissions –≤ —Å–∏—Å—Ç–µ–º–µ."""</span>
    ORDER_CREATE = <span class="string">"order:create"</span>
    ORDER_READ = <span class="string">"order:read"</span>
    ORDER_CANCEL = <span class="string">"order:cancel"</span>
    ADMIN_READ = <span class="string">"admin:read"</span>
    ADMIN_WRITE = <span class="string">"admin:write"</span>


<span class="comment"># Role ‚Üí Permissions mapping</span>
ROLE_PERMISSIONS: <span class="type">dict</span>[<span class="type">str</span>, <span class="type">set</span>[Permission]] = {
    <span class="string">"user"</span>: {
        Permission.ORDER_CREATE,
        Permission.ORDER_READ,
        Permission.ORDER_CANCEL,
    },
    <span class="string">"admin"</span>: {
        Permission.ORDER_CREATE,
        Permission.ORDER_READ,
        Permission.ORDER_CANCEL,
        Permission.ADMIN_READ,
        Permission.ADMIN_WRITE,
    },
}


<span class="keyword">def</span> <span class="function">get_user_permissions</span>(roles: <span class="type">list</span>[<span class="type">str</span>]) -> <span class="type">set</span>[Permission]:
    <span class="string">"""–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ permissions –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ä–æ–ª–µ–π."""</span>
    permissions: <span class="type">set</span>[Permission] = <span class="type">set</span>()
    <span class="keyword">for</span> role <span class="keyword">in</span> roles:
        <span class="keyword">if</span> role <span class="keyword">in</span> ROLE_PERMISSIONS:
            permissions |= ROLE_PERMISSIONS[role]
    <span class="keyword">return</span> permissions


P = ParamSpec(<span class="string">"P"</span>)
R = TypeVar(<span class="string">"R"</span>)


<span class="keyword">def</span> <span class="function">require_permission</span>(permission: Permission):
    <span class="string">"""
    –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ permission.
    
    Usage:
        @require_permission(Permission.ADMIN_WRITE)
        async def delete_user(self, user_id: int) -> None:
            ...
    """</span>
    <span class="keyword">def</span> <span class="function">decorator</span>(
        func: Callable[P, R]
    ) -> Callable[P, R]:
        <span class="decorator">@wraps</span>(func)
        <span class="keyword">async def</span> <span class="function">wrapper</span>(
            *args: P.args, 
            **kwargs: P.kwargs
        ) -> R:
            <span class="comment"># –ü–æ–ª—É—á–∞–µ–º request –∏–∑ kwargs –∏–ª–∏ args</span>
            request = kwargs.get(<span class="string">"request"</span>) <span class="keyword">or</span> next(
                (a <span class="keyword">for</span> a <span class="keyword">in</span> args <span class="keyword">if</span> isinstance(a, Request)),
                <span class="keyword">None</span>
            )
            
            <span class="keyword">if not</span> request <span class="keyword">or not</span> request.user:
                <span class="keyword">raise</span> NotAuthorizedException()
            
            user_permissions = get_user_permissions(request.user.roles)
            
            <span class="keyword">if</span> permission <span class="keyword">not in</span> user_permissions:
                <span class="keyword">raise</span> NotAuthorizedException(
                    f<span class="string">"Permission '{permission.value}' required"</span>
                )
            
            <span class="keyword">return await</span> func(*args, **kwargs)
        
        <span class="keyword">return</span> wrapper
    <span class="keyword">return</span> decorator</code></pre>

                <h2>Guards –≤ Litestar</h2>

<pre><code><span class="comment"># src/scaletrade/interface/http/guards.py</span>
<span class="keyword">from</span> litestar <span class="keyword">import</span> Request
<span class="keyword">from</span> litestar.connection <span class="keyword">import</span> ASGIConnection
<span class="keyword">from</span> litestar.handlers <span class="keyword">import</span> BaseRouteHandler
<span class="keyword">from</span> litestar.exceptions <span class="keyword">import</span> NotAuthorizedException


<span class="keyword">def</span> <span class="function">require_authenticated</span>(
    connection: ASGIConnection,
    _: BaseRouteHandler,
) -> <span class="keyword">None</span>:
    <span class="string">"""Guard: —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏."""</span>
    <span class="keyword">if not</span> connection.user:
        <span class="keyword">raise</span> NotAuthorizedException(<span class="string">"Authentication required"</span>)


<span class="keyword">def</span> <span class="function">require_admin</span>(
    connection: ASGIConnection,
    _: BaseRouteHandler,
) -> <span class="keyword">None</span>:
    <span class="string">"""Guard: —Ç—Ä–µ–±—É–µ—Ç —Ä–æ–ª—å admin."""</span>
    <span class="keyword">if not</span> connection.user:
        <span class="keyword">raise</span> NotAuthorizedException()
    
    <span class="keyword">if</span> <span class="string">"admin"</span> <span class="keyword">not in</span> connection.user.roles:
        <span class="keyword">raise</span> NotAuthorizedException(<span class="string">"Admin role required"</span>)


<span class="comment"># –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</span>
<span class="keyword">from</span> litestar <span class="keyword">import</span> Controller, get, post


<span class="keyword">class</span> <span class="class-name">AdminController</span>(Controller):
    path = <span class="string">"/admin"</span>
    guards = [require_authenticated, require_admin]  <span class="comment"># –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º routes</span>
    
    <span class="decorator">@get</span>(<span class="string">"/users"</span>)
    <span class="keyword">async def</span> <span class="function">list_users</span>(self) -> <span class="type">list</span>[UserDTO]:
        ...
    
    <span class="decorator">@post</span>(<span class="string">"/users/{user_id}/ban"</span>)
    <span class="keyword">async def</span> <span class="function">ban_user</span>(self, user_id: <span class="type">int</span>) -> <span class="keyword">None</span>:
        ...</code></pre>

                <h2>Profiling —Å py-spy</h2>

<pre><code><span class="comment"># –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è production –ø—Ä–æ—Ü–µ—Å—Å–∞</span>
$ py-spy record -o profile.svg --pid <span class="number">12345</span>

<span class="comment"># –ò–ª–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ</span>
$ py-spy record -o profile.svg -- python -m scaletrade

<span class="comment"># Top-like view –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</span>
$ py-spy top --pid <span class="number">12345</span></code></pre>

                <div class="info-box tip">
                    <div class="info-box-title">üí° py-spy Tips</div>
                    <ul>
                        <li><strong>--native</strong> ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç C-—É—Ä–æ–≤–µ–Ω—å (SQLAlchemy, asyncpg)</li>
                        <li><strong>--subprocesses</strong> ‚Äî –≤–∫–ª—é—á–∞–µ—Ç subprocess workers</li>
                        <li><strong>Flame graphs</strong> ‚Äî –æ—Ç–∫—Ä–æ–π SVG –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</li>
                    </ul>
                </div>

                <h2>Pre-commit Hooks</h2>

<pre><code><span class="comment"># .pre-commit-config.yaml</span>
repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.4.4
    hooks:
      - id: ruff
        args: [--fix]
      - id: ruff-format
  
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.10.0
    hooks:
      - id: mypy
        additional_dependencies:
          - pydantic
          - sqlalchemy[mypy]
  
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files
      - id: detect-private-key  <span class="comment"># Security!</span></code></pre>

                <h2>ü™® –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏</h2>
                <div class="accordion">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>1. Any ‚Äî –≤—Ä–∞–≥ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ï—Å–ª–∏ –≤—ã –ø–∏—à–µ—Ç–µ <code>def foo(x: Any) -> Any</code>, –≤—ã –ø—Ä–æ—Å—Ç–æ –≤—ã–∫–ª—é—á–∞–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–æ–≤. <code>Any</code> –∑–∞—Ä–∞–∑–µ–Ω: –æ–Ω —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ –∫–æ–¥—É, –∫–∞–∫ –≤–∏—Ä—É—Å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>Any</code> —Ç–æ–ª—å–∫–æ –≤ —Å–∞–º–æ–º –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ, –∫–æ–≥–¥–∞ —Ç–∏–ø—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>2. type: ignore –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ï—Å–ª–∏ –≤—ã –≥–ª—É—à–∏—Ç–µ –æ—à–∏–±–∫—É –ª–∏–Ω—Ç–µ—Ä–∞/—Ç–∞–π–ø—á–µ–∫–µ—Ä–∞, –≤—Å–µ–≥–¥–∞ –ø–∏—à–∏—Ç–µ –ø–æ—á–µ–º—É. <code># type: ignore # dynamic attribute from library X</code>. –ò–Ω–∞—á–µ —á–µ—Ä–µ–∑ –ø–æ–ª–≥–æ–¥–∞ –Ω–∏–∫—Ç–æ –Ω–µ —Ä–∏—Å–∫–Ω–µ—Ç —ç—Ç–æ —Ç—Ä–æ–Ω—É—Ç—å, –∏ –æ—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Ç–∞–º –Ω–∞–≤—Å–µ–≥–¥–∞.</p>
                        </div>
                    </div>
                </div>

                <h2>üí° –õ–∞–π—Ñ—Ö–∞–∫–∏</h2>
                <ul>
                    <li><strong>Ruff:</strong> –≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ª–∏–Ω—Ç–µ—Ä. –≠—Ç–æ –∑–∞–º–µ–Ω–∞ Black, Isort, Flake8, Pylint –∏ –µ—â–µ –¥–µ—Å—è—Ç–∫–∞ —É—Ç–∏–ª–∏—Ç. –û–Ω –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ Rust –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ Ruff –∏ —É–¥–∞–ª—è–π—Ç–µ –ª–∏—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.</li>
                    <li><strong>Deptry:</strong> –£—Ç–∏–ª–∏—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞—à–∏ <code>requirements.txt/pyproject.toml</code>. –û–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ (—á—Ç–æ –≤–∞–∂–Ω–µ–µ) –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç–µ, –Ω–æ –∑–∞–±—ã–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ —è–≤–Ω—ã–π —Å–ø–∏—Å–æ–∫ (transitive dependencies).</li>
                    <li><strong>Strict Mypy:</strong> –í–∫–ª—é—á–∞–π—Ç–µ <code>strict = true</code> —Å—Ä–∞–∑—É –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–æ–µ–∫—Ç–∞. –í–Ω–µ–¥—Ä–∏—Ç—å –µ–≥–æ –≤ –ª–µ–≥–∞—Å–∏ –∫–æ–¥–æ–≤—É—é –±–∞–∑—É ‚Äî –∑–∞–¥–∞—á–∞ –Ω–∞ –º–µ—Å—è—Ü—ã –±–æ–ª–∏ –∏ —É–Ω–∏–∂–µ–Ω–∏–π.</li>
                </ul>

                <div class="task-box">
                    <h4>üìã –ó–∞–¥–∞–Ω–∏–µ</h4>
                    <ul class="task-list">
                        <li>–ù–∞—Å—Ç—Ä–æ–π Ruff —Å–æ –≤—Å–µ–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏</li>
                        <li>–í–∫–ª—é—á–∏ strict mode –≤ Mypy</li>
                        <li>–†–µ–∞–ª–∏–∑—É–π JWT authentication</li>
                        <li>–î–æ–±–∞–≤—å RBAC —Å permissions</li>
                        <li>–ù–∞—Å—Ç—Ä–æ–π pre-commit hooks</li>
                    </ul>
                </div>

                <div class="nav-footer">
                    <a href="part6_migrations.html">
                        <div>
                            <div class="nav-label">–ù–∞–∑–∞–¥</div>
                            <div class="nav-title">‚Üê 6.1 Zero-Downtime</div>
                        </div>
                    </a>
                    <a href="part6_django.html">
                        <div>
                            <div class="nav-label">–î–∞–ª–µ–µ</div>
                            <div class="nav-title">6.3 Django Admin ‚Üí</div>
                        </div>
                    </a>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
