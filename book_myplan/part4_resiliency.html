<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4.2 Resiliency Patterns ‚Äî ScaleTrade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="book-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üìà</div>
                    <span>ScaleTrade</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">–í–≤–µ–¥–µ–Ω–∏–µ</div>
                    <a href="index.html" class="nav-link"><span class="nav-link-icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="setup.html" class="nav-link"><span class="nav-link-icon">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 1: PostgreSQL</div>
                    <a href="part1_schema.html" class="nav-link"><span class="nav-link-icon">üìä</span>1.1 –°—Ö–µ–º–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ</a>
                    <a href="part1_transactions.html" class="nav-link"><span class="nav-link-icon">üîÑ</span>1.2 –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</a>
                    <a href="part1_indexes.html" class="nav-link"><span class="nav-link-icon">üîç</span>1.3 –ò–Ω–¥–µ–∫—Å—ã</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</div>
                    <a href="part2_litestar.html" class="nav-link"><span class="nav-link-icon">üöÄ</span>2.1 Litestar + DDD</a>
                    <a href="part2_dishka.html" class="nav-link"><span class="nav-link-icon">üíâ</span>2.2 DI —Å Dishka</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 3: –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ</div>
                    <a href="part3_faststream.html" class="nav-link"><span class="nav-link-icon">üì®</span>3.1 RabbitMQ + Faststream</a>
                    <a href="part3_redis.html" class="nav-link"><span class="nav-link-icon">‚ö°</span>3.2 Redis Patterns</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 4: –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å</div>
                    <a href="part4_testing.html" class="nav-link"><span class="nav-link-icon">üß™</span>4.1 Advanced Testing</a>
                    <a href="part4_resiliency.html" class="nav-link active"><span class="nav-link-icon">üõ°Ô∏è</span>4.2 Resiliency</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 5: Observability</div>
                    <a href="part5_logging.html" class="nav-link"><span class="nav-link-icon">üìù</span>5.1 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</a>
                    <a href="part5_clickhouse.html" class="nav-link"><span class="nav-link-icon">üìà</span>5.2 ClickHouse</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 6: Production</div>
                    <a href="part6_migrations.html" class="nav-link"><span class="nav-link-icon">üîÄ</span>6.1 Zero-Downtime</a>
                    <a href="part6_quality.html" class="nav-link"><span class="nav-link-icon">‚úÖ</span>6.2 Code Quality</a>
                    <a href="part6_django.html" class="nav-link"><span class="nav-link-icon">üîó</span>6.3 Django Admin</a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="breadcrumb">
                    <a href="index.html">ScaleTrade</a>
                    <span>/</span>
                    <span>–ß–∞—Å—Ç—å 4</span>
                    <span>/</span>
                    <span>4.2 Resiliency</span>
                </div>
            </header>

            <div class="page-content">
                <h1>–ú–æ–¥—É–ª—å 4.2: Resiliency Patterns</h1>
                <p class="lead">
                    Stamina –¥–ª—è —Ä–µ—Ç—Ä–∞–µ–≤, Circuit Breaker, Timeout ‚Äî –¥–µ–ª–∞–µ–º —Å–∏—Å—Ç–µ–º—É —É—Å—Ç–æ–π—á–∏–≤–æ–π –∫ —Å–±–æ—è–º.
                </p>

                <div class="info-box tip">
                    <div class="info-box-title">üí° –ì–ª–∞–≤–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø</div>
                    <p>
                        –í —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –æ—à–∏–±–∫–∏ ‚Äî –Ω–æ—Ä–º–∞, –Ω–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
                        –í–æ–ø—Ä–æ—Å –Ω–µ "–µ—Å–ª–∏", –∞ "–∫–æ–≥–¥–∞" —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è.
                    </p>
                </div>

                <h2>Stamina: Retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff</h2>
                
                <p>
                    Stamina ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è retry –≤ Python. 
                    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç exponential backoff —Å jitter –∏–∑ –∫–æ—Ä–æ–±–∫–∏.
                </p>

<pre><code><span class="comment"># src/scaletrade/infrastructure/external/price_service.py</span>
<span class="keyword">import</span> httpx
<span class="keyword">import</span> stamina
<span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal


<span class="keyword">class</span> <span class="class-name">PriceServiceError</span>(Exception):
    <span class="string">"""–ë–∞–∑–æ–≤–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ —Ü–µ–Ω."""</span>
    <span class="keyword">pass</span>


<span class="keyword">class</span> <span class="class-name">PriceService</span>:
    <span class="string">"""–°–µ—Ä–≤–∏—Å –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ API."""</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(self, base_url: <span class="type">str</span>, timeout: <span class="type">float</span> = <span class="number">5.0</span>):
        self.base_url = base_url
        self.timeout = timeout
        self._client = httpx.AsyncClient(timeout=timeout)
    
    <span class="decorator">@stamina.retry</span>(
        on=httpx.HTTPStatusError,  <span class="comment"># –ö–∞–∫–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Ä–µ—Ç—Ä–∞–∏—Ç—å</span>
        attempts=<span class="number">3</span>,                  <span class="comment"># –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫</span>
        timeout=<span class="number">30</span>,                  <span class="comment"># –û–±—â–∏–π —Ç–∞–π–º–∞—É—Ç –Ω–∞ –≤—Å–µ —Ä–µ—Ç—Ä–∞–∏</span>
    )
    <span class="keyword">async def</span> <span class="function">get_price</span>(self, symbol: <span class="type">str</span>) -> Decimal:
        <span class="string">"""
        –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É —Å–∏–º–≤–æ–ª–∞.
        
        Stamina –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
        - –ñ–¥—ë—Ç 1s ‚Üí 2s ‚Üí 4s –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (exponential backoff)
        - –î–æ–±–∞–≤–ª—è–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π jitter (¬±25%)
        - –õ–æ–≥–∏—Ä—É–µ—Ç retry –ø–æ–ø—ã—Ç–∫–∏
        """</span>
        response = <span class="keyword">await</span> self._client.get(
            f<span class="string">"{self.base_url}/price/{symbol}"</span>
        )
        response.raise_for_status()
        
        data = response.json()
        <span class="keyword">return</span> Decimal(data[<span class="string">"price"</span>])


<span class="comment"># –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</span>
<span class="keyword">class</span> <span class="class-name">AdvancedPriceService</span>:
    
    <span class="decorator">@stamina.retry</span>(
        on=(
            httpx.HTTPStatusError,
            httpx.ConnectError,
            httpx.ReadTimeout,
        ),
        attempts=<span class="number">5</span>,
        timeout=<span class="number">60</span>,
        wait_initial=<span class="number">0.5</span>,   <span class="comment"># –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞</span>
        wait_max=<span class="number">10</span>,         <span class="comment"># –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞</span>
        wait_jitter=<span class="number">0.25</span>,    <span class="comment"># Jitter ¬±25%</span>
    )
    <span class="keyword">async def</span> <span class="function">get_price</span>(self, symbol: <span class="type">str</span>) -> Decimal:
        <span class="keyword">pass</span></code></pre>

                <h2>–£—Å–ª–æ–≤–Ω—ã–π Retry: Retry Predicate</h2>

<pre><code><span class="comment"># –†–µ—Ç—Ä–∞–∏–º —Ç–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ HTTP —Å—Ç–∞—Ç—É—Å—ã</span>
<span class="keyword">def</span> <span class="function">is_retryable</span>(exc: Exception) -> <span class="type">bool</span>:
    <span class="string">"""–û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å—Ç–æ–∏—Ç –ª–∏ —Ä–µ—Ç—Ä–∞–∏—Ç—å."""</span>
    <span class="keyword">if</span> isinstance(exc, httpx.HTTPStatusError):
        <span class="comment"># 429 (Rate Limit) –∏ 5xx ‚Äî —Ä–µ—Ç—Ä–∞–∏–º</span>
        <span class="keyword">return</span> exc.response.status_code <span class="keyword">in</span> (
            <span class="number">429</span>, <span class="number">500</span>, <span class="number">502</span>, <span class="number">503</span>, <span class="number">504</span>
        )
    <span class="keyword">return</span> <span class="keyword">True</span>


<span class="keyword">class</span> <span class="class-name">SmartPriceService</span>:
    
    <span class="decorator">@stamina.retry</span>(
        on=httpx.HTTPStatusError,
        attempts=<span class="number">3</span>,
        <span class="comment"># –ü—Ä–µ–¥–∏–∫–∞—Ç –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ —Ä–µ—Ç—Ä–∞—è</span>
        retry_on=is_retryable,
    )
    <span class="keyword">async def</span> <span class="function">get_price</span>(self, symbol: <span class="type">str</span>) -> Decimal:
        <span class="string">"""4xx (–∫—Ä–æ–º–µ 429) –Ω–µ —Ä–µ—Ç—Ä–∞—è—Ç—Å—è ‚Äî —ç—Ç–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –æ—à–∏–±–∫–∏."""</span>
        response = <span class="keyword">await</span> self._client.get(f<span class="string">"/price/{symbol}"</span>)
        response.raise_for_status()
        <span class="keyword">return</span> Decimal(response.json()[<span class="string">"price"</span>])</code></pre>

                <h2>Circuit Breaker Pattern</h2>
                
                <p>
                    –ö–æ–≥–¥–∞ —Å–µ—Ä–≤–∏—Å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–∞–¥–∞–µ—Ç, –Ω–µ—Ç —Å–º—ã—Å–ª–∞ –¥–æ–ª–±–∏—Ç—å –µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞–º–∏.
                    Circuit Breaker "—Ä–∞–∑–º—ã–∫–∞–µ—Ç —Ü–µ–ø—å" –ø–æ—Å–ª–µ N –æ—à–∏–±–æ–∫.
                </p>

                <table>
                    <thead>
                        <tr>
                            <th>–°–æ—Å—Ç–æ—è–Ω–∏–µ</th>
                            <th>–ü–æ–≤–µ–¥–µ–Ω–∏–µ</th>
                            <th>–ü–µ—Ä–µ—Ö–æ–¥</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>CLOSED</strong></td>
                            <td>–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç</td>
                            <td>‚Üí OPEN –ø—Ä–∏ N –æ—à–∏–±–∫–∞—Ö</td>
                        </tr>
                        <tr>
                            <td><strong>OPEN</strong></td>
                            <td>–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã fail fast</td>
                            <td>‚Üí HALF-OPEN –ø–æ —Ç–∞–π–º–∞—É—Ç—É</td>
                        </tr>
                        <tr>
                            <td><strong>HALF-OPEN</strong></td>
                            <td>–ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</td>
                            <td>‚Üí CLOSED / OPEN</td>
                        </tr>
                    </tbody>
                </table>

<pre><code><span class="comment"># src/scaletrade/infrastructure/resiliency/circuit_breaker.py</span>
<span class="keyword">import</span> asyncio
<span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta
<span class="keyword">from</span> enum <span class="keyword">import</span> Enum
<span class="keyword">from</span> typing <span class="keyword">import</span> Callable, TypeVar, ParamSpec

P = ParamSpec(<span class="string">"P"</span>)
R = TypeVar(<span class="string">"R"</span>)


<span class="keyword">class</span> <span class="class-name">CircuitState</span>(Enum):
    CLOSED = <span class="string">"closed"</span>
    OPEN = <span class="string">"open"</span>
    HALF_OPEN = <span class="string">"half_open"</span>


<span class="keyword">class</span> <span class="class-name">CircuitOpenError</span>(Exception):
    <span class="string">"""–¶–µ–ø—å —Ä–∞–∑–æ–º–∫–Ω—É—Ç–∞, –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è."""</span>
    <span class="keyword">pass</span>


<span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class-name">CircuitBreaker</span>:
    <span class="string">"""
    Circuit Breaker –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤.
    
    Usage:
        breaker = CircuitBreaker(failure_threshold=5, recovery_timeout=30)
        
        @breaker
        async def call_external_api():
            ...
    """</span>
    failure_threshold: <span class="type">int</span> = <span class="number">5</span>          <span class="comment"># –ü–æ—Ä–æ–≥ –æ—à–∏–±–æ–∫ –¥–ª—è OPEN</span>
    recovery_timeout: <span class="type">float</span> = <span class="number">30.0</span>      <span class="comment"># –°–µ–∫—É–Ω–¥—ã –¥–æ HALF_OPEN</span>
    half_open_requests: <span class="type">int</span> = <span class="number">1</span>         <span class="comment"># –ó–∞–ø—Ä–æ—Å–æ–≤ –≤ HALF_OPEN</span>
    
    _state: CircuitState = field(default=CircuitState.CLOSED, init=<span class="keyword">False</span>)
    _failure_count: <span class="type">int</span> = field(default=<span class="number">0</span>, init=<span class="keyword">False</span>)
    _last_failure_time: datetime | <span class="keyword">None</span> = field(default=<span class="keyword">None</span>, init=<span class="keyword">False</span>)
    _lock: asyncio.Lock = field(default_factory=asyncio.Lock, init=<span class="keyword">False</span>)
    
    <span class="decorator">@property</span>
    <span class="keyword">def</span> <span class="function">state</span>(self) -> CircuitState:
        <span class="keyword">return</span> self._state
    
    <span class="keyword">async def</span> <span class="function">_should_allow_request</span>(self) -> <span class="type">bool</span>:
        <span class="string">"""–ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø—Ä–æ—Å."""</span>
        <span class="keyword">if</span> self._state == CircuitState.CLOSED:
            <span class="keyword">return True</span>
        
        <span class="keyword">if</span> self._state == CircuitState.OPEN:
            <span class="comment"># –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ HALF_OPEN</span>
            <span class="keyword">if</span> self._last_failure_time:
                elapsed = (datetime.utcnow() - self._last_failure_time).total_seconds()
                <span class="keyword">if</span> elapsed >= self.recovery_timeout:
                    <span class="keyword">async with</span> self._lock:
                        self._state = CircuitState.HALF_OPEN
                    <span class="keyword">return True</span>
            <span class="keyword">return False</span>
        
        <span class="comment"># HALF_OPEN ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º</span>
        <span class="keyword">return True</span>
    
    <span class="keyword">async def</span> <span class="function">_record_success</span>(self) -> <span class="keyword">None</span>:
        <span class="string">"""–ó–∞–ø–∏—Å—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å."""</span>
        <span class="keyword">async with</span> self._lock:
            <span class="keyword">if</span> self._state == CircuitState.HALF_OPEN:
                <span class="comment"># –£—Å–ø–µ—Ö –≤ HALF_OPEN ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ–º —Ü–µ–ø—å</span>
                self._state = CircuitState.CLOSED
            self._failure_count = <span class="number">0</span>
    
    <span class="keyword">async def</span> <span class="function">_record_failure</span>(self) -> <span class="keyword">None</span>:
        <span class="string">"""–ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É."""</span>
        <span class="keyword">async with</span> self._lock:
            self._failure_count += <span class="number">1</span>
            self._last_failure_time = datetime.utcnow()
            
            <span class="keyword">if</span> self._state == CircuitState.HALF_OPEN:
                <span class="comment"># –û—à–∏–±–∫–∞ –≤ HALF_OPEN ‚Üí –æ–±—Ä–∞—Ç–Ω–æ –≤ OPEN</span>
                self._state = CircuitState.OPEN
            <span class="keyword">elif</span> self._failure_count >= self.failure_threshold:
                <span class="comment"># –ü—Ä–µ–≤—ã—Å–∏–ª–∏ –ø–æ—Ä–æ–≥ ‚Üí —Ä–∞–∑–º—ã–∫–∞–µ–º</span>
                self._state = CircuitState.OPEN
    
    <span class="keyword">def</span> <span class="function">__call__</span>(
        self, 
        func: Callable[P, R]
    ) -> Callable[P, R]:
        <span class="string">"""–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∑–∞—â–∏—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏."""</span>
        <span class="keyword">async def</span> <span class="function">wrapper</span>(*args: P.args, **kwargs: P.kwargs) -> R:
            <span class="keyword">if not await</span> self._should_allow_request():
                <span class="keyword">raise</span> CircuitOpenError(
                    f<span class="string">"Circuit is OPEN. Retry after {self.recovery_timeout}s"</span>
                )
            
            <span class="keyword">try</span>:
                result = <span class="keyword">await</span> func(*args, **kwargs)
                <span class="keyword">await</span> self._record_success()
                <span class="keyword">return</span> result
            <span class="keyword">except</span> Exception:
                <span class="keyword">await</span> self._record_failure()
                <span class="keyword">raise</span>
        
        <span class="keyword">return</span> wrapper</code></pre>

                <h2>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Circuit Breaker</h2>

<pre><code><span class="comment"># src/scaletrade/infrastructure/external/exchange_client.py</span>
<span class="keyword">from</span> scaletrade.infrastructure.resiliency <span class="keyword">import</span> CircuitBreaker


<span class="comment"># –°–æ–∑–¥–∞—ë–º Circuit Breaker –¥–ª—è exchange API</span>
exchange_breaker = CircuitBreaker(
    failure_threshold=<span class="number">5</span>,     <span class="comment"># 5 –æ—à–∏–±–æ–∫ ‚Üí OPEN</span>
    recovery_timeout=<span class="number">60</span>,      <span class="comment"># 60 —Å–µ–∫—É–Ω–¥ –¥–æ HALF_OPEN</span>
)


<span class="keyword">class</span> <span class="class-name">ExchangeClient</span>:
    
    <span class="comment"># –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º Retry + Circuit Breaker</span>
    <span class="decorator">@exchange_breaker</span>
    <span class="decorator">@stamina.retry</span>(on=httpx.HTTPError, attempts=<span class="number">3</span>)
    <span class="keyword">async def</span> <span class="function">place_order</span>(self, order: OrderDTO) -> OrderResult:
        <span class="string">"""
        –†–∞–∑–º–µ—â–∞–µ–º –æ—Ä–¥–µ—Ä –Ω–∞ –±–∏—Ä–∂–µ.
        
        Flow:
        1. Circuit Breaker –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        2. –ï—Å–ª–∏ CLOSED/HALF_OPEN ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        3. Stamina —Ä–µ—Ç—Ä–∞–∏—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
        4. Circuit Breaker –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        """</span>
        response = <span class="keyword">await</span> self._client.post(
            <span class="string">"/orders"</span>,
            json=order.model_dump(),
        )
        response.raise_for_status()
        <span class="keyword">return</span> OrderResult.model_validate(response.json())


<span class="comment"># Controller —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π CircuitOpenError</span>
<span class="keyword">from</span> litestar <span class="keyword">import</span> Controller, post
<span class="keyword">from</span> litestar.exceptions <span class="keyword">import</span> ServiceUnavailableException


<span class="keyword">class</span> <span class="class-name">OrderController</span>(Controller):
    path = <span class="string">"/orders"</span>
    
    <span class="decorator">@post</span>()
    <span class="keyword">async def</span> <span class="function">create_order</span>(
        self, 
        data: CreateOrderDTO,
        exchange_client: ExchangeClient,
    ) -> OrderDTO:
        <span class="keyword">try</span>:
            <span class="keyword">return await</span> exchange_client.place_order(data)
        <span class="keyword">except</span> CircuitOpenError:
            <span class="comment"># Circuit —Ä–∞–∑–æ–º–∫–Ω—É—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 503</span>
            <span class="keyword">raise</span> ServiceUnavailableException(
                <span class="string">"Exchange service temporarily unavailable. Please retry later."</span>
            )</code></pre>

                <h2>Timeout Pattern</h2>

<pre><code><span class="comment"># src/scaletrade/infrastructure/resiliency/timeout.py</span>
<span class="keyword">import</span> asyncio
<span class="keyword">from</span> functools <span class="keyword">import</span> wraps


<span class="keyword">class</span> <span class="class-name">TimeoutError</span>(Exception):
    <span class="string">"""–û–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—ã—Å–∏–ª–∞ —Ç–∞–π–º–∞—É—Ç."""</span>
    <span class="keyword">pass</span>


<span class="keyword">def</span> <span class="function">with_timeout</span>(seconds: <span class="type">float</span>):
    <span class="string">"""
    –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
    
    Usage:
        @with_timeout(5.0)
        async def slow_operation():
            ...
    """</span>
    <span class="keyword">def</span> <span class="function">decorator</span>(func):
        <span class="decorator">@wraps</span>(func)
        <span class="keyword">async def</span> <span class="function">wrapper</span>(*args, **kwargs):
            <span class="keyword">try</span>:
                <span class="keyword">return await</span> asyncio.wait_for(
                    func(*args, **kwargs),
                    timeout=seconds,
                )
            <span class="keyword">except</span> asyncio.TimeoutError:
                <span class="keyword">raise</span> TimeoutError(
                    f<span class="string">"Operation timed out after {seconds}s"</span>
                )
        <span class="keyword">return</span> wrapper
    <span class="keyword">return</span> decorator


<span class="comment"># –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</span>
<span class="keyword">class</span> <span class="class-name">PaymentService</span>:
    
    <span class="decorator">@with_timeout</span>(<span class="number">10.0</span>)  <span class="comment"># –ú–∞–∫—Å–∏–º—É–º 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ –ø–ª–∞—Ç—ë–∂</span>
    <span class="keyword">async def</span> <span class="function">process_payment</span>(self, payment: Payment) -> PaymentResult:
        <span class="comment"># –ú–µ–¥–ª–µ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è</span>
        <span class="keyword">return await</span> self._gateway.charge(payment)</code></pre>

                <h2>Bulkhead Pattern: –∏–∑–æ–ª—è—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤</h2>

<pre><code><span class="comment"># src/scaletrade/infrastructure/resiliency/bulkhead.py</span>
<span class="keyword">import</span> asyncio
<span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass


<span class="keyword">class</span> <span class="class-name">BulkheadFullError</span>(Exception):
    <span class="string">"""–í—Å–µ —Å–ª–æ—Ç—ã –∑–∞–Ω—è—Ç—ã, –æ–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞."""</span>
    <span class="keyword">pass</span>


<span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class-name">Bulkhead</span>:
    <span class="string">"""
    Bulkhead –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç concurrent calls.
    
    –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç:
    - –ò—Å—á–µ—Ä–ø–∞–Ω–∏—è connection pool
    - –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∏ downstream —Å–µ—Ä–≤–∏—Å–æ–≤
    - –ö–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤
    """</span>
    max_concurrent: <span class="type">int</span> = <span class="number">10</span>
    
    <span class="keyword">def</span> <span class="function">__post_init__</span>(self):
        self._semaphore = asyncio.Semaphore(self.max_concurrent)
    
    <span class="keyword">async def</span> <span class="function">acquire</span>(self) -> <span class="type">bool</span>:
        <span class="string">"""–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —Å–ª–æ—Ç (–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)."""</span>
        <span class="keyword">return</span> self._semaphore.locked() <span class="keyword">is False</span>
    
    <span class="keyword">def</span> <span class="function">__call__</span>(self, func):
        <span class="keyword">async def</span> <span class="function">wrapper</span>(*args, **kwargs):
            <span class="comment"># –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Å–ª–æ—Ç –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è</span>
            <span class="keyword">if</span> self._semaphore.locked():
                <span class="keyword">raise</span> BulkheadFullError(
                    f<span class="string">"Max concurrent calls ({self.max_concurrent}) reached"</span>
                )
            
            <span class="keyword">async with</span> self._semaphore:
                <span class="keyword">return await</span> func(*args, **kwargs)
        
        <span class="keyword">return</span> wrapper


<span class="comment"># –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –∏–∑–æ–ª—è—Ü–∏—è external API</span>
exchange_bulkhead = Bulkhead(max_concurrent=<span class="number">20</span>)
payment_bulkhead = Bulkhead(max_concurrent=<span class="number">5</span>)


<span class="keyword">class</span> <span class="class-name">ExchangeClient</span>:
    <span class="decorator">@exchange_bulkhead</span>
    <span class="decorator">@exchange_breaker</span>
    <span class="decorator">@stamina.retry</span>(on=httpx.HTTPError, attempts=<span class="number">3</span>)
    <span class="keyword">async def</span> <span class="function">place_order</span>(self, order):
        <span class="keyword">pass</span></code></pre>

                <h2>Graceful Degradation</h2>

<pre><code><span class="comment"># src/scaletrade/infrastructure/external/price_service_fallback.py</span>
<span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal
<span class="keyword">from</span> typing <span class="keyword">import</span> Optional


<span class="keyword">class</span> <span class="class-name">PriceServiceWithFallback</span>:
    <span class="string">"""
    –°–µ—Ä–≤–∏—Å —Ü–µ–Ω —Å fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π.
    
    –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à.
    –ï—Å–ª–∏ –∫–µ—à –ø—É—Å—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º stale –¥–∞–Ω–Ω—ã–µ.
    """</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(
        self, 
        primary_service: PriceService,
        cache: PriceCache,
    ):
        self._primary = primary_service
        self._cache = cache
    
    <span class="keyword">async def</span> <span class="function">get_price</span>(
        self, 
        symbol: <span class="type">str</span>,
        accept_stale: <span class="type">bool</span> = <span class="keyword">True</span>,
    ) -> Optional[Decimal]:
        <span class="string">"""
        –ü–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É —Å graceful degradation.
        
        Strategy:
        1. –ü—Ä–æ–±—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π API
        2. Fallback –Ω–∞ –∫–µ—à (—Å–≤–µ–∂–∏–π)
        3. Fallback –Ω–∞ stale –∫–µ—à (–µ—Å–ª–∏ accept_stale=True)
        """</span>
        <span class="comment"># 1. Primary source</span>
        <span class="keyword">try</span>:
            price = <span class="keyword">await</span> self._primary.get_price(symbol)
            <span class="comment"># –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à –ø—Ä–∏ —É—Å–ø–µ—Ö–µ</span>
            <span class="keyword">await</span> self._cache.set(symbol, price)
            <span class="keyword">return</span> price
        <span class="keyword">except</span> (CircuitOpenError, TimeoutError) <span class="keyword">as</span> e:
            <span class="comment"># –õ–æ–≥–∏—Ä—É–µ–º degradation</span>
            logger.warning(f<span class="string">"Primary price service failed: {e}"</span>)
        
        <span class="comment"># 2. Fresh cache</span>
        cached = <span class="keyword">await</span> self._cache.get(symbol)
        <span class="keyword">if</span> cached <span class="keyword">and not</span> cached.is_stale:
            logger.info(f<span class="string">"Using cached price for {symbol}"</span>)
            <span class="keyword">return</span> cached.price
        
        <span class="comment"># 3. Stale cache (last resort)</span>
        <span class="keyword">if</span> accept_stale <span class="keyword">and</span> cached:
            logger.warning(
                f<span class="string">"Using STALE price for {symbol}, "</span>
                f<span class="string">"age: {cached.age_seconds}s"</span>
            )
            <span class="keyword">return</span> cached.price
        
        <span class="keyword">return None</span></code></pre>

                <h2>ü™® –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏</h2>
                <div class="accordion">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>1. Retry Storm</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ï—Å–ª–∏ –æ–¥–∏–Ω —Å–µ—Ä–≤–∏—Å —É–ø–∞–ª, –∏ 1000 –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞—á–∞–ª–∏ –¥–æ–ª–±–∏—Ç—å –µ–≥–æ —Ä–µ—Ç—Ä–∞—è–º–∏, –æ–Ω –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è. –†–µ—Ç—Ä–∞–∏ ‚Äî —ç—Ç–æ DDOS –∞—Ç–∞–∫–∞ –Ω–∞ —Å–∞–º–æ–≥–æ —Å–µ–±—è. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Exponential Backoff –∏ Jitter. –ò –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Ç–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>2. –†–µ—Ç—Ä–∞–∏ –Ω–∞ 4xx –æ—à–∏–±–∫–∏</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–µ–ª–∞–π—Ç–µ —Ä–µ—Ç—Ä–∞–π –Ω–∞ <code>400 Bad Request</code> –∏–ª–∏ <code>403 Forbidden</code>. –û—à–∏–±–∫–∞ –Ω–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—Å—è —Å–∞–º–∞ —Å–æ–±–æ–π. –†–µ—Ç—Ä–∞–∏ –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤ (—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, —Ç–∞–π–º–∞—É—Ç—ã, 503). 429 (Too Many Requests) ‚Äî –æ—Å–æ–±—ã–π —Å–ª—É—á–∞–π, —Ç—Ä–µ–±—É–µ—Ç <code>Retry-After</code>.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>3. Local Circuit Breaker –≤ K8s</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ï—Å–ª–∏ —É –≤–∞—Å 100 –ø–æ–¥–æ–≤, –∏ CB –≤ –∫–∞–∂–¥–æ–º –∏–∑ –Ω–∏—Ö "in-memory", —Ç–æ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Ü–µ–ø—å –≥–ª–æ–±–∞–ª—å–Ω–æ, —Å–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω —É–ø–∞—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–∞ –æ—Ç–¥–µ–ª—å–Ω–æ. –í –±–æ–ª—å—à–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö CB –≤—ã–Ω–æ—Å—è—Ç –≤ Service Mesh (Istio/Linkerd).</p>
                        </div>
                    </div>
                </div>

                <h2>üí° –õ–∞–π—Ñ—Ö–∞–∫–∏</h2>
                <ul>
                    <li><strong>Stamina:</strong> –ù–µ –ø–∏—à–∏—Ç–µ —Ü–∏–∫–ª—ã <code>while attempts > 0</code>. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É <code>stamina</code> (–æ–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ <code>tenacity</code>) ‚Äî –æ–Ω–∞ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å <code>asyncio</code> –∏–∑ –∫–æ—Ä–æ–±–∫–∏.</li>
                    <li><strong>Idempotency Key:</strong> –õ—é–±–æ–π –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Ä–µ—Ç—Ä–∞–∏—Ç–µ, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º. –ü–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ <code>X-Idempotency-Key</code> –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –º–æ–≥ –æ—Ç—Å–µ—è—Ç—å –¥—É–±–ª–∏.</li>
                    <li><strong>Timeouts:</strong> –¢–∞–π–º–∞—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å. –≠—Ç–æ –∑–ª–æ. –í—Å–µ–≥–¥–∞ —Å—Ç–∞–≤—å—Ç–µ —Ç–∞–π–º–∞—É—Ç –Ω–∞ –ª—é–±–æ–π —Å–µ—Ç–µ–≤–æ–π –≤—ã–∑–æ–≤ (DB, HTTP, Redis). <code>aiohttp</code> –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–º–µ–µ—Ç —Ç–∞–π–º–∞—É—Ç 5 –º–∏–Ω—É—Ç ‚Äî —ç—Ç–æ —Ç–æ–∂–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥–ª—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞.</li>
                </ul>

                <div class="task-box">
                    <h4>üìã –ó–∞–¥–∞–Ω–∏–µ</h4>
                    <ul class="task-list">
                        <li>–î–æ–±–∞–≤—å Stamina retry –∫ ExchangeClient</li>
                        <li>–†–µ–∞–ª–∏–∑—É–π Circuit Breaker –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API</li>
                        <li>–ù–∞—Å—Ç—Ä–æ–π Bulkhead –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤</li>
                        <li>–†–µ–∞–ª–∏–∑—É–π Graceful Degradation –¥–ª—è PriceService</li>
                        <li>–ù–∞–ø–∏—à–∏ —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö resiliency patterns</li>
                    </ul>
                </div>

                <div class="nav-footer">
                    <a href="part4_testing.html">
                        <div>
                            <div class="nav-label">–ù–∞–∑–∞–¥</div>
                            <div class="nav-title">‚Üê 4.1 Advanced Testing</div>
                        </div>
                    </a>
                    <a href="part5_logging.html">
                        <div>
                            <div class="nav-label">–î–∞–ª–µ–µ</div>
                            <div class="nav-title">5.1 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí</div>
                        </div>
                    </a>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
