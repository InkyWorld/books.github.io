<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6.1 Zero-Downtime Migrations ‚Äî ScaleTrade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="book-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üìà</div>
                    <span>ScaleTrade</span>
                </a>
            </div>
            <nav class="sidebar-nav">
    <div class="nav-section">
        <div class="nav-section-title">Intro</div>
        <a href="index.html" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
        <a href="setup.html" class="nav-link">üõ† Setup</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 0: Fundamentals</div>
        <a href="part0_internals.html" class="nav-link">0.1 Internals</a>
        <a href="part0_networking.html" class="nav-link">0.2 Networking</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 1: Postgres</div>
        <a href="part1_schema.html" class="nav-link">1.1 Schema</a>
        <a href="part1_indexes.html" class="nav-link">1.2 Indexes</a>
        <a href="part1_transactions.html" class="nav-link">1.3 Transactions</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 2: Litestar</div>
        <a href="part2_litestar.html" class="nav-link">2.1 Framework</a>
        <a href="part2_dishka.html" class="nav-link">2.2 DI (Dishka)</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 3: Brokers</div>
        <a href="part3_redis.html" class="nav-link">3.1 Redis</a>
        <a href="part3_faststream.html" class="nav-link">3.2 FastStream</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 4: Quality</div>
        <a href="part4_testing.html" class="nav-link">4.1 Pytest</a>
        <a href="part4_resiliency.html" class="nav-link">4.2 Resilience</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 5: Observability</div>
        <a href="part5_clickhouse.html" class="nav-link">5.1 Clickhouse</a>
        <a href="part5_logging.html" class="nav-link">5.2 Structured Logs</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 6: Django</div>
        <a href="part6_django.html" class="nav-link">6.1 ORM</a>
        <a href="part6_migrations.html" class="nav-link active">6.2 Migrations</a>
        <a href="part6_quality.html" class="nav-link">6.3 Quality</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 7: Microservices</div>
        <a href="part7_grpc.html" class="nav-link">7.1 gRPC</a>
        <a href="part7_graphql.html" class="nav-link">7.2 GraphQL</a>
        <a href="part7_federation.html" class="nav-link">7.3 Federation</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 8: Async</div>
        <a href="part8_asyncio.html" class="nav-link">8.1 Asyncio</a>
        <a href="part8_celery.html" class="nav-link">8.2 Celery</a>
        <a href="part8_dramatiq.html" class="nav-link">8.3 Dramatiq</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 9: API</div>
        <a href="part9_restdesign.html" class="nav-link">9.1 REST Design</a>
        <a href="part9_idempotency.html" class="nav-link">9.2 Idempotency</a>
        <a href="part9_openapi.html" class="nav-link">9.3 OpenAPI</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 10: Culture</div>
        <a href="part10_git.html" class="nav-link">10.1 Git</a>
        <a href="part10_commits.html" class="nav-link">10.2 Commits</a>
        <a href="part10_codereview.html" class="nav-link">10.3 Post-Review</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 11: Security</div>
        <a href="part11_oauth.html" class="nav-link">11.1 OAuth2</a>
        <a href="part11_vault.html" class="nav-link">11.2 Vault</a>
        <a href="part11_owasp.html" class="nav-link">11.3 OWASP</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 12: Kubernetes</div>
        <a href="part12_kubernetes.html" class="nav-link">12.1 K8s Basics</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 13: High Load</div>
        <a href="part13_profiling.html" class="nav-link">13.1 Profiling</a>
        <a href="part13_caching.html" class="nav-link">13.2 Caching</a>
        <a href="part13_loadbalancing.html" class="nav-link">13.3 Load Balancing</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 14: ML Ops</div>
        <a href="part14_mlflow.html" class="nav-link">14.1 MLflow</a>
        <a href="part14_embeddings.html" class="nav-link">14.2 Embeddings</a>
        <a href="part14_llm.html" class="nav-link">14.3 LLM</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 15: Debugging</div>
        <a href="part15_debugging.html" class="nav-link">15.1 Debugging</a>
        <a href="part15_postmortem.html" class="nav-link">15.2 Postmortem</a>
        <a href="part15_chaos.html" class="nav-link">15.3 Chaos Eng</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 16: DB Advanced</div>
        <a href="part16_indexes.html" class="nav-link">16.1 Indexes Deep</a>
        <a href="part16_isolation.html" class="nav-link">16.2 Isolation</a>
        <a href="part16_sharding.html" class="nav-link">16.3 Sharding</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 17: System Design</div>
        <a href="part17_circuit.html" class="nav-link">17.1 Circuit Breaker</a>
        <a href="part17_ratelimit.html" class="nav-link">17.2 Rate Limit</a>
        <a href="part17_distlock.html" class="nav-link">17.3 Dist Lock</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 18: Soft Skills</div>
        <a href="part18_estimation.html" class="nav-link">18.1 Estimation</a>
        <a href="part18_burnout.html" class="nav-link">18.2 Burnout</a>
        <a href="part18_interview.html" class="nav-link">18.3 Interview</a>
    </div>
</nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="breadcrumb">
                    <a href="index.html">ScaleTrade</a>
                    <span>/</span>
                    <span>–ß–∞—Å—Ç—å 6</span>
                    <span>/</span>
                    <span>6.1 Zero-Downtime Migrations</span>
                </div>
            </header>

            <div class="page-content">
                <h1>–ú–æ–¥—É–ª—å 6.1: Zero-Downtime Migrations</h1>
                <p class="lead">
                    Alembic, Expand-Contract Pattern, lock_timeout ‚Äî –º–∏–≥—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø—Ä–æ—Å—Ç–æ—è.
                </p>

                <div class="info-box danger">
                    <div class="info-box-title">üö® –û–ø–∞—Å–Ω–æ—Å—Ç—å</div>
                    <p>
                        –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –º–∏–Ω—É—Ç—ã/—á–∞—Å—ã.
                        –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –∂–¥–∞—Ç—å, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äî —Å—Ç—Ä–∞–¥–∞—Ç—å.
                    </p>
                </div>

                <h2>–û–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ PostgreSQL</h2>

                <table>
                    <thead>
                        <tr>
                            <th>–û–ø–µ—Ä–∞—Ü–∏—è</th>
                            <th>–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞</th>
                            <th>–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>ADD COLUMN NOT NULL</code></td>
                            <td>AccessExclusive üî¥</td>
                            <td>ADD COLUMN ‚Üí SET DEFAULT ‚Üí SET NOT NULL</td>
                        </tr>
                        <tr>
                            <td><code>CREATE INDEX</code></td>
                            <td>ShareLock üü°</td>
                            <td><code>CREATE INDEX CONCURRENTLY</code></td>
                        </tr>
                        <tr>
                            <td><code>ALTER COLUMN TYPE</code></td>
                            <td>AccessExclusive üî¥</td>
                            <td>Expand-Contract pattern</td>
                        </tr>
                        <tr>
                            <td><code>DROP COLUMN</code></td>
                            <td>AccessExclusive üî¥</td>
                            <td>–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤ PostgreSQL 11+</td>
                        </tr>
                        <tr>
                            <td><code>ADD CONSTRAINT</code></td>
                            <td>AccessExclusive üî¥</td>
                            <td><code>NOT VALID</code> ‚Üí <code>VALIDATE</code></td>
                        </tr>
                    </tbody>
                </table>

                <h2>Alembic: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞</h2>

<pre><code><span class="comment"># alembic.ini</span>
[alembic]
script_location = src/scaletrade/infrastructure/database/migrations
sqlalchemy.url = driver://user:pass@localhost/dbname

[post_write_hooks]
hooks = ruff
ruff.type = exec
ruff.executable = ruff
ruff.options = format REVISION_SCRIPT_FILENAME</code></pre>

<pre><code><span class="comment"># src/scaletrade/infrastructure/database/migrations/env.py</span>
<span class="keyword">import</span> asyncio
<span class="keyword">from</span> logging.config <span class="keyword">import</span> fileConfig

<span class="keyword">from</span> alembic <span class="keyword">import</span> context
<span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> pool
<span class="keyword">from</span> sqlalchemy.ext.asyncio <span class="keyword">import</span> async_engine_from_config

<span class="keyword">from</span> scaletrade.infrastructure.database.models <span class="keyword">import</span> Base
<span class="keyword">from</span> scaletrade.core.config <span class="keyword">import</span> settings

config = context.config
config.set_main_option(<span class="string">"sqlalchemy.url"</span>, settings.database_url)

target_metadata = Base.metadata


<span class="keyword">def</span> <span class="function">run_migrations_offline</span>() -> <span class="keyword">None</span>:
    <span class="string">"""Run migrations in 'offline' mode."""</span>
    url = config.get_main_option(<span class="string">"sqlalchemy.url"</span>)
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=<span class="keyword">True</span>,
        dialect_opts={<span class="string">"paramstyle"</span>: <span class="string">"named"</span>},
    )

    <span class="keyword">with</span> context.begin_transaction():
        context.run_migrations()


<span class="keyword">def</span> <span class="function">do_run_migrations</span>(connection) -> <span class="keyword">None</span>:
    context.configure(
        connection=connection,
        target_metadata=target_metadata,
    )

    <span class="keyword">with</span> context.begin_transaction():
        context.run_migrations()


<span class="keyword">async def</span> <span class="function">run_async_migrations</span>() -> <span class="keyword">None</span>:
    <span class="string">"""Run migrations in 'online' mode with async engine."""</span>
    connectable = async_engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix=<span class="string">"sqlalchemy."</span>,
        poolclass=pool.NullPool,
    )

    <span class="keyword">async with</span> connectable.connect() <span class="keyword">as</span> connection:
        <span class="keyword">await</span> connection.run_sync(do_run_migrations)

    <span class="keyword">await</span> connectable.dispose()


<span class="keyword">def</span> <span class="function">run_migrations_online</span>() -> <span class="keyword">None</span>:
    <span class="string">"""Run migrations in 'online' mode."""</span>
    asyncio.run(run_async_migrations())


<span class="keyword">if</span> context.is_offline_mode():
    run_migrations_offline()
<span class="keyword">else</span>:
    run_migrations_online()</code></pre>

                <h2>Lock Timeout: –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è</h2>

<pre><code><span class="comment"># src/scaletrade/infrastructure/database/migrations/versions/001_add_email_verified.py</span>
<span class="string">"""Add email_verified column

Revision ID: 001
Create Date: 2024-01-15 10:00:00
"""</span>
<span class="keyword">from</span> alembic <span class="keyword">import</span> op
<span class="keyword">import</span> sqlalchemy <span class="keyword">as</span> sa

revision = <span class="string">"001"</span>
down_revision = <span class="keyword">None</span>
branch_labels = <span class="keyword">None</span>
depends_on = <span class="keyword">None</span>

<span class="comment"># –¢–∞–π–º–∞—É—Ç –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ ‚Äî 5 —Å–µ–∫—É–Ω–¥</span>
<span class="comment"># –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ –∑–∞ 5—Å ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–∫–∞—Ç–∏—Ç—Å—è</span>
LOCK_TIMEOUT = <span class="string">"5s"</span>


<span class="keyword">def</span> <span class="function">upgrade</span>() -> <span class="keyword">None</span>:
    <span class="comment"># –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç</span>
    op.execute(f<span class="string">"SET lock_timeout = '{LOCK_TIMEOUT}'"</span>)
    
    <span class="comment"># –®–∞–≥ 1: –¥–æ–±–∞–≤–ª—è–µ–º nullable –∫–æ–ª–æ–Ω–∫—É (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)</span>
    op.add_column(
        <span class="string">"users"</span>,
        sa.Column(<span class="string">"email_verified"</span>, sa.Boolean(), nullable=<span class="keyword">True</span>),
    )
    
    <span class="comment"># –®–∞–≥ 2: –∑–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ (–±–∞—Ç—á–∞–º–∏, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å)</span>
    <span class="comment"># –í production —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–∫—Ä–∏–ø—Ç–æ–º</span>
    op.execute(<span class="string">"UPDATE users SET email_verified = false WHERE email_verified IS NULL"</span>)
    
    <span class="comment"># –®–∞–≥ 3: —Å—Ç–∞–≤–∏–º NOT NULL</span>
    op.alter_column(
        <span class="string">"users"</span>,
        <span class="string">"email_verified"</span>,
        nullable=<span class="keyword">False</span>,
        server_default=sa.text(<span class="string">"false"</span>),
    )


<span class="keyword">def</span> <span class="function">downgrade</span>() -> <span class="keyword">None</span>:
    op.drop_column(<span class="string">"users"</span>, <span class="string">"email_verified"</span>)</code></pre>

                <h2>Expand-Contract Pattern</h2>
                
                <p>
                    –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –±–µ–∑ –ø—Ä–æ—Å—Ç–æ—è ‚Äî –≤ 3 —ç—Ç–∞–ø–∞:
                </p>

<pre><code><span class="comment"># Expand: –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É</span>
<span class="string">"""001_expand_add_full_name"""</span>

<span class="keyword">def</span> <span class="function">upgrade</span>() -> <span class="keyword">None</span>:
    <span class="comment"># 1. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É</span>
    op.add_column(
        <span class="string">"users"</span>,
        sa.Column(<span class="string">"full_name"</span>, sa.String(<span class="number">255</span>), nullable=<span class="keyword">True</span>),
    )
    
    <span class="comment"># 2. –°–æ–∑–¥–∞—ë–º —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</span>
    op.execute(<span class="string">"""
        CREATE OR REPLACE FUNCTION sync_user_name() 
        RETURNS TRIGGER AS $$
        BEGIN
            IF NEW.name IS NOT NULL AND NEW.full_name IS NULL THEN
                NEW.full_name := NEW.name;
            ELSIF NEW.full_name IS NOT NULL AND NEW.name IS NULL THEN
                NEW.name := NEW.full_name;
            END IF;
            RETURN NEW;
        END;
        $$ LANGUAGE plpgsql;
        
        CREATE TRIGGER sync_user_name_trigger
        BEFORE INSERT OR UPDATE ON users
        FOR EACH ROW EXECUTE FUNCTION sync_user_name();
    """</span>)</code></pre>

<pre><code><span class="comment"># Migrate: –∑–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ (background job)</span>
<span class="string">"""002_migrate_names"""</span>

<span class="keyword">def</span> <span class="function">upgrade</span>() -> <span class="keyword">None</span>:
    <span class="comment"># –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –±–∞—Ç—á–∞–º–∏</span>
    op.execute(<span class="string">"""
        UPDATE users 
        SET full_name = name 
        WHERE full_name IS NULL 
        AND id IN (
            SELECT id FROM users 
            WHERE full_name IS NULL 
            LIMIT 10000
        )
    """</span>)
    <span class="comment"># –ü–æ–≤—Ç–æ—Ä—è—Ç—å –ø–æ–∫–∞ –≤—Å–µ –Ω–µ —Å–∫–æ–ø–∏—Ä—É—é—Ç—Å—è</span></code></pre>

<pre><code><span class="comment"># Contract: —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–æ–ª–æ–Ω–∫—É</span>
<span class="string">"""003_contract_drop_name"""</span>

<span class="keyword">def</span> <span class="function">upgrade</span>() -> <span class="keyword">None</span>:
    <span class="comment"># 1. –£–¥–∞–ª—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä</span>
    op.execute(<span class="string">"DROP TRIGGER IF EXISTS sync_user_name_trigger ON users"</span>)
    op.execute(<span class="string">"DROP FUNCTION IF EXISTS sync_user_name"</span>)
    
    <span class="comment"># 2. –°—Ç–∞–≤–∏–º NOT NULL –Ω–∞ –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É</span>
    op.alter_column(<span class="string">"users"</span>, <span class="string">"full_name"</span>, nullable=<span class="keyword">False</span>)
    
    <span class="comment"># 3. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–æ–ª–æ–Ω–∫—É</span>
    op.drop_column(<span class="string">"users"</span>, <span class="string">"name"</span>)</code></pre>

                <h2>CREATE INDEX CONCURRENTLY</h2>

<pre><code><span class="comment"># –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</span>
<span class="string">"""004_add_email_index"""</span>

<span class="keyword">from</span> alembic <span class="keyword">import</span> op


<span class="keyword">def</span> <span class="function">upgrade</span>() -> <span class="keyword">None</span>:
    <span class="comment"># CONCURRENTLY –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</span>
    op.execute(<span class="string">"COMMIT"</span>)
    
    op.create_index(
        <span class="string">"ix_users_email_lower"</span>,
        <span class="string">"users"</span>,
        [sa.text(<span class="string">"lower(email)"</span>)],
        unique=<span class="keyword">True</span>,
        postgresql_concurrently=<span class="keyword">True</span>,
    )


<span class="keyword">def</span> <span class="function">downgrade</span>() -> <span class="keyword">None</span>:
    op.execute(<span class="string">"COMMIT"</span>)
    op.drop_index(
        <span class="string">"ix_users_email_lower"</span>,
        table_name=<span class="string">"users"</span>,
        postgresql_concurrently=<span class="keyword">True</span>,
    )</code></pre>

                <h2>ADD CONSTRAINT NOT VALID</h2>

<pre><code><span class="comment"># –î–æ–±–∞–≤–ª–µ–Ω–∏–µ FK –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</span>
<span class="string">"""005_add_fk_orders_users"""</span>


<span class="keyword">def</span> <span class="function">upgrade</span>() -> <span class="keyword">None</span>:
    <span class="comment"># –®–∞–≥ 1: —Å–æ–∑–¥–∞—ë–º constraint NOT VALID (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)</span>
    op.execute(<span class="string">"""
        ALTER TABLE orders
        ADD CONSTRAINT fk_orders_user_id
        FOREIGN KEY (user_id) REFERENCES users(id)
        NOT VALID
    """</span>)
    
    <span class="comment"># –®–∞–≥ 2: –≤–∞–ª–∏–¥–∏—Ä—É–µ–º (ShareUpdateExclusiveLock ‚Äî –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å—å)</span>
    op.execute(<span class="string">"""
        ALTER TABLE orders
        VALIDATE CONSTRAINT fk_orders_user_id
    """</span>)</code></pre>

                <h2>CI/CD: –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π</h2>

<pre><code><span class="comment"># .github/workflows/migrations.yml</span>
name: Check Migrations

on:
  pull_request:
    paths:
      - <span class="string">'src/**/migrations/**'</span>

jobs:
  check:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: <span class="string">"3.11"</span>
      
      - name: Install dependencies
        run: pip install alembic psycopg2-binary sqlalchemy
      
      - name: Run migrations
        run: alembic upgrade head
        env:
          DATABASE_URL: postgresql://postgres:test@localhost/postgres
      
      - name: Check for pending migrations
        run: |
          alembic check
          <span class="comment"># –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî fail</span></code></pre>

                <h2>ü™® –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏</h2>
                <div class="accordion">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>1. –ò–º–ø–æ—Ä—Ç –∫–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–µ–ª–∞–π—Ç–µ <code>from src.models import User</code> –≤–Ω—É—Ç—Ä–∏ —Ñ–∞–π–ª–∞ –º–∏–≥—Ä–∞—Ü–∏–∏. –í–∞—à –∫–æ–¥ –º–µ–Ω—è–µ—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º (–ø–æ–ª—è —É–¥–∞–ª—è—é—Ç—Å—è, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—é—Ç—Å—è), –∞ –º–∏–≥—Ä–∞—Ü–∏—è ‚Äî —ç—Ç–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Å–ª–µ–ø–æ–∫. –ß–µ—Ä–µ–∑ –º–µ—Å—è—Ü —ç—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è —É–ø–∞–¥–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤ <code>User</code> —É–∂–µ –Ω–µ—Ç –ø–æ–ª—è, –∫–æ—Ç–æ—Ä–æ–µ –æ–∂–∏–¥–∞–µ—Ç —Å—Ç–∞—Ä–∞—è –º–∏–≥—Ä–∞—Ü–∏—è.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ —Å <code>DEFAULT</code> –∑–Ω–∞—á–µ–Ω–∏–µ–º –≤ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö Postgres (–¥–æ 11) –≤—ã–∑—ã–≤–∞–ª–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã –∏ –¥–æ–ª–≥—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É. –î–∞–∂–µ –≤ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö —Å–ª–æ–∂–Ω—ã–µ <code>ALTER TABLE</code> –º–æ–≥—É—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥. –í—Å–µ–≥–¥–∞ —Å—Ç–∞–≤—å—Ç–µ <code>lock_timeout</code> –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º DDL.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>3. –í–µ—Ç–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–π</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ï—Å–ª–∏ –¥–≤–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–∑–¥–∞–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –æ—Ç –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ —Ä–µ–≤–∏–∑–∏–∏, Alembic –Ω–µ –¥–∞—Å—Ç –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Ö (Multiple heads). –≠—Ç–æ —à—Ç–∞—Ç–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>alembic merge heads -m "merge"</code> –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ—á–∫–∏ —Å–ª–∏—è–Ω–∏—è.</p>
                        </div>
                    </div>
                </div>

                <h2>üí° –õ–∞–π—Ñ—Ö–∞–∫–∏</h2>
                <ul>
                    <li><strong>lock_timeout:</strong> –í—Å—Ç–∞–≤—å—Ç–µ <code>op.execute("SET lock_timeout TO '2s'")</code> –≤ –Ω–∞—á–∞–ª–æ —Ç—è–∂–µ–ª–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏. –ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Å–º–æ–∂–µ—Ç –≤–∑—è—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã (–ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–∞–±–ª–∏—Ü—É –∫—Ç–æ-—Ç–æ —á–∏—Ç–∞–µ—Ç), –æ–Ω–∞ —É–ø–∞–¥–µ—Ç —Å –æ—à–∏–±–∫–æ–π, –Ω–æ –ù–ï –ø–æ–¥–≤–µ—Å–∏—Ç –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏.</li>
                    <li><strong>downgrade:</strong> –í —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏ <code>downgrade</code> –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—Ä–∞–π–Ω–µ —Ä–µ–¥–∫–æ. –ü—Ä–æ—â–µ –Ω–∞–∫–∞—Ç–∏—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è "—Ñ–∏–∫c–∏—Ç" –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è, —á–µ–º –ø—ã—Ç–∞—Ç—å—Å—è –æ—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ç–æ—Ä –Ω–∞–∑–∞–¥.</li>
                    <li><strong>Raw SQL:</strong> –ò–Ω–æ–≥–¥–∞ –ø—Ä–æ—â–µ –Ω–∞–ø–∏—Å–∞—Ç—å SQL —Ä—É–∫–∞–º–∏: <code>op.execute("CREATE UNIQUE INDEX ...")</code>, —á–µ–º –ø—ã—Ç–∞—Ç—å—Å—è –≤—ã—Ä–∞–∑–∏—Ç—å —ç—Ç–æ —á–µ—Ä–µ–∑ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ Alembic, –æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤.</li>
                </ul>

                <div class="task-box">
                    <h4>üìã –ó–∞–¥–∞–Ω–∏–µ</h4>
                    <ul class="task-list">
                        <li>–ù–∞—Å—Ç—Ä–æ–π Alembic —Å async –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</li>
                        <li>–î–æ–±–∞–≤—å lock_timeout –≤–æ –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏</li>
                        <li>–†–µ–∞–ª–∏–∑—É–π Expand-Contract –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏</li>
                        <li>–°–æ–∑–¥–∞–π –∏–Ω–¥–µ–∫—Å —Å CONCURRENTLY</li>
                        <li>–î–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä–∫—É –º–∏–≥—Ä–∞—Ü–∏–π –≤ CI</li>
                    </ul>
                </div>

                <div class="nav-footer">
                    <a href="part5_clickhouse.html">
                        <div>
                            <div class="nav-label">–ù–∞–∑–∞–¥</div>
                            <div class="nav-title">‚Üê 5.2 ClickHouse</div>
                        </div>
                    </a>
                    <a href="part6_quality.html">
                        <div>
                            <div class="nav-label">–î–∞–ª–µ–µ</div>
                            <div class="nav-title">6.2 Code Quality ‚Üí</div>
                        </div>
                    </a>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
