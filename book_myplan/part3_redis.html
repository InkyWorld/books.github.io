<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3.2 Redis Patterns ‚Äî ScaleTrade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="book-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üìà</div>
                    <span>ScaleTrade</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">–í–≤–µ–¥–µ–Ω–∏–µ</div>
                    <a href="index.html" class="nav-link"><span class="nav-link-icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="setup.html" class="nav-link"><span class="nav-link-icon">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 1: PostgreSQL</div>
                    <a href="part1_schema.html" class="nav-link"><span class="nav-link-icon">üìä</span>1.1 –°—Ö–µ–º–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ</a>
                    <a href="part1_transactions.html" class="nav-link"><span class="nav-link-icon">üîÑ</span>1.2 –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</a>
                    <a href="part1_indexes.html" class="nav-link"><span class="nav-link-icon">üîç</span>1.3 –ò–Ω–¥–µ–∫—Å—ã</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</div>
                    <a href="part2_litestar.html" class="nav-link"><span class="nav-link-icon">üöÄ</span>2.1 Litestar + DDD</a>
                    <a href="part2_dishka.html" class="nav-link"><span class="nav-link-icon">üíâ</span>2.2 DI —Å Dishka</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 3: –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ</div>
                    <a href="part3_faststream.html" class="nav-link"><span class="nav-link-icon">üì®</span>3.1 RabbitMQ + Faststream</a>
                    <a href="part3_redis.html" class="nav-link active"><span class="nav-link-icon">‚ö°</span>3.2 Redis Patterns</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 4: –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å</div>
                    <a href="part4_testing.html" class="nav-link"><span class="nav-link-icon">üß™</span>4.1 Advanced Testing</a>
                    <a href="part4_resiliency.html" class="nav-link"><span class="nav-link-icon">üõ°Ô∏è</span>4.2 Resiliency</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 5: Observability</div>
                    <a href="part5_logging.html" class="nav-link"><span class="nav-link-icon">üìù</span>5.1 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</a>
                    <a href="part5_clickhouse.html" class="nav-link"><span class="nav-link-icon">üìà</span>5.2 ClickHouse</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 6: Production</div>
                    <a href="part6_migrations.html" class="nav-link"><span class="nav-link-icon">üîÄ</span>6.1 Zero-Downtime</a>
                    <a href="part6_quality.html" class="nav-link"><span class="nav-link-icon">‚úÖ</span>6.2 Code Quality</a>
                    <a href="part6_django.html" class="nav-link"><span class="nav-link-icon">üîó</span>6.3 Django Admin</a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="breadcrumb">
                    <a href="index.html">ScaleTrade</a>
                    <span>/</span>
                    <span>–ß–∞—Å—Ç—å 3</span>
                    <span>/</span>
                    <span>3.2 Redis Patterns</span>
                </div>
            </header>

            <div class="page-content">
                <h1>–ú–æ–¥—É–ª—å 3.2: Redis Patterns</h1>
                <p class="lead">
                    –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, Lua —Å–∫—Ä–∏–ø—Ç—ã, Rate Limiting ‚Äî 
                    –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –≤ distributed —Å–∏—Å—Ç–µ–º–∞—Ö.
                </p>

                <h2>Redis –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ</h2>
                
                <p>Redis –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:</p>
                <ul>
                    <li><strong>–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> –ì–æ—Ä—è—á–∏–µ –¥–∞–Ω–Ω—ã–µ, —Å–µ—Å—Å–∏–∏</li>
                    <li><strong>Distributed Locks:</strong> –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏</li>
                    <li><strong>Rate Limiting:</strong> –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏</li>
                    <li><strong>Pub/Sub:</strong> Real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</li>
                    <li><strong>Leaderboard:</strong> Sorted Sets –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–æ–≤</li>
                </ul>

                <h2>Distributed Locks (Redlock)</h2>
                
                <p>
                    <strong>–ó–∞–¥–∞—á–∞:</strong> –ù–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ—Ä–¥–µ—Ä–∞. 
                    –ù—É–∂–Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –æ–¥–∏–Ω –æ—Ä–¥–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º –∏–Ω—Å—Ç–∞–Ω—Å–æ–º.
                </p>

<pre><code><span class="comment"># src/scaletrade/infrastructure/cache/distributed_lock.py</span>
<span class="keyword">import</span> uuid
<span class="keyword">from</span> contextlib <span class="keyword">import</span> asynccontextmanager
<span class="keyword">from</span> typing <span class="keyword">import</span> AsyncIterator

<span class="keyword">from</span> redis.asyncio <span class="keyword">import</span> Redis


<span class="keyword">class</span> <span class="class-name">DistributedLock</span>:
    <span class="string">"""
    –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ Redis.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç SET NX EX –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –∑–∞—Ö–≤–∞—Ç–∞.
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Lua —Å–∫—Ä–∏–ø—Ç.
    """</span>
    
    <span class="comment"># Lua —Å–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è</span>
    <span class="comment"># –£–¥–∞–ª—è–µ—Ç –∫–ª—é—á –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç</span>
    RELEASE_SCRIPT = <span class="string">"""
    if redis.call("get", KEYS[1]) == ARGV[1] then
        return redis.call("del", KEYS[1])
    else
        return 0
    end
    """</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(
        self, 
        redis: Redis, 
        name: <span class="type">str</span>, 
        timeout: <span class="type">int</span> = <span class="number">30</span>
    ) -> <span class="keyword">None</span>:
        self._redis = redis
        self._name = <span class="string">f"lock:</span>{name}<span class="string">"</span>
        self._timeout = timeout
        self._token = uuid.uuid4().hex
    
    <span class="keyword">async def</span> <span class="function">acquire</span>(self) -> <span class="type">bool</span>:
        <span class="string">"""
        –ü–æ–ø—ã—Ç–∫–∞ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É.
        
        SET NX ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        EX ‚Äî TTL –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–∑–∞—â–∏—Ç–∞ –æ—Ç deadlock)
        """</span>
        result = <span class="keyword">await</span> self._redis.set(
            self._name,
            self._token,
            nx=<span class="keyword">True</span>,    <span class="comment"># Not eXists</span>
            ex=self._timeout,
        )
        <span class="keyword">return</span> result <span class="keyword">is True</span>
    
    <span class="keyword">async def</span> <span class="function">release</span>(self) -> <span class="type">bool</span>:
        <span class="string">"""
        –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.
        
        –ò—Å–ø–æ–ª—å–∑—É–µ–º Lua —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏:
        –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –≤ –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.
        """</span>
        result = <span class="keyword">await</span> self._redis.eval(
            self.RELEASE_SCRIPT,
            <span class="number">1</span>,  <span class="comment"># –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π</span>
            self._name,
            self._token,
        )
        <span class="keyword">return</span> result == <span class="number">1</span>
    
    <span class="decorator">@asynccontextmanager</span>
    <span class="keyword">async def</span> <span class="function">hold</span>(self) -> AsyncIterator[<span class="type">bool</span>]:
        <span class="string">"""Context manager –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è."""</span>
        acquired = <span class="keyword">await</span> self.acquire()
        <span class="keyword">try</span>:
            <span class="keyword">yield</span> acquired
        <span class="keyword">finally</span>:
            <span class="keyword">if</span> acquired:
                <span class="keyword">await</span> self.release()</code></pre>

                <h3>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</h3>

<pre><code><span class="comment"># –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ä–¥–µ—Ä–∞ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π</span>
<span class="keyword">async def</span> <span class="function">process_order</span>(order_id: <span class="type">str</span>, redis: Redis) -> <span class="keyword">None</span>:
    lock = DistributedLock(redis, <span class="string">f"order:</span>{order_id}<span class="string">"</span>, timeout=<span class="number">60</span>)
    
    <span class="keyword">async with</span> lock.hold() <span class="keyword">as</span> acquired:
        <span class="keyword">if not</span> acquired:
            logger.warning(<span class="string">f"Order {order_id} is being processed by another instance"</span>)
            <span class="keyword">return</span>
        
        <span class="comment"># –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º</span>
        order = <span class="keyword">await</span> get_order(order_id)
        <span class="keyword">await</span> execute_order(order)</code></pre>

                <h2>Lua Scripting: –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>
                
                <p>
                    Lua —Å–∫—Ä–∏–ø—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ. Redis –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, 
                    —á—Ç–æ –Ω–∏–∫–∞–∫–∏–µ –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Å–∫—Ä–∏–ø—Ç–∞.
                </p>

                <h3>Rate Limiter (Token Bucket)</h3>

<pre><code><span class="comment"># src/scaletrade/infrastructure/cache/rate_limiter.py</span>
<span class="keyword">from</span> redis.asyncio <span class="keyword">import</span> Redis


<span class="keyword">class</span> <span class="class-name">TokenBucketRateLimiter</span>:
    <span class="string">"""
    Rate Limiter –Ω–∞ –æ—Å–Ω–æ–≤–µ Token Bucket.
    
    - Bucket –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–∫–µ–Ω–∞–º–∏ —Å –∑–∞–¥–∞–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é
    - –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∑–∞–±–∏—Ä–∞–µ—Ç —Ç–æ–∫–µ–Ω
    - –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–µ—Ç ‚Äî –æ—Ç–∫–∞–∑
    """</span>
    
    <span class="comment"># Lua —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ rate limiting</span>
    SCRIPT = <span class="string">"""
    local key = KEYS[1]
    local capacity = tonumber(ARGV[1])     -- –ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤
    local refill_rate = tonumber(ARGV[2])  -- –¢–æ–∫–µ–Ω–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
    local now = tonumber(ARGV[3])          -- –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è (ms)
    local requested = tonumber(ARGV[4])    -- –°–∫–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω–æ–≤ –Ω—É–∂–Ω–æ
    
    -- –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    local data = redis.call("HMGET", key, "tokens", "last_refill")
    local tokens = tonumber(data[1]) or capacity
    local last_refill = tonumber(data[2]) or now
    
    -- –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–æ–±–∞–≤–∏–ª–æ—Å—å
    local elapsed = (now - last_refill) / 1000
    local refilled = elapsed * refill_rate
    tokens = math.min(capacity, tokens + refilled)
    
    -- –ü—Ä–æ–±—É–µ–º –∑–∞–±—Ä–∞—Ç—å —Ç–æ–∫–µ–Ω—ã
    local allowed = 0
    if tokens >= requested then
        tokens = tokens - requested
        allowed = 1
    end
    
    -- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    redis.call("HMSET", key, "tokens", tokens, "last_refill", now)
    redis.call("EXPIRE", key, 3600)  -- TTL 1 —á–∞—Å
    
    return {allowed, math.floor(tokens)}
    """</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(
        self,
        redis: Redis,
        capacity: <span class="type">int</span> = <span class="number">100</span>,
        refill_rate: <span class="type">float</span> = <span class="number">10.0</span>,  <span class="comment"># —Ç–æ–∫–µ–Ω–æ–≤/—Å–µ–∫</span>
    ) -> <span class="keyword">None</span>:
        self._redis = redis
        self._capacity = capacity
        self._refill_rate = refill_rate
        self._script = self._redis.register_script(self.SCRIPT)
    
    <span class="keyword">async def</span> <span class="function">is_allowed</span>(
        self, 
        key: <span class="type">str</span>, 
        tokens: <span class="type">int</span> = <span class="number">1</span>
    ) -> <span class="keyword">tuple</span>[<span class="type">bool</span>, <span class="type">int</span>]:
        <span class="string">"""
        –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–∑—Ä–µ—à—ë–Ω –ª–∏ –∑–∞–ø—Ä–æ—Å.
        
        Returns:
            (allowed, remaining_tokens)
        """</span>
        <span class="keyword">import</span> time
        now_ms = <span class="type">int</span>(time.time() * <span class="number">1000</span>)
        
        result = <span class="keyword">await</span> self._script(
            keys=[<span class="string">f"ratelimit:</span>{key}<span class="string">"</span>],
            args=[self._capacity, self._refill_rate, now_ms, tokens],
        )
        
        <span class="keyword">return</span> <span class="type">bool</span>(result[<span class="number">0</span>]), <span class="type">int</span>(result[<span class="number">1</span>])</code></pre>

                <h3>Rate Limiter Middleware</h3>

<pre><code><span class="comment"># src/scaletrade/interface/middleware/rate_limit.py</span>
<span class="keyword">from</span> litestar <span class="keyword">import</span> Request
<span class="keyword">from</span> litestar.middleware <span class="keyword">import</span> AbstractMiddleware
<span class="keyword">from</span> litestar.exceptions <span class="keyword">import</span> TooManyRequestsException


<span class="keyword">class</span> <span class="class-name">RateLimitMiddleware</span>(AbstractMiddleware):
    <span class="keyword">async def</span> <span class="function">__call__</span>(self, request: Request, call_next):
        <span class="comment"># –ü–æ–ª—É—á–∞–µ–º rate limiter –∏–∑ DI</span>
        limiter = request.app.state.rate_limiter
        
        <span class="comment"># –ö–ª—é—á ‚Äî IP –∏–ª–∏ user_id</span>
        user_id = request.user.id <span class="keyword">if</span> request.user <span class="keyword">else</span> request.client.host
        key = <span class="string">f"api:</span>{user_id}<span class="string">"</span>
        
        allowed, remaining = <span class="keyword">await</span> limiter.is_allowed(key)
        
        <span class="keyword">if not</span> allowed:
            <span class="keyword">raise</span> TooManyRequestsException(
                detail=<span class="string">"Rate limit exceeded. Try again later."</span>,
                headers={<span class="string">"X-RateLimit-Remaining"</span>: <span class="type">str</span>(remaining)},
            )
        
        response = <span class="keyword">await</span> call_next(request)
        response.headers[<span class="string">"X-RateLimit-Remaining"</span>] = <span class="type">str</span>(remaining)
        <span class="keyword">return</span> response</code></pre>

                <h2>Pipelining: –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>
                
                <p>
                    –ë–µ–∑ pipelining: N –æ–ø–µ—Ä–∞—Ü–∏–π = N round-trip –¥–æ Redis.<br>
                    –° pipelining: N –æ–ø–µ—Ä–∞—Ü–∏–π = 1 round-trip.
                </p>

<pre><code><span class="comment"># –ë–µ–∑ pipelining (–º–µ–¥–ª–µ–Ω–Ω–æ)</span>
<span class="keyword">for</span> user_id <span class="keyword">in</span> user_ids:
    <span class="keyword">await</span> redis.get(<span class="string">f"user:</span>{user_id}<span class="string">"</span>)  <span class="comment"># 100 –∑–∞–ø—Ä–æ—Å–æ–≤ = 100 RTT</span>

<span class="comment"># –° pipelining (–±—ã—Å—Ç—Ä–æ)</span>
<span class="keyword">async with</span> redis.pipeline() <span class="keyword">as</span> pipe:
    <span class="keyword">for</span> user_id <span class="keyword">in</span> user_ids:
        pipe.get(<span class="string">f"user:</span>{user_id}<span class="string">"</span>)
    results = <span class="keyword">await</span> pipe.execute()  <span class="comment"># 1 RTT!</span></code></pre>

                <h3>Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∫–µ—à–∞</h3>

<pre><code><span class="comment"># src/scaletrade/infrastructure/cache/user_cache.py</span>
<span class="keyword">class</span> <span class="class-name">UserCache</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(self, redis: Redis) -> <span class="keyword">None</span>:
        self._redis = redis
        self._ttl = <span class="number">3600</span>
    
    <span class="keyword">async def</span> <span class="function">get_many</span>(self, user_ids: <span class="type">list</span>[<span class="type">int</span>]) -> <span class="type">dict</span>[<span class="type">int</span>, User | <span class="keyword">None</span>]:
        <span class="string">"""–ü–æ–ª—É—á–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º."""</span>
        <span class="keyword">if not</span> user_ids:
            <span class="keyword">return</span> {}
        
        keys = [<span class="string">f"user:</span>{uid}<span class="string">"</span> <span class="keyword">for</span> uid <span class="keyword">in</span> user_ids]
        values = <span class="keyword">await</span> self._redis.mget(keys)
        
        result = {}
        <span class="keyword">for</span> uid, value <span class="keyword">in</span> <span class="function">zip</span>(user_ids, values):
            <span class="keyword">if</span> value:
                result[uid] = User.model_validate_json(value)
            <span class="keyword">else</span>:
                result[uid] = <span class="keyword">None</span>
        
        <span class="keyword">return</span> result
    
    <span class="keyword">async def</span> <span class="function">set_many</span>(self, users: <span class="type">dict</span>[<span class="type">int</span>, User]) -> <span class="keyword">None</span>:
        <span class="string">"""–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º."""</span>
        <span class="keyword">async with</span> self._redis.pipeline() <span class="keyword">as</span> pipe:
            <span class="keyword">for</span> uid, user <span class="keyword">in</span> users.items():
                pipe.setex(
                    <span class="string">f"user:</span>{uid}<span class="string">"</span>,
                    self._ttl,
                    user.model_dump_json(),
                )
            <span class="keyword">await</span> pipe.execute()</code></pre>

                <h2>Cache-Aside Pattern</h2>

<pre><code><span class="comment"># src/scaletrade/application/services/user_service.py</span>
<span class="keyword">class</span> <span class="class-name">UserService</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(self, uow: UnitOfWork, cache: UserCache) -> <span class="keyword">None</span>:
        self._uow = uow
        self._cache = cache
    
    <span class="keyword">async def</span> <span class="function">get_user</span>(self, user_id: <span class="type">int</span>) -> User:
        <span class="string">"""
        Cache-Aside:
        1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
        2. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏–¥—ë–º –≤ –ë–î
        3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
        """</span>
        <span class="comment"># 1. –ü—Ä–æ–±—É–µ–º –∫–µ—à</span>
        cached = <span class="keyword">await</span> self._cache.get(user_id)
        <span class="keyword">if</span> cached:
            <span class="keyword">return</span> cached
        
        <span class="comment"># 2. –ò–¥—ë–º –≤ –ë–î</span>
        <span class="keyword">async with</span> self._uow:
            user = <span class="keyword">await</span> self._uow.users.get_by_id(user_id)
            <span class="keyword">if</span> user <span class="keyword">is None</span>:
                <span class="keyword">raise</span> UserNotFoundError(user_id)
        
        <span class="comment"># 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à</span>
        <span class="keyword">await</span> self._cache.set(user_id, user)
        
        <span class="keyword">return</span> user
    
    <span class="keyword">async def</span> <span class="function">update_user</span>(self, user_id: <span class="type">int</span>, data: UpdateUserDTO) -> User:
        <span class="string">"""–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ ‚Äî –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à."""</span>
        <span class="keyword">async with</span> self._uow:
            user = <span class="keyword">await</span> self._uow.users.get_by_id(user_id)
            user.update(data)
            <span class="keyword">await</span> self._uow.commit()
        
        <span class="comment"># –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à</span>
        <span class="keyword">await</span> self._cache.delete(user_id)
        
        <span class="keyword">return</span> user</code></pre>

                <h2>ü™® –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏</h2>
                <div class="accordion">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>1. –ö–æ–º–∞–Ω–¥–∞ KEYS *</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>KEYS *</code> –≤ –ø—Ä–æ–¥–µ. Redis ‚Äî –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω—ã–π. –ü–æ–∫–∞ –æ–Ω —Å–∫–∞–Ω–∏—Ä—É–µ—Ç 10 –º–ª–Ω –∫–ª—é—á–µ–π, –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∂–¥—É—Ç. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Å—Ç–∞–Ω–µ—Ç –∫–æ–ª–æ–º. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—É—Ä—Å–æ—Ä—ã: <code>SCAN</code>.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>2. Big Keys</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ï—Å–ª–∏ –≤ —Ö–µ—à–µ –∏–ª–∏ —Å–ø–∏—Å–∫–µ –º–∏–ª–ª–∏–æ–Ω —ç–ª–µ–º–µ–Ω—Ç–æ–≤, —É–¥–∞–ª–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –∫–ª—é—á–∞ (DEL) –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç Redis –Ω–∞ —Å–µ–∫—É–Ω–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>UNLINK</code> (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ) –∏ –∏–∑–±–µ–≥–∞–π—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–∫–∏—Ö –º–æ–Ω—Å—Ç—Ä–æ–≤.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>3. Redis –∫–∞–∫ –ë–î</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ –≤ Redis –¥–∞–Ω–Ω—ã–µ, –ø–æ—Ç–µ—Ä—è –∫–æ—Ç–æ—Ä—ã—Ö –∫—Ä–∏—Ç–∏—á–Ω–∞, –µ—Å–ª–∏ –≤—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ AOF —Å <code>fsync everysec</code> (–∏ –¥–∞–∂–µ —Ç–∞–∫ –µ—Å—Ç—å —Ä–∏—Å–∫). Redis –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å, –∞ –Ω–µ –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –∫–∞–∫ –∫—ç—à –∏–ª–∏ –æ—á–µ—Ä–µ–¥—å, –Ω–æ –Ω–µ –∫–∞–∫ Source of Truth.</p>
                        </div>
                    </div>
                </div>

                <h2>üí° –õ–∞–π—Ñ—Ö–∞–∫–∏</h2>
                <ul>
                    <li><strong>Naming Convention:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–≤–æ–µ—Ç–æ—á–∏—è –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏: <code>object_type:id:field</code> (–Ω–∞–ø—Ä–∏–º–µ—Ä, <code>user:100:settings</code>). –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω–∏–º–∞—é—Ç –º–Ω–æ–≥–∏–µ GUI –∫–ª–∏–µ–Ω—Ç—ã.</li>
                    <li><strong>–ö—ç—à —Å Jitter:</strong> –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ TTL –¥–æ–±–∞–≤–ª—è–π—Ç–µ —Å–ª—É—á–∞–π–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3600 ¬± 300 —Å–µ–∫). –≠—Ç–æ —Å–ø–∞—Å–µ—Ç –æ—Ç "Cache Stampede", –∫–æ–≥–¥–∞ —Ç—ã—Å—è—á–∏ –∫–ª—é—á–µ–π –ø—Ä–æ—Ç—É—Ö–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏ –±–∞–∑–∞ –ø–∞–¥–∞–µ—Ç –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π.</li>
                    <li><strong>–ê–Ω–∞–ª–∏–∑ –ø–∞–º—è—Ç–∏:</strong> –ó–∞–ø—É—Å—Ç–∏—Ç–µ <code>redis-cli --bigkeys</code> –∏–ª–∏ <code>--memkeys</code>, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –∫—Ç–æ —Å—ä–µ–ª –≤—Å—é –ø–∞–º—è—Ç—å.</li>
                </ul>

                <div class="task-box">
                    <h4>üìã –ó–∞–¥–∞–Ω–∏–µ</h4>
                    <ul class="task-list">
                        <li>–†–µ–∞–ª–∏–∑—É–π <code>DistributedLock</code> —Å Lua —Å–∫—Ä–∏–ø—Ç–æ–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ release</li>
                        <li>–°–æ–∑–¥–∞–π Rate Limiter —Å Token Bucket –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º</li>
                        <li>–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π Rate Limit middleware –≤ Litestar</li>
                        <li>–†–µ–∞–ª–∏–∑—É–π –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å Cache-Aside</li>
                        <li>–ù–∞–ø–∏—à–∏ —Ç–µ—Å—Ç, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∏–π —Ä–∞–±–æ—Ç—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</li>
                    </ul>
                </div>

                <div class="nav-footer">
                    <a href="part3_faststream.html">
                        <div>
                            <div class="nav-label">–ù–∞–∑–∞–¥</div>
                            <div class="nav-title">‚Üê 3.1 RabbitMQ + Faststream</div>
                        </div>
                    </a>
                    <a href="part4_testing.html">
                        <div>
                            <div class="nav-label">–î–∞–ª–µ–µ</div>
                            <div class="nav-title">4.1 Advanced Testing ‚Üí</div>
                        </div>
                    </a>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
