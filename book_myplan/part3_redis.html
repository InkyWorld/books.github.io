<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3.2 Redis Patterns ‚Äî ScaleTrade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="book-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üìà</div>
                    <span>ScaleTrade</span>
                </a>
            </div>
            <nav class="sidebar-nav">
    <div class="nav-section">
        <div class="nav-section-title">Intro</div>
        <a href="index.html" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
        <a href="setup.html" class="nav-link">üõ† Setup</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 0: Fundamentals</div>
        <a href="part0_internals.html" class="nav-link">0.1 Internals</a>
        <a href="part0_networking.html" class="nav-link">0.2 Networking</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 1: Postgres</div>
        <a href="part1_schema.html" class="nav-link">1.1 Schema</a>
        <a href="part1_indexes.html" class="nav-link">1.2 Indexes</a>
        <a href="part1_transactions.html" class="nav-link">1.3 Transactions</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 2: Litestar</div>
        <a href="part2_litestar.html" class="nav-link">2.1 Framework</a>
        <a href="part2_dishka.html" class="nav-link">2.2 DI (Dishka)</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 3: Brokers</div>
        <a href="part3_redis.html" class="nav-link active">3.1 Redis</a>
        <a href="part3_faststream.html" class="nav-link">3.2 FastStream</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 4: Quality</div>
        <a href="part4_testing.html" class="nav-link">4.1 Pytest</a>
        <a href="part4_resiliency.html" class="nav-link">4.2 Resilience</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 5: Observability</div>
        <a href="part5_clickhouse.html" class="nav-link">5.1 Clickhouse</a>
        <a href="part5_logging.html" class="nav-link">5.2 Structured Logs</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 6: Django</div>
        <a href="part6_django.html" class="nav-link">6.1 ORM</a>
        <a href="part6_migrations.html" class="nav-link">6.2 Migrations</a>
        <a href="part6_quality.html" class="nav-link">6.3 Quality</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 7: Microservices</div>
        <a href="part7_grpc.html" class="nav-link">7.1 gRPC</a>
        <a href="part7_graphql.html" class="nav-link">7.2 GraphQL</a>
        <a href="part7_federation.html" class="nav-link">7.3 Federation</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 8: Async</div>
        <a href="part8_asyncio.html" class="nav-link">8.1 Asyncio</a>
        <a href="part8_celery.html" class="nav-link">8.2 Celery</a>
        <a href="part8_dramatiq.html" class="nav-link">8.3 Dramatiq</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 9: API</div>
        <a href="part9_restdesign.html" class="nav-link">9.1 REST Design</a>
        <a href="part9_idempotency.html" class="nav-link">9.2 Idempotency</a>
        <a href="part9_openapi.html" class="nav-link">9.3 OpenAPI</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 10: Culture</div>
        <a href="part10_git.html" class="nav-link">10.1 Git</a>
        <a href="part10_commits.html" class="nav-link">10.2 Commits</a>
        <a href="part10_codereview.html" class="nav-link">10.3 Post-Review</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 11: Security</div>
        <a href="part11_oauth.html" class="nav-link">11.1 OAuth2</a>
        <a href="part11_vault.html" class="nav-link">11.2 Vault</a>
        <a href="part11_owasp.html" class="nav-link">11.3 OWASP</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 12: Kubernetes</div>
        <a href="part12_kubernetes.html" class="nav-link">12.1 K8s Basics</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 13: High Load</div>
        <a href="part13_profiling.html" class="nav-link">13.1 Profiling</a>
        <a href="part13_caching.html" class="nav-link">13.2 Caching</a>
        <a href="part13_loadbalancing.html" class="nav-link">13.3 Load Balancing</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 14: ML Ops</div>
        <a href="part14_mlflow.html" class="nav-link">14.1 MLflow</a>
        <a href="part14_embeddings.html" class="nav-link">14.2 Embeddings</a>
        <a href="part14_llm.html" class="nav-link">14.3 LLM</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 15: Debugging</div>
        <a href="part15_debugging.html" class="nav-link">15.1 Debugging</a>
        <a href="part15_postmortem.html" class="nav-link">15.2 Postmortem</a>
        <a href="part15_chaos.html" class="nav-link">15.3 Chaos Eng</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 16: DB Advanced</div>
        <a href="part16_indexes.html" class="nav-link">16.1 Indexes Deep</a>
        <a href="part16_isolation.html" class="nav-link">16.2 Isolation</a>
        <a href="part16_sharding.html" class="nav-link">16.3 Sharding</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 17: System Design</div>
        <a href="part17_circuit.html" class="nav-link">17.1 Circuit Breaker</a>
        <a href="part17_ratelimit.html" class="nav-link">17.2 Rate Limit</a>
        <a href="part17_distlock.html" class="nav-link">17.3 Dist Lock</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 18: Soft Skills</div>
        <a href="part18_estimation.html" class="nav-link">18.1 Estimation</a>
        <a href="part18_burnout.html" class="nav-link">18.2 Burnout</a>
        <a href="part18_interview.html" class="nav-link">18.3 Interview</a>
    </div>
</nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="breadcrumb">
                    <a href="index.html">ScaleTrade</a>
                    <span>/</span>
                    <span>–ß–∞—Å—Ç—å 3</span>
                    <span>/</span>
                    <span>3.2 Redis Patterns</span>
                </div>
            </header>

            <div class="page-content">
                <h1>–ú–æ–¥—É–ª—å 3.2: Redis Patterns</h1>
                <p class="lead">
                    –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, Lua —Å–∫—Ä–∏–ø—Ç—ã, Rate Limiting ‚Äî 
                    –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –≤ distributed —Å–∏—Å—Ç–µ–º–∞—Ö.
                </p>

                <h2>Redis –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ</h2>
                
                <p>Redis –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:</p>
                <ul>
                    <li><strong>–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> –ì–æ—Ä—è—á–∏–µ –¥–∞–Ω–Ω—ã–µ, —Å–µ—Å—Å–∏–∏</li>
                    <li><strong>Distributed Locks:</strong> –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏</li>
                    <li><strong>Rate Limiting:</strong> –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏</li>
                    <li><strong>Pub/Sub:</strong> Real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</li>
                    <li><strong>Leaderboard:</strong> Sorted Sets –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–æ–≤</li>
                    <li><strong>–°—á–µ—Ç—á–∏–∫–∏:</strong> –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç—ã (–ø—Ä–æ—Å–º–æ—Ç—Ä—ã, –ª–∞–π–∫–∏)</li>
                    <li><strong>–û—á–µ—Ä–µ–¥–∏:</strong> –ü—Ä–æ—Å—Ç—ã–µ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ List –∏–ª–∏ Streams</li>
                </ul>

                <h2>–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö Redis</h2>
                <p>Redis —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ Key-Value, —ç—Ç–æ —Å–µ—Ä–≤–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö. –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.</p>

                <div class="accordion">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>String (–°—Ç—Ä–æ–∫–∏)</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ë–∞–∑–æ–≤—ã–π —Ç–∏–ø. –ú–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç, —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π JSON, –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏–ª–∏ —á–∏—Å–ª–∞.</p>
                            <ul>
                                <li><code>SET key value</code> / <code>GET key</code></li>
                                <li><code>INCR counter</code> ‚Äî –∞—Ç–æ–º–∞—Ä–Ω—ã–π —Å—á–µ—Ç—á–∏–∫</li>
                                <li><code>SETNX key value</code> ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–±–∞–∑–∞ –¥–ª—è –ª–æ–∫–æ–≤)</li>
                            </ul>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>Hash (–•–µ—à–∏)</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ (User, Session). –ü–æ–∑–≤–æ–ª—è–µ—Ç —á–∏—Ç–∞—Ç—å –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è, –Ω–µ –≥–æ–Ω—è—è –≤–µ—Å—å JSON —Ç—É–¥–∞-—Å—é–¥–∞.</p>
                            <ul>
                                <li><code>HSET user:1 name "Alex" age 30</code></li>
                                <li><code>HGET user:1 name</code></li>
                                <li><code>HINCRBY user:1 age 1</code></li>
                            </ul>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>List (–°–ø–∏—Å–∫–∏)</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–î–≤—É—Å–≤—è–∑–Ω—ã–µ —Å–ø–∏—Å–∫–∏ —Å—Ç—Ä–æ–∫. –†–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Å—Ç–µ–∫–∏ –∏–ª–∏ –æ—á–µ—Ä–µ–¥–∏.</p>
                            <ul>
                                <li><code>LPUSH queue job</code> ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ</li>
                                <li><code>RPOP queue</code> ‚Äî –∑–∞–±—Ä–∞—Ç—å —Å –∫–æ–Ω—Ü–∞</li>
                                <li><code>BLPOP queue 0</code> ‚Äî –∂–¥–∞—Ç—å –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ (–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ—á–µ—Ä–µ–¥—å)</li>
                            </ul>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>Set (–ú–Ω–æ–∂–µ—Å—Ç–≤–∞)</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ù–µ—É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–æ–∫. –ë—ã—Å—Ç—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è.</p>
                            <ul>
                                <li><code>SADD tags "python" "redis"</code></li>
                                <li><code>SISMEMBER tags "java"</code> ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è O(1)</li>
                                <li><code>SINTER tag:1 tag:2</code> ‚Äî –Ω–∞–π—Ç–∏ –æ–±—â–∏–µ —Ç–µ–≥–∏</li>
                            </ul>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>Sorted Set (–£–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—ã–µ –º–Ω–æ–∂–µ—Å—Ç–≤–∞)</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ö–∞–∫ Set, –Ω–æ —É –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –µ—Å—Ç—å –≤–µ—Å (score). –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–æ–≤, –ª–∏–¥–µ—Ä–±–æ—Ä–¥–æ–≤, –æ—á–µ—Ä–µ–¥–µ–π —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º.</p>
                            <ul>
                                <li><code>ZADD leaderboard 100 "Alex"</code></li>
                                <li><code>ZRANGE leaderboard 0 10</code> ‚Äî —Ç–æ–ø 10 –∏–≥—Ä–æ–∫–æ–≤</li>
                                <li><code>ZRANK leaderboard "Alex"</code> ‚Äî –º–µ—Å—Ç–æ –∏–≥—Ä–æ–∫–∞</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <h2>Distributed Locks (Redlock)</h2>
                
                <p>
                    <strong>–ó–∞–¥–∞—á–∞:</strong> –ù–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ—Ä–¥–µ—Ä–∞. 
                    –ù—É–∂–Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –æ–¥–∏–Ω –æ—Ä–¥–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º –∏–Ω—Å—Ç–∞–Ω—Å–æ–º.
                </p>

<pre><code><span class="comment"># src/scaletrade/infrastructure/cache/distributed_lock.py</span>
<span class="keyword">import</span> uuid
<span class="keyword">from</span> contextlib <span class="keyword">import</span> asynccontextmanager
<span class="keyword">from</span> typing <span class="keyword">import</span> AsyncIterator

<span class="keyword">from</span> redis.asyncio <span class="keyword">import</span> Redis


<span class="keyword">class</span> <span class="class-name">DistributedLock</span>:
    <span class="string">"""
    –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ Redis.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç SET NX EX –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –∑–∞—Ö–≤–∞—Ç–∞.
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Lua —Å–∫—Ä–∏–ø—Ç.
    """</span>
    
    <span class="comment"># Lua —Å–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è</span>
    <span class="comment"># –£–¥–∞–ª—è–µ—Ç –∫–ª—é—á –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç</span>
    RELEASE_SCRIPT = <span class="string">"""
    if redis.call("get", KEYS[1]) == ARGV[1] then
        return redis.call("del", KEYS[1])
    else
        return 0
    end
    """</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(
        self, 
        redis: Redis, 
        name: <span class="type">str</span>, 
        timeout: <span class="type">int</span> = <span class="number">30</span>
    ) -> <span class="keyword">None</span>:
        self._redis = redis
        self._name = <span class="string">f"lock:</span>{name}<span class="string">"</span>
        self._timeout = timeout
        self._token = uuid.uuid4().hex
    
    <span class="keyword">async def</span> <span class="function">acquire</span>(self) -> <span class="type">bool</span>:
        <span class="string">"""
        –ü–æ–ø—ã—Ç–∫–∞ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É.
        
        SET NX ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        EX ‚Äî TTL –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–∑–∞—â–∏—Ç–∞ –æ—Ç deadlock)
        """</span>
        result = <span class="keyword">await</span> self._redis.set(
            self._name,
            self._token,
            nx=<span class="keyword">True</span>,    <span class="comment"># Not eXists</span>
            ex=self._timeout,
        )
        <span class="keyword">return</span> result <span class="keyword">is True</span>
    
    <span class="keyword">async def</span> <span class="function">release</span>(self) -> <span class="type">bool</span>:
        <span class="string">"""
        –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.
        
        –ò—Å–ø–æ–ª—å–∑—É–µ–º Lua —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏:
        –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –≤ –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.
        """</span>
        result = <span class="keyword">await</span> self._redis.eval(
            self.RELEASE_SCRIPT,
            <span class="number">1</span>,  <span class="comment"># –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π</span>
            self._name,
            self._token,
        )
        <span class="keyword">return</span> result == <span class="number">1</span>
    
    <span class="decorator">@asynccontextmanager</span>
    <span class="keyword">async def</span> <span class="function">hold</span>(self) -> AsyncIterator[<span class="type">bool</span>]:
        <span class="string">"""Context manager –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è."""</span>
        acquired = <span class="keyword">await</span> self.acquire()
        <span class="keyword">try</span>:
            <span class="keyword">yield</span> acquired
        <span class="keyword">finally</span>:
            <span class="keyword">if</span> acquired:
                <span class="keyword">await</span> self.release()</code></pre>

                <h3>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</h3>

<pre><code><span class="comment"># –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ä–¥–µ—Ä–∞ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π</span>
<span class="keyword">async def</span> <span class="function">process_order</span>(order_id: <span class="type">str</span>, redis: Redis) -> <span class="keyword">None</span>:
    lock = DistributedLock(redis, <span class="string">f"order:</span>{order_id}<span class="string">"</span>, timeout=<span class="number">60</span>)
    
    <span class="keyword">async with</span> lock.hold() <span class="keyword">as</span> acquired:
        <span class="keyword">if not</span> acquired:
            logger.warning(<span class="string">f"Order {order_id} is being processed by another instance"</span>)
            <span class="keyword">return</span>
        
        <span class="comment"># –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º</span>
        order = <span class="keyword">await</span> get_order(order_id)
        <span class="keyword">await</span> execute_order(order)</code></pre>

                <h2>Lua Scripting: –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>
                
                <p>
                    Lua —Å–∫—Ä–∏–ø—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ. Redis –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, 
                    —á—Ç–æ –Ω–∏–∫–∞–∫–∏–µ –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Å–∫—Ä–∏–ø—Ç–∞.
                </p>

                <h3>Rate Limiter (Token Bucket)</h3>

<pre><code><span class="comment"># src/scaletrade/infrastructure/cache/rate_limiter.py</span>
<span class="keyword">from</span> redis.asyncio <span class="keyword">import</span> Redis


<span class="keyword">class</span> <span class="class-name">TokenBucketRateLimiter</span>:
    <span class="string">"""
    Rate Limiter –Ω–∞ –æ—Å–Ω–æ–≤–µ Token Bucket.
    
    - Bucket –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–∫–µ–Ω–∞–º–∏ —Å –∑–∞–¥–∞–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é
    - –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∑–∞–±–∏—Ä–∞–µ—Ç —Ç–æ–∫–µ–Ω
    - –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–µ—Ç ‚Äî –æ—Ç–∫–∞–∑
    """</span>
    
    <span class="comment"># Lua —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ rate limiting</span>
    SCRIPT = <span class="string">"""
    local key = KEYS[1]
    local capacity = tonumber(ARGV[1])     -- –ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤
    local refill_rate = tonumber(ARGV[2])  -- –¢–æ–∫–µ–Ω–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
    local now = tonumber(ARGV[3])          -- –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è (ms)
    local requested = tonumber(ARGV[4])    -- –°–∫–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω–æ–≤ –Ω—É–∂–Ω–æ
    
    -- –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    local data = redis.call("HMGET", key, "tokens", "last_refill")
    local tokens = tonumber(data[1]) or capacity
    local last_refill = tonumber(data[2]) or now
    
    -- –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–æ–±–∞–≤–∏–ª–æ—Å—å
    local elapsed = (now - last_refill) / 1000
    local refilled = elapsed * refill_rate
    tokens = math.min(capacity, tokens + refilled)
    
    -- –ü—Ä–æ–±—É–µ–º –∑–∞–±—Ä–∞—Ç—å —Ç–æ–∫–µ–Ω—ã
    local allowed = 0
    if tokens >= requested then
        tokens = tokens - requested
        allowed = 1
    end
    
    -- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    redis.call("HMSET", key, "tokens", tokens, "last_refill", now)
    redis.call("EXPIRE", key, 3600)  -- TTL 1 —á–∞—Å
    
    return {allowed, math.floor(tokens)}
    """</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(
        self,
        redis: Redis,
        capacity: <span class="type">int</span> = <span class="number">100</span>,
        refill_rate: <span class="type">float</span> = <span class="number">10.0</span>,  <span class="comment"># —Ç–æ–∫–µ–Ω–æ–≤/—Å–µ–∫</span>
    ) -> <span class="keyword">None</span>:
        self._redis = redis
        self._capacity = capacity
        self._refill_rate = refill_rate
        self._script = self._redis.register_script(self.SCRIPT)
    
    <span class="keyword">async def</span> <span class="function">is_allowed</span>(
        self, 
        key: <span class="type">str</span>, 
        tokens: <span class="type">int</span> = <span class="number">1</span>
    ) -> <span class="keyword">tuple</span>[<span class="type">bool</span>, <span class="type">int</span>]:
        <span class="string">"""
        –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–∑—Ä–µ—à—ë–Ω –ª–∏ –∑–∞–ø—Ä–æ—Å.
        
        Returns:
            (allowed, remaining_tokens)
        """</span>
        <span class="keyword">import</span> time
        now_ms = <span class="type">int</span>(time.time() * <span class="number">1000</span>)
        
        result = <span class="keyword">await</span> self._script(
            keys=[<span class="string">f"ratelimit:</span>{key}<span class="string">"</span>],
            args=[self._capacity, self._refill_rate, now_ms, tokens],
        )
        
        <span class="keyword">return</span> <span class="type">bool</span>(result[<span class="number">0</span>]), <span class="type">int</span>(result[<span class="number">1</span>])</code></pre>

                <h3>Rate Limiter Middleware</h3>

<pre><code><span class="comment"># src/scaletrade/interface/middleware/rate_limit.py</span>
<span class="keyword">from</span> litestar <span class="keyword">import</span> Request
<span class="keyword">from</span> litestar.middleware <span class="keyword">import</span> AbstractMiddleware
<span class="keyword">from</span> litestar.exceptions <span class="keyword">import</span> TooManyRequestsException


<span class="keyword">class</span> <span class="class-name">RateLimitMiddleware</span>(AbstractMiddleware):
    <span class="keyword">async def</span> <span class="function">__call__</span>(self, request: Request, call_next):
        <span class="comment"># –ü–æ–ª—É—á–∞–µ–º rate limiter –∏–∑ DI</span>
        limiter = request.app.state.rate_limiter
        
        <span class="comment"># –ö–ª—é—á ‚Äî IP –∏–ª–∏ user_id</span>
        user_id = request.user.id <span class="keyword">if</span> request.user <span class="keyword">else</span> request.client.host
        key = <span class="string">f"api:</span>{user_id}<span class="string">"</span>
        
        allowed, remaining = <span class="keyword">await</span> limiter.is_allowed(key)
        
        <span class="keyword">if not</span> allowed:
            <span class="keyword">raise</span> TooManyRequestsException(
                detail=<span class="string">"Rate limit exceeded. Try again later."</span>,
                headers={<span class="string">"X-RateLimit-Remaining"</span>: <span class="type">str</span>(remaining)},
            )
        
        response = <span class="keyword">await</span> call_next(request)
        response.headers[<span class="string">"X-RateLimit-Remaining"</span>] = <span class="type">str</span>(remaining)
        <span class="keyword">return</span> response</code></pre>

                <h2>Pipelining: –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>
                
                <p>
                    –ë–µ–∑ pipelining: N –æ–ø–µ—Ä–∞—Ü–∏–π = N round-trip –¥–æ Redis.<br>
                    –° pipelining: N –æ–ø–µ—Ä–∞—Ü–∏–π = 1 round-trip.
                </p>

<pre><code><span class="comment"># –ë–µ–∑ pipelining (–º–µ–¥–ª–µ–Ω–Ω–æ)</span>
<span class="keyword">for</span> user_id <span class="keyword">in</span> user_ids:
    <span class="keyword">await</span> redis.get(<span class="string">f"user:</span>{user_id}<span class="string">"</span>)  <span class="comment"># 100 –∑–∞–ø—Ä–æ—Å–æ–≤ = 100 RTT</span>

<span class="comment"># –° pipelining (–±—ã—Å—Ç—Ä–æ)</span>
<span class="keyword">async with</span> redis.pipeline() <span class="keyword">as</span> pipe:
    <span class="keyword">for</span> user_id <span class="keyword">in</span> user_ids:
        pipe.get(<span class="string">f"user:</span>{user_id}<span class="string">"</span>)
    results = <span class="keyword">await</span> pipe.execute()  <span class="comment"># 1 RTT!</span></code></pre>

                <h3>Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∫–µ—à–∞</h3>

<pre><code><span class="comment"># src/scaletrade/infrastructure/cache/user_cache.py</span>
<span class="keyword">class</span> <span class="class-name">UserCache</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(self, redis: Redis) -> <span class="keyword">None</span>:
        self._redis = redis
        self._ttl = <span class="number">3600</span>
    
    <span class="keyword">async def</span> <span class="function">get_many</span>(self, user_ids: <span class="type">list</span>[<span class="type">int</span>]) -> <span class="type">dict</span>[<span class="type">int</span>, User | <span class="keyword">None</span>]:
        <span class="string">"""–ü–æ–ª—É—á–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º."""</span>
        <span class="keyword">if not</span> user_ids:
            <span class="keyword">return</span> {}
        
        keys = [<span class="string">f"user:</span>{uid}<span class="string">"</span> <span class="keyword">for</span> uid <span class="keyword">in</span> user_ids]
        values = <span class="keyword">await</span> self._redis.mget(keys)
        
        result = {}
        <span class="keyword">for</span> uid, value <span class="keyword">in</span> <span class="function">zip</span>(user_ids, values):
            <span class="keyword">if</span> value:
                result[uid] = User.model_validate_json(value)
            <span class="keyword">else</span>:
                result[uid] = <span class="keyword">None</span>
        
        <span class="keyword">return</span> result
    
    <span class="keyword">async def</span> <span class="function">set_many</span>(self, users: <span class="type">dict</span>[<span class="type">int</span>, User]) -> <span class="keyword">None</span>:
        <span class="string">"""–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º."""</span>
        <span class="keyword">async with</span> self._redis.pipeline() <span class="keyword">as</span> pipe:
            <span class="keyword">for</span> uid, user <span class="keyword">in</span> users.items():
                pipe.setex(
                    <span class="string">f"user:</span>{uid}<span class="string">"</span>,
                    self._ttl,
                    user.model_dump_json(),
                )
            <span class="keyword">await</span> pipe.execute()</code></pre>

                <h2>Cache-Aside Pattern</h2>

<pre><code><span class="comment"># src/scaletrade/application/services/user_service.py</span>
<span class="keyword">class</span> <span class="class-name">UserService</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(self, uow: UnitOfWork, cache: UserCache) -> <span class="keyword">None</span>:
        self._uow = uow
        self._cache = cache
    
    <span class="keyword">async def</span> <span class="function">get_user</span>(self, user_id: <span class="type">int</span>) -> User:
        <span class="string">"""
        Cache-Aside:
        1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
        2. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏–¥—ë–º –≤ –ë–î
        3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
        """</span>
        <span class="comment"># 1. –ü—Ä–æ–±—É–µ–º –∫–µ—à</span>
        cached = <span class="keyword">await</span> self._cache.get(user_id)
        <span class="keyword">if</span> cached:
            <span class="keyword">return</span> cached
        
        <span class="comment"># 2. –ò–¥—ë–º –≤ –ë–î</span>
        <span class="keyword">async with</span> self._uow:
            user = <span class="keyword">await</span> self._uow.users.get_by_id(user_id)
            <span class="keyword">if</span> user <span class="keyword">is None</span>:
                <span class="keyword">raise</span> UserNotFoundError(user_id)
        
        <span class="comment"># 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à</span>
        <span class="keyword">await</span> self._cache.set(user_id, user)
        
        <span class="keyword">return</span> user
    
    <span class="keyword">async def</span> <span class="function">update_user</span>(self, user_id: <span class="type">int</span>, data: UpdateUserDTO) -> User:
        <span class="string">"""–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ ‚Äî –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à."""</span>
        <span class="keyword">async with</span> self._uow:
            user = <span class="keyword">await</span> self._uow.users.get_by_id(user_id)
            user.update(data)
            <span class="keyword">await</span> self._uow.commit()
        
        <span class="comment"># –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à</span>
        <span class="keyword">await</span> self._cache.delete(user_id)
        
        <span class="keyword">return</span> user</code></pre>

                <h2>ü™® –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏</h2>
                <div class="accordion">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>1. –ö–æ–º–∞–Ω–¥–∞ KEYS *</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>KEYS *</code> –≤ –ø—Ä–æ–¥–µ. Redis ‚Äî –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω—ã–π. –ü–æ–∫–∞ –æ–Ω —Å–∫–∞–Ω–∏—Ä—É–µ—Ç 10 –º–ª–Ω –∫–ª—é—á–µ–π, –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∂–¥—É—Ç. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Å—Ç–∞–Ω–µ—Ç –∫–æ–ª–æ–º. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—É—Ä—Å–æ—Ä—ã: <code>SCAN</code>.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>2. Big Keys</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ï—Å–ª–∏ –≤ —Ö–µ—à–µ –∏–ª–∏ —Å–ø–∏—Å–∫–µ –º–∏–ª–ª–∏–æ–Ω —ç–ª–µ–º–µ–Ω—Ç–æ–≤, —É–¥–∞–ª–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –∫–ª—é—á–∞ (DEL) –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç Redis –Ω–∞ —Å–µ–∫—É–Ω–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>UNLINK</code> (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ) –∏ –∏–∑–±–µ–≥–∞–π—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–∫–∏—Ö –º–æ–Ω—Å—Ç—Ä–æ–≤.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>3. Redis –∫–∞–∫ –ë–î</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ –≤ Redis –¥–∞–Ω–Ω—ã–µ, –ø–æ—Ç–µ—Ä—è –∫–æ—Ç–æ—Ä—ã—Ö –∫—Ä–∏—Ç–∏—á–Ω–∞, –µ—Å–ª–∏ –≤—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ AOF —Å <code>fsync everysec</code> (–∏ –¥–∞–∂–µ —Ç–∞–∫ –µ—Å—Ç—å —Ä–∏—Å–∫). Redis –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å, –∞ –Ω–µ –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –∫–∞–∫ –∫—ç—à –∏–ª–∏ –æ—á–µ—Ä–µ–¥—å, –Ω–æ –Ω–µ –∫–∞–∫ Source of Truth.</p>
                        </div>
                    </div>
                </div>

                <h2>üí° –õ–∞–π—Ñ—Ö–∞–∫–∏</h2>
                <ul>
                    <li><strong>Naming Convention:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–≤–æ–µ—Ç–æ—á–∏—è –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏: <code>object_type:id:field</code> (–Ω–∞–ø—Ä–∏–º–µ—Ä, <code>user:100:settings</code>). –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω–∏–º–∞—é—Ç –º–Ω–æ–≥–∏–µ GUI –∫–ª–∏–µ–Ω—Ç—ã.</li>
                    <li><strong>–ö—ç—à —Å Jitter:</strong> –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ TTL –¥–æ–±–∞–≤–ª—è–π—Ç–µ —Å–ª—É—á–∞–π–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3600 ¬± 300 —Å–µ–∫). –≠—Ç–æ —Å–ø–∞—Å–µ—Ç –æ—Ç "Cache Stampede", –∫–æ–≥–¥–∞ —Ç—ã—Å—è—á–∏ –∫–ª—é—á–µ–π –ø—Ä–æ—Ç—É—Ö–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏ –±–∞–∑–∞ –ø–∞–¥–∞–µ—Ç –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π.</li>
                    <li><strong>–ê–Ω–∞–ª–∏–∑ –ø–∞–º—è—Ç–∏:</strong> –ó–∞–ø—É—Å—Ç–∏—Ç–µ <code>redis-cli --bigkeys</code> –∏–ª–∏ <code>--memkeys</code>, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –∫—Ç–æ —Å—ä–µ–ª –≤—Å—é –ø–∞–º—è—Ç—å.</li>
                </ul>

                <div class="task-box">
                    <h4>üìã –ó–∞–¥–∞–Ω–∏–µ</h4>
                    <ul class="task-list">
                        <li>–†–µ–∞–ª–∏–∑—É–π <code>DistributedLock</code> —Å Lua —Å–∫—Ä–∏–ø—Ç–æ–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ release</li>
                        <li>–°–æ–∑–¥–∞–π Rate Limiter —Å Token Bucket –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º</li>
                        <li>–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π Rate Limit middleware –≤ Litestar</li>
                        <li>–†–µ–∞–ª–∏–∑—É–π –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å Cache-Aside</li>
                        <li>–ù–∞–ø–∏—à–∏ —Ç–µ—Å—Ç, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∏–π —Ä–∞–±–æ—Ç—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</li>
                    </ul>
                </div>

                <div class="nav-footer">
                    <a href="part3_faststream.html">
                        <div>
                            <div class="nav-label">–ù–∞–∑–∞–¥</div>
                            <div class="nav-title">‚Üê 3.1 RabbitMQ + Faststream</div>
                        </div>
                    </a>
                    <a href="part4_testing.html">
                        <div>
                            <div class="nav-label">–î–∞–ª–µ–µ</div>
                            <div class="nav-title">4.1 Advanced Testing ‚Üí</div>
                        </div>
                    </a>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
