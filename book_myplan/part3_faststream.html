<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3.1 RabbitMQ + Faststream ‚Äî ScaleTrade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="book-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üìà</div>
                    <span>ScaleTrade</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">–í–≤–µ–¥–µ–Ω–∏–µ</div>
                    <a href="index.html" class="nav-link"><span class="nav-link-icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="setup.html" class="nav-link"><span class="nav-link-icon">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 1: PostgreSQL</div>
                    <a href="part1_schema.html" class="nav-link"><span class="nav-link-icon">üìä</span>1.1 –°—Ö–µ–º–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ</a>
                    <a href="part1_transactions.html" class="nav-link"><span class="nav-link-icon">üîÑ</span>1.2 –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</a>
                    <a href="part1_indexes.html" class="nav-link"><span class="nav-link-icon">üîç</span>1.3 –ò–Ω–¥–µ–∫—Å—ã</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</div>
                    <a href="part2_litestar.html" class="nav-link"><span class="nav-link-icon">üöÄ</span>2.1 Litestar + DDD</a>
                    <a href="part2_dishka.html" class="nav-link"><span class="nav-link-icon">üíâ</span>2.2 DI —Å Dishka</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 3: –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ</div>
                    <a href="part3_faststream.html" class="nav-link active"><span class="nav-link-icon">üì®</span>3.1 RabbitMQ + Faststream</a>
                    <a href="part3_redis.html" class="nav-link"><span class="nav-link-icon">‚ö°</span>3.2 Redis Patterns</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 4: –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å</div>
                    <a href="part4_testing.html" class="nav-link"><span class="nav-link-icon">üß™</span>4.1 Advanced Testing</a>
                    <a href="part4_resiliency.html" class="nav-link"><span class="nav-link-icon">üõ°Ô∏è</span>4.2 Resiliency</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 5: Observability</div>
                    <a href="part5_logging.html" class="nav-link"><span class="nav-link-icon">üìù</span>5.1 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</a>
                    <a href="part5_clickhouse.html" class="nav-link"><span class="nav-link-icon">üìà</span>5.2 ClickHouse</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 6: Production</div>
                    <a href="part6_migrations.html" class="nav-link"><span class="nav-link-icon">üîÄ</span>6.1 Zero-Downtime</a>
                    <a href="part6_quality.html" class="nav-link"><span class="nav-link-icon">‚úÖ</span>6.2 Code Quality</a>
                    <a href="part6_django.html" class="nav-link"><span class="nav-link-icon">üîó</span>6.3 Django Admin</a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="breadcrumb">
                    <a href="index.html">ScaleTrade</a>
                    <span>/</span>
                    <span>–ß–∞—Å—Ç—å 3</span>
                    <span>/</span>
                    <span>3.1 RabbitMQ + Faststream</span>
                </div>
            </header>

            <div class="page-content">
                <h1>–ú–æ–¥—É–ª—å 3.1: Message Broker –∏ Faststream</h1>
                <p class="lead">
                    Event-Driven Architecture: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏, 
                    –≥–∞—Ä–∞–Ω—Ç–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ Transactional Outbox Pattern.
                </p>

                <h2>–ó–∞—á–µ–º Message Broker?</h2>
                
                <p>–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ HTTP –≤—ã–∑–æ–≤—ã –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏ –∏–º–µ—é—Ç –ø—Ä–æ–±–ª–µ–º—ã:</p>
                <ul>
                    <li><strong>–°–≤—è–∑–Ω–æ—Å—Ç—å:</strong> –°–µ—Ä–≤–∏—Å A –∂–¥—ë—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç B ‚Äî –æ–±–∞ –∑–∞–Ω—è—Ç—ã</li>
                    <li><strong>–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:</strong> B —É–ø–∞–ª ‚Äî A —Ç–æ–∂–µ —Å–ª–æ–º–∞–Ω</li>
                    <li><strong>–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> –ü–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ –ª–æ–∂–∞—Ç –≤—Å—é —Ü–µ–ø–æ—á–∫—É</li>
                </ul>

                <div class="info-box info">
                    <div class="info-box-title">üí° Event-Driven Architecture</div>
                    <p>
                        –°–µ—Ä–≤–∏—Å—ã –æ–±—â–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è. –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –Ω–µ –∂–¥—ë—Ç –æ—Ç–≤–µ—Ç–∞. 
                        –ü–æ–ª—É—á–∞—Ç–µ–ª—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ –≥–æ—Ç–æ–≤. –ë—Ä–æ–∫–µ—Ä –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –¥–æ—Å—Ç–∞–≤–∫—É.
                    </p>
                </div>

                <h2>RabbitMQ: Exchange Types</h2>

                <table>
                    <thead>
                        <tr>
                            <th>Exchange</th>
                            <th>–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è</th>
                            <th>–°—Ü–µ–Ω–∞—Ä–∏–π</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Direct</strong></td>
                            <td>–¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ routing key</td>
                            <td>–ö–æ–º–∞–Ω–¥—ã, —Ç–æ—á–µ—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</td>
                        </tr>
                        <tr>
                            <td><strong>Fanout</strong></td>
                            <td>–í—Å–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏</td>
                            <td>Broadcast, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º</td>
                        </tr>
                        <tr>
                            <td><strong>Topic</strong></td>
                            <td>–ü–∞—Ç—Ç–µ—Ä–Ω matching (*.logs.#)</td>
                            <td>–õ–æ–≥–∏, —Å–æ–±—ã—Ç–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</td>
                        </tr>
                        <tr>
                            <td><strong>Headers</strong></td>
                            <td>–ü–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º —Å–æ–æ–±—â–µ–Ω–∏—è</td>
                            <td>–°–ª–æ–∂–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è</td>
                        </tr>
                    </tbody>
                </table>

                <h2>Faststream: —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫</h2>
                
                <p>Faststream ‚Äî —ç—Ç–æ –∫–∞–∫ FastAPI, –Ω–æ –¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π:</p>

<pre><code><span class="comment"># src/scaletrade/infrastructure/messaging/app.py</span>
<span class="keyword">from</span> faststream <span class="keyword">import</span> FastStream
<span class="keyword">from</span> faststream.rabbit <span class="keyword">import</span> RabbitBroker
<span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel

<span class="keyword">from</span> scaletrade.config <span class="keyword">import</span> get_settings

settings = get_settings()
broker = RabbitBroker(<span class="type">str</span>(settings.rabbitmq_url))
app = FastStream(broker)


<span class="comment"># === Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π ===</span>

<span class="keyword">class</span> <span class="class-name">OrderCreatedEvent</span>(BaseModel):
    <span class="string">"""–°–æ–±—ã—Ç–∏–µ: –æ—Ä–¥–µ—Ä —Å–æ–∑–¥–∞–Ω."""</span>
    order_id: <span class="type">str</span>
    user_id: <span class="type">int</span>
    symbol: <span class="type">str</span>
    side: <span class="type">str</span>
    quantity: <span class="type">str</span>
    price: <span class="type">str</span>
    timestamp: <span class="type">str</span>


<span class="keyword">class</span> <span class="class-name">OrderFilledEvent</span>(BaseModel):
    <span class="string">"""–°–æ–±—ã—Ç–∏–µ: –æ—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω–µ–Ω."""</span>
    order_id: <span class="type">str</span>
    user_id: <span class="type">int</span>
    filled_price: <span class="type">str</span>
    filled_at: <span class="type">str</span></code></pre>

                <h3>Publisher: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π</h3>

<pre><code><span class="comment"># src/scaletrade/infrastructure/messaging/publisher.py</span>
<span class="keyword">from</span> faststream.rabbit <span class="keyword">import</span> RabbitBroker, RabbitExchange, ExchangeType

<span class="comment"># –û–ø—Ä–µ–¥–µ–ª—è–µ–º exchanges</span>
order_events_exchange = RabbitExchange(
    name=<span class="string">"order.events"</span>,
    type=ExchangeType.TOPIC,
    durable=<span class="keyword">True</span>,
)


<span class="keyword">class</span> <span class="class-name">OrderEventPublisher</span>:
    <span class="string">"""–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –æ—Ä–¥–µ—Ä–æ–≤."""</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(self, broker: RabbitBroker) -> <span class="keyword">None</span>:
        self._broker = broker
    
    <span class="keyword">async def</span> <span class="function">publish_order_created</span>(self, event: OrderCreatedEvent) -> <span class="keyword">None</span>:
        <span class="string">"""–ü—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–¥–µ—Ä–∞."""</span>
        <span class="keyword">await</span> self._broker.publish(
            event,
            exchange=order_events_exchange,
            routing_key=<span class="string">f"order.created.</span>{event.symbol.replace('/', '.')}<span class="string">"</span>,
            <span class="comment"># order.created.BTC.USD</span>
        )
    
    <span class="keyword">async def</span> <span class="function">publish_order_filled</span>(self, event: OrderFilledEvent) -> <span class="keyword">None</span>:
        <span class="keyword">await</span> self._broker.publish(
            event,
            exchange=order_events_exchange,
            routing_key=<span class="string">"order.filled"</span>,
        )</code></pre>

                <h3>Subscriber: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π</h3>

<pre><code><span class="comment"># src/scaletrade/infrastructure/messaging/subscribers.py</span>
<span class="keyword">from</span> faststream.rabbit <span class="keyword">import</span> RabbitRouter, RabbitQueue
<span class="keyword">from</span> scaletrade.infrastructure.messaging.app <span class="keyword">import</span> broker

router = RabbitRouter()

<span class="comment"># –û—á–µ—Ä–µ–¥—å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (–ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –æ—Ä–¥–µ—Ä–æ–≤)</span>
analytics_queue = RabbitQueue(
    name=<span class="string">"analytics.orders"</span>,
    durable=<span class="keyword">True</span>,
    arguments={
        <span class="string">"x-dead-letter-exchange"</span>: <span class="string">"dlx.analytics"</span>,
        <span class="string">"x-message-ttl"</span>: <span class="number">86400000</span>,  <span class="comment"># 24h</span>
    }
)


<span class="decorator">@router.subscriber</span>(
    queue=analytics_queue,
    exchange=order_events_exchange,
    routing_key=<span class="string">"order.#"</span>,  <span class="comment"># –í—Å–µ —Å–æ–±—ã—Ç–∏—è order.*</span>
)
<span class="keyword">async def</span> <span class="function">handle_order_event</span>(event: OrderCreatedEvent | OrderFilledEvent) -> <span class="keyword">None</span>:
    <span class="string">"""
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –æ—Ä–¥–µ—Ä–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
    
    Faststream –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
    - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Pydantic
    - –î–µ–ª–∞–µ—Ç ACK –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    - –î–µ–ª–∞–µ—Ç NACK –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–∏ (requeue)
    """</span>
    <span class="keyword">match</span> event:
        <span class="keyword">case</span> OrderCreatedEvent():
            <span class="keyword">await</span> save_to_clickhouse(event)
        <span class="keyword">case</span> OrderFilledEvent():
            <span class="keyword">await</span> update_analytics(event)


<span class="comment"># –û—á–µ—Ä–µ–¥—å –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</span>
notifications_queue = RabbitQueue(name=<span class="string">"notifications.orders"</span>, durable=<span class="keyword">True</span>)


<span class="decorator">@router.subscriber</span>(
    queue=notifications_queue,
    exchange=order_events_exchange,
    routing_key=<span class="string">"order.filled"</span>,
)
<span class="keyword">async def</span> <span class="function">notify_order_filled</span>(event: OrderFilledEvent) -> <span class="keyword">None</span>:
    <span class="string">"""–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."""</span>
    <span class="keyword">await</span> send_push_notification(
        user_id=event.user_id,
        message=<span class="string">f"–í–∞—à –æ—Ä–¥–µ—Ä {event.order_id} –∏—Å–ø–æ–ª–Ω–µ–Ω!"</span>,
    )


broker.include_router(router)</code></pre>

                <h2>Transactional Outbox Pattern</h2>
                
                <p><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> –ö–∞–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–æ—à–ª–∞?</p>

                <div class="comparison-table">
                    <div class="comparison-col bad">
                        <h4>‚ùå –ü—Ä–æ–±–ª–µ–º–∞</h4>
<pre><code><span class="keyword">async def</span> <span class="function">create_order</span>(...):
    <span class="keyword">async with</span> session.begin():
        session.add(order)
        <span class="comment"># –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –µ—â—ë –Ω–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞!</span>
    
    <span class="comment"># –ê –µ—Å–ª–∏ –∑–¥–µ—Å—å —Å–µ—Ä–≤–µ—Ä —É–ø–∞–¥—ë—Ç?</span>
    <span class="keyword">await</span> broker.publish(event)
    <span class="comment"># –°–æ–±—ã—Ç–∏–µ —É–π–¥—ë—Ç, –Ω–æ –æ—Ä–¥–µ—Ä–∞ –Ω–µ—Ç!</span></code></pre>
                    </div>
                    <div class="comparison-col good">
                        <h4>‚úÖ Outbox Pattern</h4>
<pre><code><span class="keyword">async def</span> <span class="function">create_order</span>(...):
    <span class="keyword">async with</span> session.begin():
        session.add(order)
        <span class="comment"># –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ —Ç—É –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</span>
        session.add(OutboxMessage(
            payload=event.json()
        ))
    <span class="comment"># –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç</span></code></pre>
                    </div>
                </div>

                <h3>–†–µ–∞–ª–∏–∑–∞—Ü–∏—è Outbox</h3>

<pre><code><span class="comment"># src/scaletrade/infrastructure/database/models/outbox.py</span>
<span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> BigInteger, String, Text, Boolean
<span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> Mapped, mapped_column

<span class="keyword">from</span> scaletrade.infrastructure.database.models.base <span class="keyword">import</span> Base


<span class="keyword">class</span> <span class="class-name">OutboxMessage</span>(Base):
    <span class="string">"""–¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (Transactional Outbox)."""</span>
    
    __tablename__ = <span class="string">"outbox_messages"</span>
    
    id: Mapped[<span class="type">int</span>] = mapped_column(BigInteger, primary_key=<span class="keyword">True</span>)
    
    <span class="comment"># Routing</span>
    exchange: Mapped[<span class="type">str</span>] = mapped_column(String(255))
    routing_key: Mapped[<span class="type">str</span>] = mapped_column(String(255))
    
    <span class="comment"># Payload</span>
    payload: Mapped[<span class="type">str</span>] = mapped_column(Text)  <span class="comment"># JSON</span>
    
    <span class="comment"># Status</span>
    processed: Mapped[<span class="type">bool</span>] = mapped_column(Boolean, default=<span class="keyword">False</span>, index=<span class="keyword">True</span>)
    created_at: Mapped[datetime] = mapped_column(server_default=func.now())</code></pre>

                <h3>–ü—É–±–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Outbox</h3>

<pre><code><span class="comment"># src/scaletrade/application/services/order_service.py</span>
<span class="keyword">class</span> <span class="class-name">OrderService</span>:
    <span class="keyword">async def</span> <span class="function">create_order</span>(self, dto: CreateOrderDTO) -> OrderDTO:
        <span class="keyword">async with</span> self.uow:
            <span class="comment"># –°–æ–∑–¥–∞—ë–º –æ—Ä–¥–µ—Ä</span>
            order = Order.create(...)
            <span class="keyword">await</span> self.uow.orders.save(order)
            
            <span class="comment"># –°–æ–∑–¥–∞—ë–º —Å–æ–±—ã—Ç–∏–µ –≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</span>
            event = OrderCreatedEvent(
                order_id=<span class="type">str</span>(order.id),
                user_id=order.user_id.value,
                symbol=order.symbol,
                side=order.side.value,
                quantity=<span class="type">str</span>(order.quantity.amount),
                price=<span class="type">str</span>(order.price.amount),
                timestamp=datetime.utcnow().isoformat(),
            )
            
            <span class="comment"># –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ outbox (–∞—Ç–æ–º–∞—Ä–Ω–æ —Å –æ—Ä–¥–µ—Ä–æ–º!)</span>
            <span class="keyword">await</span> self.uow.outbox.add(
                exchange=<span class="string">"order.events"</span>,
                routing_key=<span class="string">f"order.created.</span>{order.symbol.replace('/', '.')}<span class="string">"</span>,
                payload=event.model_dump_json(),
            )
            
            <span class="keyword">await</span> self.uow.commit()
            
            <span class="keyword">return</span> OrderDTO.from_domain(order)</code></pre>

                <h3>Outbox Worker</h3>

<pre><code><span class="comment"># src/scaletrade/workers/outbox_worker.py</span>
<span class="keyword">import</span> asyncio
<span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> select, update

<span class="keyword">from</span> scaletrade.infrastructure.database.models <span class="keyword">import</span> OutboxMessage
<span class="keyword">from</span> scaletrade.infrastructure.messaging.app <span class="keyword">import</span> broker


<span class="keyword">async def</span> <span class="function">process_outbox</span>(session: AsyncSession) -> <span class="type">int</span>:
    <span class="string">"""
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ outbox.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ–º SKIP LOCKED –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –≤–æ—Ä–∫–µ—Ä–∞–º–∏.
    """</span>
    <span class="comment"># –ë–µ—Ä—ë–º batch —Å–æ–æ–±—â–µ–Ω–∏–π —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π</span>
    stmt = (
        select(OutboxMessage)
        .where(OutboxMessage.processed == <span class="keyword">False</span>)
        .order_by(OutboxMessage.created_at)
        .limit(<span class="number">100</span>)
        .with_for_update(skip_locked=<span class="keyword">True</span>)
    )
    
    result = <span class="keyword">await</span> session.execute(stmt)
    messages = result.scalars().all()
    
    <span class="keyword">for</span> msg <span class="keyword">in</span> messages:
        <span class="keyword">try</span>:
            <span class="comment"># –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ RabbitMQ</span>
            <span class="keyword">await</span> broker.publish(
                msg.payload,
                exchange=msg.exchange,
                routing_key=msg.routing_key,
            )
            
            <span class="comment"># –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ</span>
            msg.processed = <span class="keyword">True</span>
            
        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
            <span class="comment"># –õ–æ–≥–∏—Ä—É–µ–º, –Ω–æ –Ω–µ –ø–∞–¥–∞–µ–º</span>
            logger.error(<span class="string">f"Failed to publish message {msg.id}: {e}"</span>)
    
    <span class="keyword">await</span> session.commit()
    <span class="keyword">return</span> len(messages)


<span class="keyword">async def</span> <span class="function">outbox_worker_loop</span>() -> <span class="keyword">None</span>:
    <span class="string">"""–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ outbox."""</span>
    <span class="keyword">async with</span> async_sessionmaker() <span class="keyword">as</span> session:
        <span class="keyword">while</span> <span class="keyword">True</span>:
            processed = <span class="keyword">await</span> process_outbox(session)
            
            <span class="keyword">if</span> processed == <span class="number">0</span>:
                <span class="comment"># –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äî –∂–¥—ë–º</span>
                <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)
            <span class="keyword">else</span>:
                logger.info(<span class="string">f"Processed {processed} outbox messages"</span>)</code></pre>

                <div class="info-box tip">
                    <div class="info-box-title">‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Outbox</div>
                    <ul>
                        <li><strong>–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å:</strong> –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —á—Ç–æ –∏ –¥–∞–Ω–Ω—ã–µ</li>
                        <li><strong>–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:</strong> –ú–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –≤–æ—Ä–∫–µ—Ä</li>
                        <li><strong>–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:</strong> –ë—Ä–æ–∫–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è</li>
                        <li><strong>–ü–æ—Ä—è–¥–æ–∫:</strong> –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ —Å–æ–∑–¥–∞–Ω–∏—è</li>
                    </ul>
                </div>

                <h2>ü™® –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏</h2>
                <div class="accordion">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>1. At-least-once delivery</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ë—Ä–æ–∫–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π (RabbitMQ, Kafka) –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç –¥–æ—Å—Ç–∞–≤–∫—É "—Ö–æ—Ç—è –±—ã —Ä–∞–∑". –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –≤–∞—à –∫–æ–Ω—Å—å—é–º–µ—Ä –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–≤–∞–∂–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ ACK –Ω–µ –¥–æ—à–µ–ª –¥–æ –±—Ä–æ–∫–µ—Ä–∞). –í–∞—à –∫–æ–¥ <strong>–æ–±—è–∑–∞–Ω</strong> –±—ã—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>2. –ë–æ–ª—å—à–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è</strong>
                        </div>
                        <div class="accordion-content">
                            <p>RabbitMQ –Ω–∞—á–∏–Ω–∞–µ—Ç "–∫–∞—à–ª—è—Ç—å", –µ—Å–ª–∏ –≥–æ–Ω—è—Ç—å —á–µ—Ä–µ–∑ –Ω–µ–≥–æ –º–µ–≥–∞–±–∞–π—Ç–Ω—ã–µ JSON'—ã. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–Ω–æ–≥–æ ‚Äî –ø–æ–ª–æ–∂–∏—Ç–µ –∏—Ö –≤ S3/DB, –∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª–æ–∂–∏—Ç–µ —Ç–æ–ª—å–∫–æ ID. –ë—Ä–æ–∫–µ—Ä ‚Äî –¥–ª—è —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏, –∞ –Ω–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ñ–∞–π–ª–æ–≤.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>3. –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ä–µ—Ç—Ä–∞–∏ (Poison Pill)</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—ã–∑—ã–≤–∞–µ—Ç –ø–∞–¥–µ–Ω–∏–µ –∫–æ–Ω—Å—å—é–º–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫—Ä–∏–≤–æ–π JSON), –±—Ä–æ–∫–µ—Ä –≤–µ—Ä–Ω–µ—Ç –µ–≥–æ –≤ –æ—á–µ—Ä–µ–¥—å, –∏ –∫–æ–Ω—Å—å—é–º–µ—Ä —É–ø–∞–¥–µ—Ç —Å–Ω–æ–≤–∞. –≠—Ç–æ —Ü–∏–∫–ª —Å–º–µ—Ä—Ç–∏. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Dead Letter Exchange (DLX) –∏ –æ–≥—Ä–∞–Ω–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (x-delivery-limit).</p>
                        </div>
                    </div>
                </div>

                <h2>üí° –õ–∞–π—Ñ—Ö–∞–∫–∏</h2>
                <ul>
                    <li><strong>Gzip/Brotli:</strong> –ï—Å–ª–∏ JSON –±–æ–ª—å—à–æ–π, —É–∂–º–∏—Ç–µ –µ–≥–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π. CPU –¥–µ—à–µ–≤–ª–µ, —á–µ–º —Å–µ—Ç—å –∏ –ø–∞–º—è—Ç—å –±—Ä–æ–∫–µ—Ä–∞.</li>
                    <li><strong>Consistent Hashing:</strong> –ï—Å–ª–∏ –≤–∞–∂–µ–Ω –ø–æ—Ä—è–¥–æ–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ–¥–Ω–æ–≥–æ —é–∑–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>user_id</code> –∫–∞–∫ routing key (–∏–ª–∏ partition key –≤ Kafka). –¢–æ–≥–¥–∞ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —é–∑–µ—Ä–∞ –ø–æ–π–¥—É—Ç –≤ –æ–¥–∏–Ω —à–∞—Ä–¥ –∏ –æ–±—Ä–∞–±–æ—Ç–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.</li>
                    <li><strong>Outbox Cleaner:</strong> –¢–∞–±–ª–∏—Ü–∞ outbox –±—ã—Å—Ç—Ä–æ –ø—É—Ö–Ω–µ—Ç. –ù–µ —É–¥–∞–ª—è–π—Ç–µ –∑–∞–ø–∏—Å–∏ –ø–æ –æ–¥–Ω–æ–π —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ (–ª–∏—à–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ WAL). –ü–æ–º–µ—á–∞–π—Ç–µ <code>processed=true</code>, –∞ —Ä–∞–∑ –≤ –Ω–æ—á—å —É–¥–∞–ª—è–π—Ç–µ –ø–∞—á–∫–æ–π (<code>DELETE FROM outbox WHERE processed AND created_at < NOW() - INTERVAL '1 day'</code>).</li>
                </ul>

                <div class="task-box">
                    <h4>üìã –ó–∞–¥–∞–Ω–∏–µ</h4>
                    <ul class="task-list">
                        <li>–ù–∞—Å—Ç—Ä–æ–π RabbitMQ —Å Topic exchange –¥–ª—è —Å–æ–±—ã—Ç–∏–π –æ—Ä–¥–µ—Ä–æ–≤</li>
                        <li>–†–µ–∞–ª–∏–∑—É–π Publisher –∏ Subscriber —Å Faststream</li>
                        <li>–°–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É <code>outbox_messages</code> –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π</li>
                        <li>–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π Outbox –≤ <code>OrderService.create_order</code></li>
                        <li>–ù–∞–ø–∏—à–∏ –≤–æ—Ä–∫–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ outbox —Å SKIP LOCKED</li>
                    </ul>
                </div>

                <div class="nav-footer">
                    <a href="part2_dishka.html">
                        <div>
                            <div class="nav-label">–ù–∞–∑–∞–¥</div>
                            <div class="nav-title">‚Üê 2.2 DI —Å Dishka</div>
                        </div>
                    </a>
                    <a href="part3_redis.html">
                        <div>
                            <div class="nav-label">–î–∞–ª–µ–µ</div>
                            <div class="nav-title">3.2 Redis Patterns ‚Üí</div>
                        </div>
                    </a>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
