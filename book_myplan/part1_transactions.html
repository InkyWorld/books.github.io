<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1.2 –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø ‚Äî ScaleTrade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="book-layout">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üìà</div>
                    <span>ScaleTrade</span>
                </a>
            </div>
            
            <nav class="sidebar-nav">
    <div class="nav-section">
        <div class="nav-section-title">Intro</div>
        <a href="index.html" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
        <a href="setup.html" class="nav-link">üõ† Setup</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 0: Fundamentals</div>
        <a href="part0_internals.html" class="nav-link">0.1 Internals</a>
        <a href="part0_networking.html" class="nav-link">0.2 Networking</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 1: Postgres</div>
        <a href="part1_schema.html" class="nav-link">1.1 Schema</a>
        <a href="part1_indexes.html" class="nav-link">1.2 Indexes</a>
        <a href="part1_transactions.html" class="nav-link active">1.3 Transactions</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 2: Litestar</div>
        <a href="part2_litestar.html" class="nav-link">2.1 Framework</a>
        <a href="part2_dishka.html" class="nav-link">2.2 DI (Dishka)</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 3: Brokers</div>
        <a href="part3_redis.html" class="nav-link">3.1 Redis</a>
        <a href="part3_faststream.html" class="nav-link">3.2 FastStream</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 4: Quality</div>
        <a href="part4_testing.html" class="nav-link">4.1 Pytest</a>
        <a href="part4_resiliency.html" class="nav-link">4.2 Resilience</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 5: Observability</div>
        <a href="part5_clickhouse.html" class="nav-link">5.1 Clickhouse</a>
        <a href="part5_logging.html" class="nav-link">5.2 Structured Logs</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 6: Django</div>
        <a href="part6_django.html" class="nav-link">6.1 ORM</a>
        <a href="part6_migrations.html" class="nav-link">6.2 Migrations</a>
        <a href="part6_quality.html" class="nav-link">6.3 Quality</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 7: Microservices</div>
        <a href="part7_grpc.html" class="nav-link">7.1 gRPC</a>
        <a href="part7_graphql.html" class="nav-link">7.2 GraphQL</a>
        <a href="part7_federation.html" class="nav-link">7.3 Federation</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 8: Async</div>
        <a href="part8_asyncio.html" class="nav-link">8.1 Asyncio</a>
        <a href="part8_celery.html" class="nav-link">8.2 Celery</a>
        <a href="part8_dramatiq.html" class="nav-link">8.3 Dramatiq</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 9: API</div>
        <a href="part9_restdesign.html" class="nav-link">9.1 REST Design</a>
        <a href="part9_idempotency.html" class="nav-link">9.2 Idempotency</a>
        <a href="part9_openapi.html" class="nav-link">9.3 OpenAPI</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 10: Culture</div>
        <a href="part10_git.html" class="nav-link">10.1 Git</a>
        <a href="part10_commits.html" class="nav-link">10.2 Commits</a>
        <a href="part10_codereview.html" class="nav-link">10.3 Post-Review</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 11: Security</div>
        <a href="part11_oauth.html" class="nav-link">11.1 OAuth2</a>
        <a href="part11_vault.html" class="nav-link">11.2 Vault</a>
        <a href="part11_owasp.html" class="nav-link">11.3 OWASP</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 12: Kubernetes</div>
        <a href="part12_kubernetes.html" class="nav-link">12.1 K8s Basics</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 13: High Load</div>
        <a href="part13_profiling.html" class="nav-link">13.1 Profiling</a>
        <a href="part13_caching.html" class="nav-link">13.2 Caching</a>
        <a href="part13_loadbalancing.html" class="nav-link">13.3 Load Balancing</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 14: ML Ops</div>
        <a href="part14_mlflow.html" class="nav-link">14.1 MLflow</a>
        <a href="part14_embeddings.html" class="nav-link">14.2 Embeddings</a>
        <a href="part14_llm.html" class="nav-link">14.3 LLM</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 15: Debugging</div>
        <a href="part15_debugging.html" class="nav-link">15.1 Debugging</a>
        <a href="part15_postmortem.html" class="nav-link">15.2 Postmortem</a>
        <a href="part15_chaos.html" class="nav-link">15.3 Chaos Eng</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 16: DB Advanced</div>
        <a href="part16_indexes.html" class="nav-link">16.1 Indexes Deep</a>
        <a href="part16_isolation.html" class="nav-link">16.2 Isolation</a>
        <a href="part16_sharding.html" class="nav-link">16.3 Sharding</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 17: System Design</div>
        <a href="part17_circuit.html" class="nav-link">17.1 Circuit Breaker</a>
        <a href="part17_ratelimit.html" class="nav-link">17.2 Rate Limit</a>
        <a href="part17_distlock.html" class="nav-link">17.3 Dist Lock</a>
    </div>
    <div class="nav-section">
        <div class="nav-section-title">Part 18: Soft Skills</div>
        <a href="part18_estimation.html" class="nav-link">18.1 Estimation</a>
        <a href="part18_burnout.html" class="nav-link">18.2 Burnout</a>
        <a href="part18_interview.html" class="nav-link">18.3 Interview</a>
    </div>
</nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="breadcrumb">
                    <a href="index.html">ScaleTrade</a>
                    <span>/</span>
                    <span>–ß–∞—Å—Ç—å 1</span>
                    <span>/</span>
                    <span>1.2 –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</span>
                </div>
            </header>

            <div class="page-content">
                <h1>–ú–æ–¥—É–ª—å 1.2: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø</h1>
                <p class="lead">
                    –í —Ñ–∏–Ω—Ç–µ—Ö–µ Race Condition ‚Äî —ç—Ç–æ –Ω–µ –±–∞–≥, –∞ –ø–æ—Ç–µ—Ä—è –¥–µ–Ω–µ–≥. 
                    –†–∞–∑–±–∏—Ä–∞–µ–º—Å—è —Å —É—Ä–æ–≤–Ω—è–º–∏ –∏–∑–æ–ª—è—Ü–∏–∏, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.
                </p>

                <h2>ACID: –Ω–µ –ø—Ä–æ—Å—Ç–æ –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞</h2>
                
                <table>
                    <thead>
                        <tr>
                            <th>–°–≤–æ–π—Å—Ç–≤–æ</th>
                            <th>–ß—Ç–æ –∑–Ω–∞—á–∏—Ç</th>
                            <th>–î–ª—è –Ω–∞—Å</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Atomicity (–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å)</strong></td>
                            <td>–í—Å—ë –∏–ª–∏ –Ω–∏—á–µ–≥–æ</td>
                            <td>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ–¥–µ–ª–∏–º–∞. –ï—Å–ª–∏ –ø–∞–¥–∞–µ—Ç —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ –∑–∞–ø–∏—Å–∏ ‚Äî –ë–î –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫ —á–∏—Å—Ç–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é. –ù–∏–∫–∞–∫–∏—Ö "–ø–æ–ª–æ–≤–∏–Ω—á–∞—Ç—ã—Ö" –¥–∞–Ω–Ω—ã—Ö. –í PG —ç—Ç–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ WAL (Write Ahead Log).</td>
                        </tr>
                        <tr>
                            <td><strong>Consistency (–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å)</strong></td>
                            <td>–î–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –≤–∞–ª–∏–¥–Ω—ã</td>
                            <td>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –ë–î –∏–∑ –æ–¥–Ω–æ–≥–æ –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –¥—Ä—É–≥–æ–µ. –ù–∞—Ä—É—à–µ–Ω–∏–µ Constraints (Foreign Key, Check, Unique) –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.</td>
                        </tr>
                        <tr>
                            <td><strong>Isolation (–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å)</strong></td>
                            <td>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –º–µ—à–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É</td>
                            <td>–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥—Ä—É–≥ –¥—Ä—É–≥–∞. –≠—Ç–æ —Å–∞–º–æ–µ —Å–ª–æ–∂–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ, —Ç–∞–∫ –∫–∞–∫ –ø–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è —É–±–∏–≤–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (Serializable).</td>
                        </tr>
                        <tr>
                            <td><strong>Durability (–î–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å)</strong></td>
                            <td>–ü–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</td>
                            <td>–ï—Å–ª–∏ <code>COMMIT</code> –≤–µ—Ä–Ω—É–ª OK, –∑–Ω–∞—á–∏—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ –¥–∏—Å–∫–µ (–≤ WAL). –î–∞–∂–µ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —Å–≥–æ—Ä–∏—Ç —á–µ—Ä–µ–∑ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—É. –î–ª—è —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è <code>fsync()</code>.</td>
                        </tr>
                    </tbody>
                </table>

                <h2>MVCC: –ö–∞–∫ Postgres —á–∏—Ç–∞–µ—Ç –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫</h2>
                <p>–í —Å—Ç–∞—Ä—ã—Ö –ë–î (MySQL MyISAM, DB2) —á—Ç–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–æ –∑–∞–ø–∏—Å—å. –í PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è <strong>MVCC (Multi-Version Concurrency Control)</strong>.</p>
                <ul>
                    <li>–ü—Ä–∏ <code>UPDATE</code> —Å—Ç–∞—Ä–∞—è —Å—Ç—Ä–æ—á–∫–∞ –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è, –∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ "–º–µ—Ä—Ç–≤–∞—è". –°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å—Ç—Ä–æ–∫–∏.</li>
                    <li>–ö–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–∏—Ç "—Å–Ω–∏–º–∫–∏" (Snapshots) –¥–∞–Ω–Ω—ã—Ö, –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–∞ –º–æ–º–µ–Ω—Ç –µ—ë –Ω–∞—á–∞–ª–∞.</li>
                    <li>–ß–∏—Ç–∞—Ç–µ–ª–∏ –ù–ï –±–ª–æ–∫–∏—Ä—É—é—Ç –ø–∏—Å–∞—Ç–µ–ª–µ–π. –ü–∏—Å–∞—Ç–µ–ª–∏ –ù–ï –±–ª–æ–∫–∏—Ä—É—é—Ç —á–∏—Ç–∞—Ç–µ–ª–µ–π.</li>
                </ul>
                <p>–ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É <code>COUNT(*)</code> –≤ Postgres –º–µ–¥–ª–µ–Ω–Ω—ã–π ‚Äî –µ–º—É –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–±—Ä–∞—Ç—å –≤—Å–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –∫–∞–∫–∏–µ –∏–∑ –Ω–∏—Ö "–≤–∏–¥–Ω—ã" —Ç–µ–∫—É—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.</p>

                <h2>–£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏: –∞–Ω–æ–º–∞–ª–∏–∏ –∏ –∑–∞—â–∏—Ç–∞</h2>
                
                <p>PostgreSQL –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 4 —É—Ä–æ–≤–Ω—è –∏–∑–æ–ª—è—Ü–∏–∏. –ö–∞–∂–¥—ã–π –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –∞–Ω–æ–º–∞–ª–∏–π:</p>

                <table>
                    <thead>
                        <tr>
                            <th>–£—Ä–æ–≤–µ–Ω—å</th>
                            <th>Dirty Read</th>
                            <th>Non-repeatable Read</th>
                            <th>Phantom Read</th>
                            <th>Serialization Anomaly</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Read Uncommitted*</td>
                            <td>‚úÖ</td>
                            <td>‚ùå</td>
                            <td>‚ùå</td>
                            <td>‚ùå</td>
                        </tr>
                        <tr>
                            <td>Read Committed</td>
                            <td>‚úÖ</td>
                            <td>‚ùå</td>
                            <td>‚ùå</td>
                            <td>‚ùå</td>
                        </tr>
                        <tr>
                            <td>Repeatable Read</td>
                            <td>‚úÖ</td>
                            <td>‚úÖ</td>
                            <td>‚úÖ**</td>
                            <td>‚ùå</td>
                        </tr>
                        <tr>
                            <td>Serializable</td>
                            <td>‚úÖ</td>
                            <td>‚úÖ</td>
                            <td>‚úÖ</td>
                            <td>‚úÖ</td>
                        </tr>
                    </tbody>
                </table>
                
                <p><small>* –í PostgreSQL —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ Read Committed<br>** PostgreSQL –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç Phantom Read –Ω–∞ —É—Ä–æ–≤–Ω–µ RR</small></p>

                <h3>–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: Non-repeatable Read</h3>
                
                <p><strong>–ê–Ω–æ–º–∞–ª–∏—è:</strong> –ß–∏—Ç–∞–µ–º –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –¥–≤–∞–∂–¥—ã ‚Äî –ø–æ–ª—É—á–∞–µ–º —Ä–∞–∑–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.</p>

<pre><code><span class="comment">-- –¢–µ—Ä–º–∏–Ω–∞–ª 1: –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (READ COMMITTED)</span>
<span class="keyword">BEGIN</span>;
<span class="keyword">SET TRANSACTION ISOLATION LEVEL</span> READ COMMITTED;

<span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> user_id = <span class="number">1</span>;
<span class="comment">-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 1000.00</span>

<span class="comment">-- –ñ–¥—ë–º –ø–æ–∫–∞ –¢–µ—Ä–º–∏–Ω–∞–ª 2 –≤—ã–ø–æ–ª–Ω–∏—Ç UPDATE –∏ COMMIT...</span>

<span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> user_id = <span class="number">1</span>;
<span class="comment">-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 800.00 (–¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ!)</span>
<span class="keyword">COMMIT</span>;


<span class="comment">-- –¢–µ—Ä–º–∏–Ω–∞–ª 2: –ú–µ–Ω—è–µ–º –±–∞–ª–∞–Ω—Å</span>
<span class="keyword">BEGIN</span>;
<span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance = <span class="number">800</span> <span class="keyword">WHERE</span> user_id = <span class="number">1</span>;
<span class="keyword">COMMIT</span>;</code></pre>

                <div class="info-box danger">
                    <div class="info-box-title">üö® –ü—Ä–æ–±–ª–µ–º–∞</div>
                    <p>
                        –ï—Å–ª–∏ –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, 
                        –∞ –æ–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å ‚Äî –ø–æ–ª—É—á–∞–µ–º –≥–æ–Ω–∫—É. –¢–∏–ø–∏—á–Ω—ã–π –ø—Ä–∏–º–µ—Ä: 
                        "–ø—Ä–æ–≤–µ—Ä–∏–ª–∏ –±–∞–ª–∞–Ω—Å ‚Üí —Ä–µ—à–∏–ª–∏ —Å–ø–∏—Å–∞—Ç—å ‚Üí –±–∞–ª–∞–Ω—Å —É–∂–µ –¥—Ä—É–≥–æ–π".
                    </p>
                </div>

                <h3>–†–µ—à–µ–Ω–∏–µ: REPEATABLE READ –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞</h3>

<pre><code><span class="comment">-- –í–∞—Ä–∏–∞–Ω—Ç 1: –£—Ä–æ–≤–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏ RR</span>
<span class="keyword">BEGIN</span>;
<span class="keyword">SET TRANSACTION ISOLATION LEVEL</span> REPEATABLE READ;
<span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> user_id = <span class="number">1</span>;
<span class="comment">-- –í—Å–µ–≥–¥–∞ –≤–µ—Ä–Ω—ë—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</span>

<span class="comment">-- –í–∞—Ä–∏–∞–Ω—Ç 2: –Ø–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ)</span>
<span class="keyword">BEGIN</span>;
<span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> user_id = <span class="number">1</span> <span class="keyword">FOR UPDATE</span>;
<span class="comment">-- –ë–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–æ –∫–æ–Ω—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</span></code></pre>

                <h2>SELECT FOR UPDATE: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ Race Condition</h2>
                
                <p>
                    –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞: –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å–ø–∏—Å—ã–≤–∞—é—Ç –¥–µ–Ω—å–≥–∏. 
                    –ë–∞–ª–∞–Ω—Å 1000, –∫–∞–∂–¥—ã–π —Ö–æ—á–µ—Ç —Å–ø–∏—Å–∞—Ç—å 600. –ë–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±–∞ –ø—Ä–æ—á–∏—Ç–∞—é—Ç 1000 
                    –∏ –æ–±–∞ —Å–ø–∏—à—É—Ç ‚Äî –±–∞–ª–∞–Ω—Å —Å—Ç–∞–Ω–µ—Ç -200.
                </p>

                <div class="comparison-table">
                    <div class="comparison-col bad">
                        <h4>‚ùå Race Condition</h4>
<pre><code><span class="comment"># –î–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</span>
<span class="comment"># –û–±–∞ —á–∏—Ç–∞—é—Ç balance = 1000</span>

balance = session.query(Account.balance)\\
    .filter_by(id=<span class="number">1</span>).scalar()

<span class="keyword">if</span> balance >= amount:
    <span class="comment"># –û–±–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø—Ä–æ–≤–µ—Ä–∫—É!</span>
    session.execute(
        update(Account)
        .where(Account.id == <span class="number">1</span>)
        .values(balance=balance - amount)
    )
<span class="comment"># –ë–∞–ª–∞–Ω—Å: -200 üí•</span></code></pre>
                    </div>
                    <div class="comparison-col good">
                        <h4>‚úÖ FOR UPDATE</h4>
<pre><code><span class="comment"># –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –∂–¥—ë—Ç</span>
<span class="comment"># –ø–æ–∫–∞ –ø–µ—Ä–≤—ã–π –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</span>

account = session.query(Account)\\
    .filter_by(id=<span class="number">1</span>)\\
    .with_for_update()\\  <span class="comment"># –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞!</span>
    .one()

<span class="keyword">if</span> account.balance >= amount:
    account.balance -= amount
    session.commit()
<span class="comment"># –ë–∞–ª–∞–Ω—Å: 400 ‚úÖ</span></code></pre>
                    </div>
                </div>

                <h3>–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è</h3>

<pre><code><span class="comment"># src/scaletrade/infrastructure/database/repositories/account.py</span>
<span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal
<span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> select
<span class="keyword">from</span> sqlalchemy.ext.asyncio <span class="keyword">import</span> AsyncSession

<span class="keyword">from</span> scaletrade.domain.exceptions <span class="keyword">import</span> InsufficientFundsError
<span class="keyword">from</span> scaletrade.infrastructure.database.models <span class="keyword">import</span> Account


<span class="keyword">class</span> <span class="class-name">AccountRepository</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(self, session: AsyncSession) -> <span class="keyword">None</span>:
        self._session = session
    
    <span class="keyword">async def</span> <span class="function">withdraw</span>(
        self, 
        account_id: <span class="type">int</span>, 
        amount: Decimal
    ) -> Account:
        <span class="string">"""
        –ê—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π.
        
        FOR UPDATE –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–æ –∫–æ–Ω—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
        –î—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±—É–¥—É—Ç –∂–¥–∞—Ç—å –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç –æ—à–∏–±–∫—É.
        """</span>
        stmt = (
            select(Account)
            .where(Account.id == account_id)
            .with_for_update()  <span class="comment"># –ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç!</span>
        )
        
        result = <span class="keyword">await</span> self._session.execute(stmt)
        account = result.scalar_one_or_none()
        
        <span class="keyword">if</span> account <span class="keyword">is None</span>:
            <span class="keyword">raise</span> ValueError(<span class="string">f"Account {account_id} not found"</span>)
        
        <span class="keyword">if</span> account.balance < amount:
            <span class="keyword">raise</span> InsufficientFundsError(
                <span class="string">f"Account {account_id} has {account.balance}, "</span>
                <span class="string">f"but {amount} required"</span>
            )
        
        account.balance -= amount
        <span class="keyword">return</span> account
    
    <span class="keyword">async def</span> <span class="function">deposit</span>(
        self, 
        account_id: <span class="type">int</span>, 
        amount: Decimal
    ) -> Account:
        <span class="string">"""–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Äî —Ç–æ–∂–µ –Ω—É–∂–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏."""</span>
        stmt = (
            select(Account)
            .where(Account.id == account_id)
            .with_for_update()
        )
        
        result = <span class="keyword">await</span> self._session.execute(stmt)
        account = result.scalar_one()
        
        account.balance += amount
        <span class="keyword">return</span> account</code></pre>

                <h2>SKIP LOCKED: –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –Ω–∞ Postgres</h2>
                
                <p>
                    <strong>–ó–∞–¥–∞—á–∞:</strong> –ù–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤ —Ä–∞–∑–±–∏—Ä–∞—é—Ç –∑–∞–¥–∞—á–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã. 
                    –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å —Ç–æ–≥–æ, —á—Ç–æ–±—ã –¥–≤–∞ –≤–æ—Ä–∫–µ—Ä–∞ –≤–∑—è–ª–∏ –æ–¥–Ω—É –∑–∞–¥–∞—á—É?
                </p>
                
                <p>
                    <code>SKIP LOCKED</code> –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤–º–µ—Å—Ç–æ –æ–∂–∏–¥–∞–Ω–∏—è:
                </p>

<pre><code><span class="comment">-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á</span>
<span class="keyword">CREATE TABLE</span> task_queue (
    id BIGINT <span class="keyword">GENERATED ALWAYS AS IDENTITY PRIMARY KEY</span>,
    payload JSONB <span class="keyword">NOT NULL</span>,
    status VARCHAR(20) <span class="keyword">DEFAULT</span> 'pending',
    locked_at TIMESTAMPTZ,
    processed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ <span class="keyword">DEFAULT</span> now()
);

<span class="comment">-- –í–æ—Ä–∫–µ—Ä –±–µ—Ä—ë—Ç –∑–∞–¥–∞—á—É</span>
<span class="keyword">UPDATE</span> task_queue
<span class="keyword">SET</span> 
    status = 'processing',
    locked_at = now()
<span class="keyword">WHERE</span> id = (
    <span class="keyword">SELECT</span> id <span class="keyword">FROM</span> task_queue
    <span class="keyword">WHERE</span> status = 'pending'
    <span class="keyword">ORDER BY</span> created_at
    <span class="keyword">LIMIT</span> 1
    <span class="keyword">FOR UPDATE SKIP LOCKED</span>  <span class="comment">-- –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ!</span>
)
<span class="keyword">RETURNING</span> *;</code></pre>

                <h3>–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ SQLAlchemy</h3>

<pre><code><span class="comment"># src/scaletrade/infrastructure/database/repositories/task_queue.py</span>
<span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> select, update
<span class="keyword">from</span> sqlalchemy.ext.asyncio <span class="keyword">import</span> AsyncSession

<span class="keyword">from</span> scaletrade.infrastructure.database.models <span class="keyword">import</span> Task, TaskStatus


<span class="keyword">class</span> <span class="class-name">TaskQueueRepository</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(self, session: AsyncSession) -> <span class="keyword">None</span>:
        self._session = session
    
    <span class="keyword">async def</span> <span class="function">claim_next_task</span>(self) -> Task | <span class="keyword">None</span>:
        <span class="string">"""
        –ê—Ç–æ–º–∞—Ä–Ω–æ –∑–∞–±–∏—Ä–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –∑–∞–¥–∞—á—É –∏–∑ –æ—á–µ—Ä–µ–¥–∏.
        SKIP LOCKED –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –¥–≤–∞ –≤–æ—Ä–∫–µ—Ä–∞ –Ω–µ –≤–æ–∑—å–º—É—Ç –æ–¥–Ω—É –∑–∞–¥–∞—á—É.
        """</span>
        <span class="comment"># –ü–æ–¥–∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—ã–±–æ—Ä–∞ ID</span>
        subq = (
            select(Task.id)
            .where(Task.status == TaskStatus.PENDING)
            .order_by(Task.created_at)
            .limit(<span class="number">1</span>)
            .with_for_update(skip_locked=<span class="keyword">True</span>)
            .scalar_subquery()
        )
        
        <span class="comment"># UPDATE —Å RETURNING</span>
        stmt = (
            update(Task)
            .where(Task.id == subq)
            .values(
                status=TaskStatus.PROCESSING,
                locked_at=func.now()
            )
            .returning(Task)
        )
        
        result = <span class="keyword">await</span> self._session.execute(stmt)
        <span class="keyword">return</span> result.scalar_one_or_none()
    
    <span class="keyword">async def</span> <span class="function">complete_task</span>(self, task_id: <span class="type">int</span>) -> <span class="keyword">None</span>:
        <span class="string">"""–ü–æ–º–µ—á–∞–µ–º –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é."""</span>
        stmt = (
            update(Task)
            .where(Task.id == task_id)
            .values(
                status=TaskStatus.COMPLETED,
                processed_at=func.now()
            )
        )
        <span class="keyword">await</span> self._session.execute(stmt)</code></pre>

                <h2>Deadlocks: –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∏ –∫–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å</h2>
                
                <p><strong>Deadlock</strong> ‚Äî –≤–∑–∞–∏–º–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –∫–æ–≥–¥–∞ –¥–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∂–¥—É—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞.</p>

<pre><code><span class="comment">-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 1</span>
<span class="keyword">BEGIN</span>;
<span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance = balance - <span class="number">100</span> <span class="keyword">WHERE</span> id = <span class="number">1</span>;  <span class="comment">-- –ë–ª–æ–∫–∏—Ä—É–µ—Ç id=1</span>
<span class="comment">-- ... –∂–¥—ë—Ç ...</span>
<span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance = balance + <span class="number">100</span> <span class="keyword">WHERE</span> id = <span class="number">2</span>;  <span class="comment">-- –ñ–¥—ë—Ç id=2</span>

<span class="comment">-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 2 (–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)</span>
<span class="keyword">BEGIN</span>;
<span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance = balance - <span class="number">50</span> <span class="keyword">WHERE</span> id = <span class="number">2</span>;   <span class="comment">-- –ë–ª–æ–∫–∏—Ä—É–µ—Ç id=2</span>
<span class="comment">-- ... –∂–¥—ë—Ç ...</span>
<span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance = balance + <span class="number">50</span> <span class="keyword">WHERE</span> id = <span class="number">1</span>;   <span class="comment">-- –ñ–¥—ë—Ç id=1</span>

<span class="comment">-- üí• DEADLOCK! PostgreSQL –æ—Ç–∫–∞—Ç–∏—Ç –æ–¥–Ω—É –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</span></code></pre>

                <div class="info-box tip">
                    <div class="info-box-title">‚úÖ –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å Deadlock</div>
                    <ul>
                        <li><strong>–ï–¥–∏–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:</strong> –í—Å–µ–≥–¥–∞ –±–ª–æ–∫–∏—Ä—É–π —Ä–µ—Å—É—Ä—Å—ã –≤ –æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é ID)</li>
                        <li><strong>–ö–æ—Ä–æ—Ç–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</strong> –ß–µ–º –∫–æ—Ä–æ—á–µ ‚Äî —Ç–µ–º –º–µ–Ω—å—à–µ —à–∞–Ω—Å –ø–µ—Ä–µ—Å–µ—á—å—Å—è</li>
                        <li><strong>NOWAIT:</strong> –ù–µ –∂–¥–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É, –∞ —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∏—Ç—å –æ—à–∏–±–∫—É</li>
                        <li><strong>Lock timeout:</strong> –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è</li>
                    </ul>
                </div>

                <h3>–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏</h3>

<pre><code><span class="comment"># src/scaletrade/application/services/transfer_service.py</span>
<span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal
<span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> select
<span class="keyword">from</span> sqlalchemy.ext.asyncio <span class="keyword">import</span> AsyncSession

<span class="keyword">from</span> scaletrade.infrastructure.database.models <span class="keyword">import</span> Account


<span class="keyword">class</span> <span class="class-name">TransferService</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(self, session: AsyncSession) -> <span class="keyword">None</span>:
        self._session = session
    
    <span class="keyword">async def</span> <span class="function">transfer</span>(
        self,
        from_account_id: <span class="type">int</span>,
        to_account_id: <span class="type">int</span>,
        amount: Decimal
    ) -> <span class="keyword">None</span>:
        <span class="string">"""
        –ê—Ç–æ–º–∞—Ä–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏.
        
        –ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç: –±–ª–æ–∫–∏—Ä—É–µ–º —Å—á–µ—Ç–∞ –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è ID,
        —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å deadlock.
        """</span>
        <span class="comment"># –°–æ—Ä—Ç–∏—Ä—É–µ–º ID –¥–ª—è –µ–¥–∏–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫</span>
        account_ids = sorted([from_account_id, to_account_id])
        
        <span class="comment"># –ë–ª–æ–∫–∏—Ä—É–µ–º –æ–±–∞ —Å—á—ë—Ç–∞ –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ</span>
        stmt = (
            select(Account)
            .where(Account.id.in_(account_ids))
            .order_by(Account.id)  <span class="comment"># –í–∞–∂–Ω–æ: –ø–æ—Ä—è–¥–æ–∫!</span>
            .with_for_update()
        )
        
        result = <span class="keyword">await</span> self._session.execute(stmt)
        accounts = {acc.id: acc <span class="keyword">for</span> acc <span class="keyword">in</span> result.scalars().all()}
        
        <span class="keyword">if</span> len(accounts) != <span class="number">2</span>:
            <span class="keyword">raise</span> ValueError(<span class="string">"One or both accounts not found"</span>)
        
        from_acc = accounts[from_account_id]
        to_acc = accounts[to_account_id]
        
        <span class="keyword">if</span> from_acc.balance < amount:
            <span class="keyword">raise</span> InsufficientFundsError(
                <span class="string">f"Insufficient funds: {from_acc.balance} < {amount}"</span>
            )
        
        <span class="comment"># –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</span>
        from_acc.balance -= amount
        to_acc.balance += amount
        
        <span class="comment"># Commit –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –≤—ã—à–µ (Unit of Work)</span></code></pre>

                <h2>Advisory Locks: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h2>
                
                <p>
                    –ò–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–µ —Å—Ç—Ä–æ–∫—É, –∞ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ä–µ—Å—É—Ä—Å 
                    (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ä–¥–µ—Ä–∞ #123"). –î–ª—è —ç—Ç–æ–≥–æ –µ—Å—Ç—å <strong>Advisory Locks</strong>:
                </p>

<pre><code><span class="comment"># –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ —á–∏—Å–ª–æ–≤–æ–º—É –∫–ª—é—á—É</span>
<span class="keyword">async def</span> <span class="function">process_order_exclusively</span>(
    session: AsyncSession, 
    order_id: <span class="type">int</span>
) -> <span class="keyword">None</span>:
    <span class="string">"""
    pg_advisory_xact_lock ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ –∫–æ–Ω—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
    –ß–∏—Å–ª–æ ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ä–µ—Å—É—Ä—Å–∞.
    """</span>
    <span class="comment"># –ü–æ–ª—É—á–∞–µ–º —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É</span>
    <span class="keyword">await</span> session.execute(
        text(<span class="string">"SELECT pg_advisory_xact_lock(:key)"</span>),
        {<span class="string">"key"</span>: order_id}
    )
    
    <span class="comment"># –¢–µ–ø–µ—Ä—å –º—ã –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ, –∫—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç –æ—Ä–¥–µ—Ä</span>
    <span class="comment"># –î—Ä—É–≥–∏–µ –≤—ã–∑–æ–≤—ã —Å —Ç–µ–º –∂–µ order_id –±—É–¥—É—Ç –∂–¥–∞—Ç—å</span>
    
    order = <span class="keyword">await</span> get_order(session, order_id)
    <span class="keyword">await</span> process_order(order)
    <span class="comment"># –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω–∏–º–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ commit/rollback</span>


<span class="comment"># –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞</span>
<span class="keyword">async def</span> <span class="function">try_process_order</span>(
    session: AsyncSession, 
    order_id: <span class="type">int</span>
) -> <span class="type">bool</span>:
    <span class="string">"""–ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è."""</span>
    result = <span class="keyword">await</span> session.execute(
        text(<span class="string">"SELECT pg_try_advisory_xact_lock(:key)"</span>),
        {<span class="string">"key"</span>: order_id}
    )
    acquired = result.scalar()
    
    <span class="keyword">if not</span> acquired:
        <span class="comment"># –ö—Ç–æ-—Ç–æ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç –æ—Ä–¥–µ—Ä</span>
        <span class="keyword">return</span> <span class="keyword">False</span>
    
    <span class="keyword">await</span> process_order(order_id)
    <span class="keyword">return</span> <span class="keyword">True</span></code></pre>

                <h2>ü™® –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏ –∏ —á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏</h2>

                <div class="info-box danger">
                    <div class="info-box-title">‚ùå –û—à–∏–±–∫–∞ #1: –ó–∞–±—ã–ª–∏ –ø—Ä–æ –∏–∑–æ–ª—è—Ü–∏—é</div>
                    <p><strong>–°–∏–º–ø—Ç–æ–º:</strong> –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ç–∞–ª –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º, —Ö–æ—Ç—è –ø—Ä–æ–≤–µ—Ä—è–ª–∏ –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º.</p>
                    <pre><code class="language-python"># –ü–õ–û–•–û ‚ùå
async def withdraw(user_id: int, amount: Decimal):
    balance = await get_balance(user_id)  # SELECT –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    if balance >= amount:
        await update_balance(user_id, balance - amount)  # Race condition!
    else:
        raise InsufficientFunds()</code></pre>
                    <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SELECT FOR UPDATE –∏–ª–∏ Repeatable Read + –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.</p>
                </div>

                <div class="info-box danger">
                    <div class="info-box-title">‚ùå –û—à–∏–±–∫–∞ #2: Deadlock –≤ production</div>
                    <p><strong>–°–∏–º–ø—Ç–æ–º:</strong> <code>deadlock detected</code> –≤ –ª–æ–≥–∞—Ö, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è.</p>
                    <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ —Ä–∞–∑–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ:</p>
                    <pre><code class="language-python"># Transaction 1: –±–ª–æ–∫–∏—Ä—É–µ—Ç A, –ø–æ—Ç–æ–º B
# Transaction 2: –±–ª–æ–∫–∏—Ä—É–µ—Ç B, –ø–æ—Ç–æ–º A
# ‚Üí Deadlock!</code></pre>
                    <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –í—Å–µ–≥–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã –≤ –æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ID).</p>
                    <pre><code class="language-python"># –•–û–†–û–®–û ‚úÖ
async def transfer(from_id: int, to_id: int, amount: Decimal):
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º ID –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è deadlock
    ids = sorted([from_id, to_id])
    
    stmt = (
        select(Account)
        .where(Account.id.in_(ids))
        .with_for_update()
        .order_by(Account.id)  # –í–∞–∂–Ω–æ!
    )
    accounts = await session.execute(stmt)</code></pre>
                </div>

                <div class="info-box danger">
                    <div class="info-box-title">‚ùå –û—à–∏–±–∫–∞ #3: –î–æ–ª–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
                    <p><strong>–°–∏–º–ø—Ç–æ–º:</strong> –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç–æ—Ä–º–æ–∑–∏—Ç, VACUUM –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –±–∞–∑–∞ —Ä–∞–∑–¥—É–≤–∞–µ—Ç—Å—è.</p>
                    <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> –û—Ç–∫—Ä—ã—Ç–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–µ—Ä–∂–∏—Ç snapshots, PostgreSQL –Ω–µ –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫.</p>
                    <pre><code class="language-sql">-- –ù–∞–π—Ç–∏ –¥–æ–ª–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
SELECT pid, usename, state, now() - xact_start AS duration, query
FROM pg_stat_activity
WHERE state != 'idle'
  AND xact_start IS NOT NULL
ORDER BY xact_start
LIMIT 10;</code></pre>
                    <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong></p>
                    <ul>
                        <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>statement_timeout</code> –∏ <code>idle_in_transaction_session_timeout</code></li>
                        <li>–ù–µ –¥–µ—Ä–∂–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –æ—Ç–∫—Ä—ã—Ç–æ–π –¥–æ–ª—å—à–µ 5-10 —Å–µ–∫—É–Ω–¥</li>
                        <li>–í—ã–Ω–æ—Å–∏—Ç–µ —Ç—è–∂—ë–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (HTTP –≤—ã–∑–æ–≤—ã, —Ñ–∞–π–ª—ã) –ó–ê —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</li>
                    </ul>
                </div>

                <div class="info-box danger">
                    <div class="info-box-title">‚ùå –û—à–∏–±–∫–∞ #4: Serialization failures –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è</div>
                    <p><strong>–°–∏–º–ø—Ç–æ–º:</strong> <code>could not serialize access due to concurrent update</code> ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∏–ª–∞—Å—å, –∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–ø–∞–ª–æ.</p>
                    <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –ü–æ–≤—Ç–æ—Ä—è—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ serialization errors (–Ω–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º!):</p>
                    <pre><code class="language-python"># –•–û–†–û–®–û ‚úÖ
from tenacity import retry, retry_if_exception_type, stop_after_attempt
from sqlalchemy.exc import OperationalError

@retry(
    retry=retry_if_exception_type(OperationalError),
    stop=stop_after_attempt(3),
    reraise=True
)
async def safe_transaction(func):
    async with session.begin():
        try:
            return await func()
        except OperationalError as e:
            if "could not serialize" in str(e):
                raise  # –ü–æ–∑–≤–æ–ª—è–µ–º tenacity –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
            raise  # –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º</code></pre>
                </div>

                <h2>üí° –õ–∞–π—Ñ—Ö–∞–∫–∏ –∏ Best Practices</h2>

                <div class="info-box tip">
                    <div class="info-box-title">‚úÖ –õ–∞–π—Ñ—Ö–∞–∫ #1: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ CTE –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</div>
                    <p>–í–º–µ—Å—Ç–æ SELECT + UPDATE –¥–µ–ª–∞–π—Ç–µ –≤—Å—ë –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ:</p>
                    <pre><code class="language-sql">-- –ê—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –±–∞–ª–∞–Ω—Å–∞
WITH updated AS (
    UPDATE accounts
    SET balance = balance - :amount
    WHERE user_id = :user_id
      AND balance >= :amount  -- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Å–∞–º–æ–º UPDATE!
    RETURNING *
)
INSERT INTO transactions (user_id, amount, type)
SELECT user_id, :amount, 'withdrawal'
FROM updated;</code></pre>
                    <p>–ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî UPDATE –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è, INSERT —Ç–æ–∂–µ. –ê—Ç–æ–º–∞—Ä–Ω–æ!</p>
                </div>

                <div class="info-box tip">
                    <div class="info-box-title">‚úÖ –õ–∞–π—Ñ—Ö–∞–∫ #2: SKIP LOCKED –¥–ª—è job queues</div>
                    <p>–ù–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∑–∞–¥–∞—á–∏ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:</p>
                    <pre><code class="language-python">async def get_next_job(worker_id: int):
    stmt = (
        update(Job)
        .where(Job.status == "pending")
        .values(status="processing", worker_id=worker_id)
        .returning(Job)
        .with_for_update(skip_locked=True)  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ!
        .limit(1)
    )
    result = await session.execute(stmt)
    return result.scalar_one_or_none()</code></pre>
                </div>

                <div class="info-box tip">
                    <div class="info-box-title">‚úÖ –õ–∞–π—Ñ—Ö–∞–∫ #3: –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Ä–µ–¥–∫–∏—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤</div>
                    <p>–ï—Å–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Ä–µ–¥–∫–∏ ‚Äî –Ω–µ –±–ª–æ–∫–∏—Ä—É–π—Ç–µ, –∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ version:</p>
                    <pre><code class="language-python">@dataclass
class Order:
    id: int
    quantity: Decimal
    version: int  # Incrementing version column

async def update_order(order_id: int, new_quantity: Decimal):
    # –ß–∏—Ç–∞–µ–º –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    order = await session.get(Order, order_id)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–µ—Ä—Å–∏–∏
    stmt = (
        update(Order)
        .where(Order.id == order_id, Order.version == order.version)
        .values(quantity=new_quantity, version=order.version + 1)
    )
    result = await session.execute(stmt)
    
    if result.rowcount == 0:
        raise ConcurrentModificationError("Order was modified")</code></pre>
                </div>

                <div class="info-box tip">
                    <div class="info-box-title">‚úÖ –õ–∞–π—Ñ—Ö–∞–∫ #4: Row-level locks –≤–º–µ—Å—Ç–æ table locks</div>
                    <p>PostgreSQL –±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫, –Ω–æ –∏–Ω–æ–≥–¥–∞ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç table lock. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:</p>
                    <pre><code class="language-sql">-- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö —Å—Ç—Ä–æ–∫
SELECT * FROM orders
WHERE user_id = :user_id
FOR UPDATE OF orders;  -- –¢–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü–∞ orders, –Ω–µ –¥–∂–æ–π–Ω—ã!

-- –ò–ª–∏ —Å NOWAIT –¥–ª—è fail-fast
SELECT * FROM orders
WHERE id = :order_id
FOR UPDATE NOWAIT;</code></pre>
                </div>

                <div class="info-box tip">
                    <div class="info-box-title">‚úÖ –õ–∞–π—Ñ—Ö–∞–∫ #5: –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</div>
                    <p>–î–æ–±–∞–≤—å—Ç–µ query –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:</p>
                    <pre><code class="language-sql">-- –ö—Ç–æ –∫–æ–≥–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks 
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;</code></pre>
                    <p>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ Prometheus –∏ –∞–ª–µ—Ä—Ç–∏—Ç–µ –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞—Ö!</p>
                </div>

                <h2>üìä –ß—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å</h2>

                <table>
                    <thead>
                        <tr>
                            <th>–ú–µ—Ç—Ä–∏–∫–∞</th>
                            <th>–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç</th>
                            <th>–¢—Ä–µ–≤–æ–≥–∞ –ø—Ä–∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>pg_stat_activity.xact_start</code></td>
                            <td>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</td>
                            <td>> 10 —Å–µ–∫—É–Ω–¥</td>
                        </tr>
                        <tr>
                            <td><code>pg_stat_database.deadlocks</code></td>
                            <td>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ deadlocks</td>
                            <td>> 0 (—Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å)</td>
                        </tr>
                        <tr>
                            <td><code>pg_locks.granted = false</code></td>
                            <td>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</td>
                            <td>> 5 –æ–∂–∏–¥–∞—é—â–∏—Ö</td>
                        </tr>
                        <tr>
                            <td><code>pg_stat_database.tup_updated</code></td>
                            <td>–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏</td>
                            <td>–ê–Ω–æ–º–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç (hot updates?)</td>
                        </tr>
                    </tbody>
                </table>

                <h2>ü™® –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏</h2>
                <div class="accordion">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>1. Deadlocks –Ω–∞ –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–∞—Ö</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–í—Å—Ç–∞–≤–ª—è—è —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É —Å FK, –≤—ã –±–µ—Ä–µ—Ç–µ `ShareLock` –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –∑–∞–ø–∏—Å—å. –ï—Å–ª–∏ –¥–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—Å—Ç–∞–≤–ª—è—é—Ç "–¥–æ—á–µ–∫" –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç "—Ä–æ–¥–∏—Ç–µ–ª–µ–π" –≤ —Ä–∞–∑–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ ‚Äî —ç—Ç–æ Deadlock. –ò–Ω–¥–µ–∫—Å –Ω–∞ FK —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, –Ω–æ –Ω–µ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—É.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>2. FOR UPDATE –±–µ–∑ ORDER BY</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ó–∞–ø—Ä–æ—Å <code>SELECT ... FOR UPDATE LIMIT 1</code> –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º. –û–Ω –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ª—é–±—É—é —Å—Ç—Ä–æ–∫—É. –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–∞–∫–æ–π –∑–∞–ø—Ä–æ—Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –º–Ω–æ–≥–æ Deadlock'–æ–≤ –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ Postgres —Ä–µ—à–∏–ª —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ü–æ–≤.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>3. Idle in Transaction</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–µ–ª–∞–π—Ç–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã –∏–ª–∏ —Ç—è–∂–µ–ª—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏—Å–∏—Ç ‚Äî autovacuum –Ω–µ –º–æ–∂–µ—Ç –ø–æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫ (bloat), –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–µ—Ä–∂–∞—Ç—Å—è. –†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –≤—Å–µ–π –±–∞–∑—ã.</p>
                        </div>
                    </div>
                </div>

                <h2>üí° –õ–∞–π—Ñ—Ö–∞–∫–∏</h2>
                <ul>
                    <li><strong>Advisory Locks:</strong> –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å "–∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ä–µ—Å—É—Ä—Å" (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç—á–µ—Ç–∞"), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>pg_advisory_xact_lock(hash('report_name'))</code>. –≠—Ç–æ –¥–µ—à–µ–≤–ª–µ –∏ –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å –ø–æ–ª–µ –≤ –±–∞–∑–µ.</li>
                    <li><strong>SKIP LOCKED:</strong> –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π –∑–∞–¥–∞—á –Ω–∞ –±–∞–∑–µ. <code>SELECT * FROM tasks WHERE status='new' FOR UPDATE SKIP LOCKED LIMIT 1</code>. –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤–æ—Ä–∫–µ—Ä–∞–º –Ω–µ –º–µ—à–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥—É.</li>
                    <li><strong>Statement Timeout:</strong> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 30 —Å–µ–∫—É–Ω–¥). –≠—Ç–æ —Å–ø–∞—Å–µ—Ç –±–∞–∑—É, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç "—Ç—è–∂–µ–ª—ã–π SELECT" –≤ –ø—Ä–æ–¥–µ.</li>
                </ul>

                <div class="task-box">
                    <h4>üìã –ó–∞–¥–∞–Ω–∏–µ</h4>
                    <ul class="task-list">
                        <li>–ù–∞–ø–∏—à–∏ —Ç–µ—Å—Ç, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∏–π Race Condition –±–µ–∑ FOR UPDATE</li>
                        <li>–†–µ–∞–ª–∏–∑—É–π <code>AccountRepository.withdraw</code> —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π</li>
                        <li>–°–æ–∑–¥–∞–π –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á —Å SKIP LOCKED –∏ –¥–≤—É–º—è "–≤–æ—Ä–∫–µ—Ä–∞–º–∏" (–∫–æ—Ä—É—Ç–∏–Ω–∞–º–∏)</li>
                        <li>–ù–∞–ø–∏—à–∏ —Ç–µ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—ë—Ç Deadlock (–∏ –ø–æ–∫–∞–∂–∏, –∫–∞–∫ PostgreSQL –µ–≥–æ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç)</li>
                        <li>–†–µ–∞–ª–∏–∑—É–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏ —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π ID</li>
                        <li>–î–æ–±–∞–≤—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ–ª–≥–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ Prometheus</li>
                    </ul>
                </div>

                <div class="nav-footer">
                    <a href="part1_schema.html">
                        <div>
                            <div class="nav-label">–ù–∞–∑–∞–¥</div>
                            <div class="nav-title">‚Üê 1.1 –°—Ö–µ–º–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ</div>
                        </div>
                    </a>
                    <a href="part1_indexes.html">
                        <div>
                            <div class="nav-label">–î–∞–ª–µ–µ</div>
                            <div class="nav-title">1.3 –ò–Ω–¥–µ–∫—Å—ã ‚Üí</div>
                        </div>
                    </a>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
