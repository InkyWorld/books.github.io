<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2.2 Dependency Injection —Å Dishka ‚Äî ScaleTrade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="book-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üìà</div>
                    <span>ScaleTrade</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">–í–≤–µ–¥–µ–Ω–∏–µ</div>
                    <a href="index.html" class="nav-link"><span class="nav-link-icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="setup.html" class="nav-link"><span class="nav-link-icon">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 1: PostgreSQL</div>
                    <a href="part1_schema.html" class="nav-link"><span class="nav-link-icon">üìä</span>1.1 –°—Ö–µ–º–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ</a>
                    <a href="part1_transactions.html" class="nav-link"><span class="nav-link-icon">üîÑ</span>1.2 –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</a>
                    <a href="part1_indexes.html" class="nav-link"><span class="nav-link-icon">üîç</span>1.3 –ò–Ω–¥–µ–∫—Å—ã</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</div>
                    <a href="part2_litestar.html" class="nav-link"><span class="nav-link-icon">üöÄ</span>2.1 Litestar + DDD</a>
                    <a href="part2_dishka.html" class="nav-link active"><span class="nav-link-icon">üíâ</span>2.2 DI —Å Dishka</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 3: –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ</div>
                    <a href="part3_faststream.html" class="nav-link"><span class="nav-link-icon">üì®</span>3.1 RabbitMQ + Faststream</a>
                    <a href="part3_redis.html" class="nav-link"><span class="nav-link-icon">‚ö°</span>3.2 Redis Patterns</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 4: –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å</div>
                    <a href="part4_testing.html" class="nav-link"><span class="nav-link-icon">üß™</span>4.1 Advanced Testing</a>
                    <a href="part4_resiliency.html" class="nav-link"><span class="nav-link-icon">üõ°Ô∏è</span>4.2 Resiliency</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 5: Observability</div>
                    <a href="part5_logging.html" class="nav-link"><span class="nav-link-icon">üìù</span>5.1 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</a>
                    <a href="part5_clickhouse.html" class="nav-link"><span class="nav-link-icon">üìà</span>5.2 ClickHouse</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 6: Production</div>
                    <a href="part6_migrations.html" class="nav-link"><span class="nav-link-icon">üîÄ</span>6.1 Zero-Downtime</a>
                    <a href="part6_quality.html" class="nav-link"><span class="nav-link-icon">‚úÖ</span>6.2 Code Quality</a>
                    <a href="part6_django.html" class="nav-link"><span class="nav-link-icon">üîó</span>6.3 Django Admin</a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="breadcrumb">
                    <a href="index.html">ScaleTrade</a>
                    <span>/</span>
                    <span>–ß–∞—Å—Ç—å 2</span>
                    <span>/</span>
                    <span>2.2 DI —Å Dishka</span>
                </div>
            </header>

            <div class="page-content">
                <h1>–ú–æ–¥—É–ª—å 2.2: Dependency Injection —Å Dishka</h1>
                <p class="lead">
                    –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π IoC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Python. Scopes, –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã, Unit of Work ‚Äî 
                    –≤—Å—ë –¥–ª—è —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π –∏ –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.
                </p>

                <h2>–ó–∞—á–µ–º DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä?</h2>
                
                <p>FastAPI <code>Depends()</code> ‚Äî —ç—Ç–æ –Ω–µ DI, —ç—Ç–æ Service Locator. –ü—Ä–æ–±–ª–µ–º—ã:</p>
                
                <div class="comparison-table">
                    <div class="comparison-col bad">
                        <h4>‚ùå FastAPI Depends</h4>
<pre><code><span class="comment"># –ñ—ë—Å—Ç–∫–∞—è —Å–≤—è–∑—å —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π</span>
<span class="keyword">def</span> <span class="function">get_db</span>():
    <span class="keyword">return</span> SessionLocal()

<span class="decorator">@app.get</span>(<span class="string">"/orders"</span>)
<span class="keyword">def</span> <span class="function">get_orders</span>(
    db = Depends(get_db)  <span class="comment"># –ù–µ–ª—å–∑—è –ø–æ–¥–º–µ–Ω–∏—Ç—å</span>
):
    ...

<span class="comment"># –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å?</span>
<span class="comment"># app.dependency_overrides ‚Äî –≥–ª–æ–±–∞–ª—å–Ω–æ</span></code></pre>
                    </div>
                    <div class="comparison-col good">
                        <h4>‚úÖ Dishka</h4>
<pre><code><span class="comment"># –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</span>
<span class="keyword">class</span> <span class="class-name">DbProvider</span>(Provider):
    <span class="decorator">@provide</span>(scope=Scope.REQUEST)
    <span class="keyword">def</span> <span class="function">session</span>(self) -> AsyncSession:
        ...

<span class="comment"># –õ–µ–≥–∫–æ –ø–æ–¥–º–µ–Ω–∏—Ç—å –¥–ª—è —Ç–µ—Å—Ç–æ–≤</span>
container = make_container(
    TestDbProvider(),  <span class="comment"># –î—Ä—É–≥–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è</span>
)</code></pre>
                    </div>
                </div>

                <h2>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ Dishka</h2>

                <h3>Scopes: –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π</h3>

                <table>
                    <thead>
                        <tr>
                            <th>Scope</th>
                            <th>–í—Ä–µ–º—è –∂–∏–∑–Ω–∏</th>
                            <th>–ü—Ä–∏–º–µ—Ä—ã</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>APP</code></td>
                            <td>–í—Å—ë –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</td>
                            <td>Engine, Settings, Redis Pool</td>
                        </tr>
                        <tr>
                            <td><code>REQUEST</code></td>
                            <td>–û–¥–∏–Ω HTTP –∑–∞–ø—Ä–æ—Å</td>
                            <td>Session, UoW, —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</td>
                        </tr>
                        <tr>
                            <td><code>ACTION</code></td>
                            <td>–û–¥–Ω–∞ –±–∏–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü–∏—è</td>
                            <td>–í–ª–æ–∂–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Provider: —Ñ–∞–±—Ä–∏–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π</h3>

<pre><code><span class="comment"># src/scaletrade/di/providers.py</span>
<span class="keyword">from</span> dishka <span class="keyword">import</span> Provider, Scope, provide, make_async_container
<span class="keyword">from</span> sqlalchemy.ext.asyncio <span class="keyword">import</span> (
    AsyncEngine, AsyncSession, async_sessionmaker, create_async_engine
)

<span class="keyword">from</span> scaletrade.config <span class="keyword">import</span> Settings


<span class="keyword">class</span> <span class="class-name">DatabaseProvider</span>(Provider):
    <span class="string">"""–ü—Ä–æ–≤–∞–π–¥–µ—Ä –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î."""</span>
    
    <span class="decorator">@provide</span>(scope=Scope.APP)
    <span class="keyword">def</span> <span class="function">engine</span>(self, settings: Settings) -> AsyncEngine:
        <span class="string">"""
        Engine —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
        –°–æ–¥–µ—Ä–∂–∏—Ç –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.
        """</span>
        <span class="keyword">return</span> create_async_engine(
            settings.async_database_url,
            pool_size=settings.database_pool_size,
            max_overflow=settings.database_pool_overflow,
            echo=settings.debug,
        )
    
    <span class="decorator">@provide</span>(scope=Scope.APP)
    <span class="keyword">def</span> <span class="function">session_factory</span>(self, engine: AsyncEngine) -> async_sessionmaker[AsyncSession]:
        <span class="string">"""–§–∞–±—Ä–∏–∫–∞ —Å–µ—Å—Å–∏–π ‚Äî —Ç–æ–∂–µ singleton."""</span>
        <span class="keyword">return</span> async_sessionmaker(
            engine,
            class_=AsyncSession,
            expire_on_commit=<span class="keyword">False</span>,
        )
    
    <span class="decorator">@provide</span>(scope=Scope.REQUEST)
    <span class="keyword">async def</span> <span class="function">session</span>(
        self, 
        factory: async_sessionmaker[AsyncSession]
    ) -> AsyncSession:
        <span class="string">"""
        –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞—ë—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ.
        """</span>
        <span class="keyword">async with</span> factory() <span class="keyword">as</span> session:
            <span class="keyword">yield</span> session</code></pre>

                <h2>Unit of Work Pattern</h2>
                
                <p>
                    UoW –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ –≤—Å–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏. 
                    –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π.
                </p>

<pre><code><span class="comment"># src/scaletrade/application/uow.py</span>
<span class="keyword">from</span> typing <span class="keyword">import</span> Self
<span class="keyword">from</span> sqlalchemy.ext.asyncio <span class="keyword">import</span> AsyncSession

<span class="keyword">from</span> scaletrade.infrastructure.database.repositories <span class="keyword">import</span> (
    SQLAlchemyOrderRepository,
    SQLAlchemyAccountRepository,
)


<span class="keyword">class</span> <span class="class-name">UnitOfWork</span>:
    <span class="string">"""
    Unit of Work ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏.
    
    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
        async with uow:
            order = await uow.orders.get_by_id(order_id)
            order.cancel()
            await uow.commit()
    """</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(self, session: AsyncSession) -> <span class="keyword">None</span>:
        self._session = session
        self.orders = SQLAlchemyOrderRepository(session)
        self.accounts = SQLAlchemyAccountRepository(session)
    
    <span class="keyword">async def</span> <span class="function">__aenter__</span>(self) -> Self:
        <span class="keyword">return</span> self
    
    <span class="keyword">async def</span> <span class="function">__aexit__</span>(self, exc_type, exc_val, exc_tb) -> <span class="keyword">None</span>:
        <span class="keyword">if</span> exc_type <span class="keyword">is not None</span>:
            <span class="keyword">await</span> self.rollback()
    
    <span class="keyword">async def</span> <span class="function">commit</span>(self) -> <span class="keyword">None</span>:
        <span class="keyword">await</span> self._session.commit()
    
    <span class="keyword">async def</span> <span class="function">rollback</span>(self) -> <span class="keyword">None</span>:
        <span class="keyword">await</span> self._session.rollback()</code></pre>

                <h3>UoW Provider</h3>

<pre><code><span class="keyword">class</span> <span class="class-name">ApplicationProvider</span>(Provider):
    <span class="string">"""–ü—Ä–æ–≤–∞–π–¥–µ—Ä application-—Å–ª–æ—è."""</span>
    
    <span class="decorator">@provide</span>(scope=Scope.REQUEST)
    <span class="keyword">def</span> <span class="function">uow</span>(self, session: AsyncSession) -> UnitOfWork:
        <span class="keyword">return</span> UnitOfWork(session)
    
    <span class="decorator">@provide</span>(scope=Scope.REQUEST)
    <span class="keyword">def</span> <span class="function">order_service</span>(self, uow: UnitOfWork) -> OrderService:
        <span class="keyword">return</span> OrderService(uow=uow)
    
    <span class="decorator">@provide</span>(scope=Scope.REQUEST)
    <span class="keyword">def</span> <span class="function">account_service</span>(self, uow: UnitOfWork) -> AccountService:
        <span class="keyword">return</span> AccountService(uow=uow)</code></pre>

                <h2>–°–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞</h2>

<pre><code><span class="comment"># src/scaletrade/di/container.py</span>
<span class="keyword">from</span> dishka <span class="keyword">import</span> make_async_container, Provider, Scope, provide

<span class="keyword">from</span> scaletrade.config <span class="keyword">import</span> Settings, get_settings


<span class="keyword">class</span> <span class="class-name">SettingsProvider</span>(Provider):
    <span class="decorator">@provide</span>(scope=Scope.APP)
    <span class="keyword">def</span> <span class="function">settings</span>(self) -> Settings:
        <span class="keyword">return</span> get_settings()


<span class="keyword">def</span> <span class="function">create_container</span>():
    <span class="string">"""–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –≤—Å–µ–º–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏."""</span>
    <span class="keyword">return</span> make_async_container(
        SettingsProvider(),
        DatabaseProvider(),
        CacheProvider(),
        ApplicationProvider(),
    )</code></pre>

                <h2>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Litestar</h2>

<pre><code><span class="comment"># src/scaletrade/main.py</span>
<span class="keyword">from</span> litestar <span class="keyword">import</span> Litestar
<span class="keyword">from</span> dishka.integrations.litestar <span class="keyword">import</span> (
    setup_dishka,
    FromDishka,
    inject,
)

<span class="keyword">from</span> scaletrade.di.container <span class="keyword">import</span> create_container
<span class="keyword">from</span> scaletrade.interface.http.orders <span class="keyword">import</span> OrderController


<span class="keyword">def</span> <span class="function">create_app</span>() -> Litestar:
    container = create_container()
    
    app = Litestar(
        route_handlers=[OrderController],
        lifespan=[container],  <span class="comment"># –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ</span>
    )
    
    setup_dishka(container, app)
    <span class="keyword">return</span> app


<span class="comment"># –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ:</span>
<span class="keyword">from</span> dishka.integrations.litestar <span class="keyword">import</span> FromDishka

<span class="keyword">class</span> <span class="class-name">OrderController</span>(Controller):
    <span class="decorator">@get</span>(<span class="string">"/"</span>)
    <span class="keyword">async def</span> <span class="function">list_orders</span>(
        self,
        order_service: FromDishka[OrderService],  <span class="comment"># –ò–Ω—ä–µ–∫—Ü–∏—è!</span>
    ) -> <span class="type">list</span>[OrderResponse]:
        <span class="keyword">return await</span> order_service.list_orders()</code></pre>

                <h2>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–¥–º–µ–Ω–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π</h2>

<pre><code><span class="comment"># tests/conftest.py</span>
<span class="keyword">import</span> pytest
<span class="keyword">from</span> dishka <span class="keyword">import</span> make_async_container, Provider, provide, Scope
<span class="keyword">from</span> unittest.mock <span class="keyword">import</span> AsyncMock


<span class="keyword">class</span> <span class="class-name">MockOrderRepository</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(self):
        self.orders = {}
    
    <span class="keyword">async def</span> <span class="function">get_by_id</span>(self, order_id):
        <span class="keyword">return</span> self.orders.get(<span class="type">str</span>(order_id))
    
    <span class="keyword">async def</span> <span class="function">save</span>(self, order):
        self.orders[<span class="type">str</span>(order.id)] = order


<span class="keyword">class</span> <span class="class-name">TestProvider</span>(Provider):
    <span class="string">"""–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Å –º–æ–∫–∞–º–∏."""</span>
    
    <span class="decorator">@provide</span>(scope=Scope.APP)
    <span class="keyword">def</span> <span class="function">order_repo</span>(self) -> MockOrderRepository:
        <span class="keyword">return</span> MockOrderRepository()


<span class="decorator">@pytest.fixture</span>
<span class="keyword">async def</span> <span class="function">test_container</span>():
    container = make_async_container(
        TestProvider(),
        <span class="comment"># –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã...</span>
    )
    <span class="keyword">yield</span> container
    <span class="keyword">await</span> container.close()


<span class="decorator">@pytest.fixture</span>
<span class="keyword">async def</span> <span class="function">order_service</span>(test_container):
    <span class="keyword">async with</span> test_container() <span class="keyword">as</span> request_container:
        <span class="keyword">yield await</span> request_container.get(OrderService)</code></pre>

                <h3>–ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∞</h3>

<pre><code><span class="comment"># tests/unit/test_order_service.py</span>
<span class="keyword">import</span> pytest
<span class="keyword">from</span> scaletrade.application.dto.order <span class="keyword">import</span> CreateOrderDTO


<span class="decorator">@pytest.mark.asyncio</span>
<span class="keyword">async def</span> <span class="function">test_create_order</span>(order_service):
    <span class="comment"># Arrange</span>
    dto = CreateOrderDTO(
        user_id=<span class="number">1</span>,
        symbol=<span class="string">"BTC/USD"</span>,
        side=<span class="string">"BUY"</span>,
        quantity=<span class="string">"0.5"</span>,
        price=<span class="string">"50000.00"</span>,
    )
    
    <span class="comment"># Act</span>
    result = <span class="keyword">await</span> order_service.create_order(dto)
    
    <span class="comment"># Assert</span>
    <span class="keyword">assert</span> result.symbol == <span class="string">"BTC/USD"</span>
    <span class="keyword">assert</span> result.status == <span class="string">"pending"</span></code></pre>

                <h2>–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</h2>

                <h3>–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (Request Context)</h3>

<pre><code><span class="keyword">class</span> <span class="class-name">RequestContextProvider</span>(Provider):
    <span class="string">"""–ü—Ä–æ–≤–∞–π–¥–µ—Ä –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞."""</span>
    
    <span class="decorator">@provide</span>(scope=Scope.REQUEST)
    <span class="keyword">def</span> <span class="function">current_user</span>(self, request: Request) -> User:
        <span class="comment"># –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞</span>
        token = request.headers.get(<span class="string">"Authorization"</span>)
        <span class="keyword">return</span> decode_jwt_user(token)
    
    <span class="decorator">@provide</span>(scope=Scope.REQUEST)
    <span class="keyword">def</span> <span class="function">request_id</span>(self, request: Request) -> <span class="type">str</span>:
        <span class="keyword">return</span> request.headers.get(<span class="string">"X-Request-ID"</span>, uuid4().hex)</code></pre>

                <h3>–î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã —Å –∏–Ω—ä–µ–∫—Ü–∏–µ–π</h3>

<pre><code><span class="keyword">from</span> dishka.integrations.litestar <span class="keyword">import</span> inject


<span class="decorator">@inject</span>
<span class="keyword">async def</span> <span class="function">some_background_task</span>(
    order_service: FromDishka[OrderService],
) -> <span class="keyword">None</span>:
    <span class="string">"""–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ —Å DI."""</span>
    <span class="keyword">await</span> order_service.process_pending_orders()</code></pre>

                <h2>ü™® –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏</h2>
                <div class="accordion">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>1. Scope Mismatch</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–°–∞–º–∞—è —á–∞—Å—Ç–∞—è –æ—à–∏–±–∫–∞ ‚Äî –ø–æ–ø—ã—Ç–∫–∞ –≤–Ω–µ–¥—Ä–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Å <code>Scope.REQUEST</code> (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î) –≤ —Å–µ—Ä–≤–∏—Å —Å <code>Scope.APP</code> (—Å–∏–Ω–≥–ª—Ç–æ–Ω). Dishka –≤—ã–±—Ä–æ—Å–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –°–∏–Ω–≥–ª—Ç–æ–Ω—ã –Ω–µ –º–æ–≥—É—Ç –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>2. –õ–æ–≥–∏–∫–∞ –≤ __init__ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å "—Ç—É–ø—ã–º–∏" —Ñ–∞–±—Ä–∏–∫–∞–º–∏. –ù–µ –¥–µ–ª–∞–π—Ç–µ –≤—ã–∑–æ–≤—ã API –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î –≤ <code>__init__</code> –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞. –î–µ–ª–∞–π—Ç–µ —ç—Ç–æ –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥–æ–≤, –ø–æ–º–µ—á–µ–Ω–Ω—ã—Ö <code>@provide</code>, –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>scope=Scope.APP</code>.</p>
                        </div>
                    </div>
                </div>

                <h2>üí° –õ–∞–π—Ñ—Ö–∞–∫–∏</h2>
                <ul>
                    <li><strong>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞:</strong> –í Dishka –µ—Å—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –≥—Ä–∞—Ñ–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π. –≠—Ç–æ —Å–ø–∞—Å–∞–µ—Ç, –∫–æ–≥–¥–∞ –≥—Ä–∞—Ñ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –æ–≥—Ä–æ–º–Ω—ã–º –∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–º.</li>
                    <li><strong>–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è Task Queue:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ Celery/Dramatiq –≤–æ—Ä–∫–µ—Ä–∞—Ö. –°–æ–∑–¥–∞–≤–∞–π—Ç–µ scope –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ HTTP-–∑–∞–ø—Ä–æ—Å—É. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ –∫–æ–¥ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –≤ API, –∏ –≤ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö.</li>
                    <li><strong>Yield –≤–º–µ—Å—Ç–æ Return:</strong> –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>yield</code> –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (DB, HTTP Client). –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–æ–¥ –ø–æ—Å–ª–µ <code>yield</code> (–∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è) –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–ª—É—á–∏–ª–∞—Å—å –æ—à–∏–±–∫–∞.</li>
                </ul>

                <div class="task-box">
                    <h4>üìã –ó–∞–¥–∞–Ω–∏–µ</h4>
                    <ul class="task-list">
                        <li>–°–æ–∑–¥–∞–π <code>CacheProvider</code> –¥–ª—è Redis —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º scope</li>
                        <li>–†–µ–∞–ª–∏–∑—É–π <code>UnitOfWork</code> —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ orders –∏ accounts</li>
                        <li>–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π Dishka —Å Litestar –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º</li>
                        <li>–ù–∞–ø–∏—à–∏ —Ç–µ—Å—Ç —Å –ø–æ–¥–º–µ–Ω–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–∞ –º–æ–∫</li>
                        <li>–î–æ–±–∞–≤—å <code>RequestContextProvider</code> –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</li>
                    </ul>
                </div>

                <div class="nav-footer">
                    <a href="part2_litestar.html">
                        <div>
                            <div class="nav-label">–ù–∞–∑–∞–¥</div>
                            <div class="nav-title">‚Üê 2.1 Litestar + DDD</div>
                        </div>
                    </a>
                    <a href="part3_faststream.html">
                        <div>
                            <div class="nav-label">–î–∞–ª–µ–µ</div>
                            <div class="nav-title">3.1 RabbitMQ + Faststream ‚Üí</div>
                        </div>
                    </a>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
