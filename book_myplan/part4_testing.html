<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4.1 Advanced Testing ‚Äî ScaleTrade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="book-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üìà</div>
                    <span>ScaleTrade</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">–í–≤–µ–¥–µ–Ω–∏–µ</div>
                    <a href="index.html" class="nav-link"><span class="nav-link-icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="setup.html" class="nav-link"><span class="nav-link-icon">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 1: PostgreSQL</div>
                    <a href="part1_schema.html" class="nav-link"><span class="nav-link-icon">üìä</span>1.1 –°—Ö–µ–º–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ</a>
                    <a href="part1_transactions.html" class="nav-link"><span class="nav-link-icon">üîÑ</span>1.2 –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</a>
                    <a href="part1_indexes.html" class="nav-link"><span class="nav-link-icon">üîç</span>1.3 –ò–Ω–¥–µ–∫—Å—ã</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</div>
                    <a href="part2_litestar.html" class="nav-link"><span class="nav-link-icon">üöÄ</span>2.1 Litestar + DDD</a>
                    <a href="part2_dishka.html" class="nav-link"><span class="nav-link-icon">üíâ</span>2.2 DI —Å Dishka</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 3: –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ</div>
                    <a href="part3_faststream.html" class="nav-link"><span class="nav-link-icon">üì®</span>3.1 RabbitMQ + Faststream</a>
                    <a href="part3_redis.html" class="nav-link"><span class="nav-link-icon">‚ö°</span>3.2 Redis Patterns</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 4: –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å</div>
                    <a href="part4_testing.html" class="nav-link active"><span class="nav-link-icon">üß™</span>4.1 Advanced Testing</a>
                    <a href="part4_resiliency.html" class="nav-link"><span class="nav-link-icon">üõ°Ô∏è</span>4.2 Resiliency</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 5: Observability</div>
                    <a href="part5_logging.html" class="nav-link"><span class="nav-link-icon">üìù</span>5.1 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</a>
                    <a href="part5_clickhouse.html" class="nav-link"><span class="nav-link-icon">üìà</span>5.2 ClickHouse</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">–ß–∞—Å—Ç—å 6: Production</div>
                    <a href="part6_migrations.html" class="nav-link"><span class="nav-link-icon">üîÄ</span>6.1 Zero-Downtime</a>
                    <a href="part6_quality.html" class="nav-link"><span class="nav-link-icon">‚úÖ</span>6.2 Code Quality</a>
                    <a href="part6_django.html" class="nav-link"><span class="nav-link-icon">üîó</span>6.3 Django Admin</a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="breadcrumb">
                    <a href="index.html">ScaleTrade</a>
                    <span>/</span>
                    <span>–ß–∞—Å—Ç—å 4</span>
                    <span>/</span>
                    <span>4.1 Advanced Testing</span>
                </div>
            </header>

            <div class="page-content">
                <h1>–ú–æ–¥—É–ª—å 4.1: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
                <p class="lead">
                    Testcontainers, Hypothesis, —Å–ª–æ–∂–Ω—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã ‚Äî —Ç–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—ã.
                </p>

                <h2>–ü–∏—Ä–∞–º–∏–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
                
                <table>
                    <thead>
                        <tr>
                            <th>–£—Ä–æ–≤–µ–Ω—å</th>
                            <th>–°–∫–æ—Ä–æ—Å—Ç—å</th>
                            <th>–ò–∑–æ–ª—è—Ü–∏—è</th>
                            <th>–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Unit</strong></td>
                            <td>‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ</td>
                            <td>–ü–æ–ª–Ω–∞—è</td>
                            <td>–î–æ–º–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞, Value Objects</td>
                        </tr>
                        <tr>
                            <td><strong>Integration</strong></td>
                            <td>üöó –°–µ–∫—É–Ω–¥—ã</td>
                            <td>–ß–∞—Å—Ç–∏—á–Ω–∞—è</td>
                            <td>–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã</td>
                        </tr>
                        <tr>
                            <td><strong>E2E</strong></td>
                            <td>üê¢ –ú–∏–Ω—É—Ç—ã</td>
                            <td>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è</td>
                            <td>–ü–æ–ª–Ω—ã–π flow —á–µ—Ä–µ–∑ API</td>
                        </tr>
                    </tbody>
                </table>

                <h2>Testcontainers: —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏</h2>
                
                <p>
                    –ú–æ–∫–∏ –ë–î ‚Äî —ç—Ç–æ –ª–æ–∂–Ω–æ–µ —á—É–≤—Å—Ç–≤–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. 
                    Testcontainers –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π PostgreSQL –≤ Docker.
                </p>

<pre><code><span class="comment"># tests/conftest.py</span>
<span class="keyword">import</span> pytest
<span class="keyword">from</span> testcontainers.postgres <span class="keyword">import</span> PostgresContainer
<span class="keyword">from</span> testcontainers.rabbitmq <span class="keyword">import</span> RabbitMqContainer
<span class="keyword">from</span> testcontainers.redis <span class="keyword">import</span> RedisContainer
<span class="keyword">from</span> sqlalchemy.ext.asyncio <span class="keyword">import</span> create_async_engine, async_sessionmaker


<span class="decorator">@pytest.fixture</span>(scope=<span class="string">"session"</span>)
<span class="keyword">def</span> <span class="function">postgres_container</span>():
    <span class="string">"""
    PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ–π —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Å—Å–∏–∏.
    scope="session" ‚Äî –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –≤—Å–µ —Ç–µ—Å—Ç—ã (–±—ã—Å—Ç—Ä–µ–µ).
    """</span>
    <span class="keyword">with</span> PostgresContainer(<span class="string">"postgres:16-alpine"</span>) <span class="keyword">as</span> postgres:
        <span class="keyword">yield</span> postgres


<span class="decorator">@pytest.fixture</span>(scope=<span class="string">"session"</span>)
<span class="keyword">def</span> <span class="function">redis_container</span>():
    <span class="string">"""Redis –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä."""</span>
    <span class="keyword">with</span> RedisContainer(<span class="string">"redis:7-alpine"</span>) <span class="keyword">as</span> redis:
        <span class="keyword">yield</span> redis


<span class="decorator">@pytest.fixture</span>(scope=<span class="string">"session"</span>)
<span class="keyword">def</span> <span class="function">rabbitmq_container</span>():
    <span class="string">"""RabbitMQ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä."""</span>
    <span class="keyword">with</span> RabbitMqContainer(<span class="string">"rabbitmq:3.13-management-alpine"</span>) <span class="keyword">as</span> rabbitmq:
        <span class="keyword">yield</span> rabbitmq


<span class="decorator">@pytest.fixture</span>(scope=<span class="string">"session"</span>)
<span class="keyword">async def</span> <span class="function">engine</span>(postgres_container):
    <span class="string">"""SQLAlchemy engine –¥–ª—è —Ç–µ—Å—Ç–æ–≤."""</span>
    url = postgres_container.get_connection_url().replace(
        <span class="string">"postgresql://"</span>, <span class="string">"postgresql+asyncpg://"</span>
    )
    engine = create_async_engine(url, echo=<span class="keyword">False</span>)
    
    <span class="comment"># –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—ã</span>
    <span class="keyword">async with</span> engine.begin() <span class="keyword">as</span> conn:
        <span class="keyword">await</span> conn.run_sync(Base.metadata.create_all)
    
    <span class="keyword">yield</span> engine
    
    <span class="keyword">await</span> engine.dispose()


<span class="decorator">@pytest.fixture</span>
<span class="keyword">async def</span> <span class="function">session</span>(engine):
    <span class="string">"""
    –°–µ—Å—Å–∏—è –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞.
    
    scope="function" ‚Äî –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞.
    Rollback –≤ –∫–æ–Ω—Ü–µ ‚Äî —Ç–µ—Å—Ç—ã –Ω–µ –≤–ª–∏—è—é—Ç –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞.
    """</span>
    <span class="keyword">async with</span> engine.connect() <span class="keyword">as</span> conn:
        <span class="comment"># –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</span>
        <span class="keyword">await</span> conn.begin()
        
        session_factory = async_sessionmaker(
            bind=conn,
            expire_on_commit=<span class="keyword">False</span>,
        )
        
        <span class="keyword">async with</span> session_factory() <span class="keyword">as</span> session:
            <span class="keyword">yield</span> session
        
        <span class="comment"># –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º ‚Äî –¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</span>
        <span class="keyword">await</span> conn.rollback()</code></pre>

                <h2>–§–∏–∫—Å—Ç—É—Ä—ã: —Ñ–∞–±—Ä–∏–∫–∏ —Å—É—â–Ω–æ—Å—Ç–µ–π</h2>

<pre><code><span class="comment"># tests/factories.py</span>
<span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal
<span class="keyword">import</span> factory
<span class="keyword">from</span> factory <span class="keyword">import</span> fuzzy

<span class="keyword">from</span> scaletrade.domain.entities.order <span class="keyword">import</span> Order, OrderSide, OrderStatus
<span class="keyword">from</span> scaletrade.domain.value_objects <span class="keyword">import</span> OrderId, UserId, Money, Currency


<span class="keyword">class</span> <span class="class-name">OrderFactory</span>(factory.Factory):
    <span class="string">"""–§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤."""</span>
    
    <span class="keyword">class</span> <span class="class-name">Meta</span>:
        model = Order
    
    id = factory.LazyFunction(<span class="keyword">lambda</span>: OrderId.generate())
    user_id = factory.LazyFunction(<span class="keyword">lambda</span>: UserId(factory.Faker(<span class="string">"pyint"</span>)))
    symbol = fuzzy.FuzzyChoice([<span class="string">"BTC/USD"</span>, <span class="string">"ETH/USD"</span>, <span class="string">"SOL/USD"</span>])
    side = fuzzy.FuzzyChoice([OrderSide.BUY, OrderSide.SELL])
    quantity = factory.LazyFunction(
        <span class="keyword">lambda</span>: Money(Decimal(<span class="string">"0.5"</span>), Currency.USD)
    )
    price = factory.LazyFunction(
        <span class="keyword">lambda</span>: Money(Decimal(<span class="string">"50000.00"</span>), Currency.USD)
    )
    status = OrderStatus.PENDING


<span class="comment"># tests/conftest.py</span>
<span class="decorator">@pytest.fixture</span>
<span class="keyword">def</span> <span class="function">order_factory</span>():
    <span class="string">"""–§–∞–±—Ä–∏–∫–∞ –æ—Ä–¥–µ—Ä–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–æ–≤."""</span>
    <span class="keyword">return</span> OrderFactory


<span class="decorator">@pytest.fixture</span>
<span class="keyword">def</span> <span class="function">pending_order</span>(order_factory):
    <span class="string">"""–ì–æ—Ç–æ–≤—ã–π pending –æ—Ä–¥–µ—Ä."""</span>
    <span class="keyword">return</span> order_factory(status=OrderStatus.PENDING)


<span class="decorator">@pytest.fixture</span>
<span class="keyword">def</span> <span class="function">filled_order</span>(order_factory):
    <span class="string">"""–ì–æ—Ç–æ–≤—ã–π filled –æ—Ä–¥–µ—Ä."""</span>
    order = order_factory(status=OrderStatus.PENDING)
    order.fill()
    <span class="keyword">return</span> order</code></pre>

                <h2>Unit —Ç–µ—Å—Ç—ã: –¥–æ–º–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞</h2>

<pre><code><span class="comment"># tests/unit/domain/test_order.py</span>
<span class="keyword">import</span> pytest
<span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal

<span class="keyword">from</span> scaletrade.domain.entities.order <span class="keyword">import</span> Order, OrderStatus
<span class="keyword">from</span> scaletrade.domain.exceptions.order <span class="keyword">import</span> (
    OrderAlreadyFilledError,
    OrderAlreadyCancelledError,
)


<span class="keyword">class</span> <span class="class-name">TestOrderFill</span>:
    <span class="string">"""–¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–∞."""</span>
    
    <span class="keyword">def</span> <span class="function">test_fill_pending_order</span>(self, pending_order):
        <span class="comment"># Act</span>
        pending_order.fill()
        
        <span class="comment"># Assert</span>
        <span class="keyword">assert</span> pending_order.status == OrderStatus.FILLED
        <span class="keyword">assert</span> pending_order.filled_at <span class="keyword">is not None</span>
    
    <span class="keyword">def</span> <span class="function">test_fill_already_filled_raises</span>(self, filled_order):
        <span class="comment"># Act & Assert</span>
        <span class="keyword">with</span> pytest.raises(OrderAlreadyFilledError):
            filled_order.fill()
    
    <span class="keyword">def</span> <span class="function">test_fill_cancelled_raises</span>(self, order_factory):
        <span class="comment"># Arrange</span>
        order = order_factory()
        order.cancel()
        
        <span class="comment"># Act & Assert</span>
        <span class="keyword">with</span> pytest.raises(OrderAlreadyCancelledError):
            order.fill()


<span class="keyword">class</span> <span class="class-name">TestOrderCancel</span>:
    <span class="string">"""–¢–µ—Å—Ç—ã –æ—Ç–º–µ–Ω—ã –æ—Ä–¥–µ—Ä–∞."""</span>
    
    <span class="keyword">def</span> <span class="function">test_cancel_pending_order</span>(self, pending_order):
        pending_order.cancel()
        <span class="keyword">assert</span> pending_order.status == OrderStatus.CANCELLED
    
    <span class="keyword">def</span> <span class="function">test_cancel_filled_raises</span>(self, filled_order):
        <span class="keyword">with</span> pytest.raises(OrderAlreadyFilledError):
            filled_order.cancel()


<span class="keyword">class</span> <span class="class-name">TestOrderTotalValue</span>:
    <span class="string">"""–¢–µ—Å—Ç—ã —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏."""</span>
    
    <span class="keyword">def</span> <span class="function">test_total_value_calculation</span>(self, order_factory):
        order = order_factory(
            quantity=Money(Decimal(<span class="string">"2.5"</span>), Currency.USD),
            price=Money(Decimal(<span class="string">"100.00"</span>), Currency.USD),
        )
        
        <span class="keyword">assert</span> order.total_value.amount == Decimal(<span class="string">"250.00"</span>)</code></pre>

                <h2>Integration —Ç–µ—Å—Ç—ã: —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏</h2>

<pre><code><span class="comment"># tests/integration/test_order_repository.py</span>
<span class="keyword">import</span> pytest
<span class="keyword">from</span> scaletrade.infrastructure.database.repositories <span class="keyword">import</span> SQLAlchemyOrderRepository


<span class="decorator">@pytest.mark.asyncio</span>
<span class="keyword">class</span> <span class="class-name">TestOrderRepository</span>:
    
    <span class="keyword">async def</span> <span class="function">test_save_and_get</span>(self, session, order_factory):
        <span class="comment"># Arrange</span>
        repo = SQLAlchemyOrderRepository(session)
        order = order_factory()
        
        <span class="comment"># Act</span>
        <span class="keyword">await</span> repo.save(order)
        <span class="keyword">await</span> session.flush()
        
        retrieved = <span class="keyword">await</span> repo.get_by_id(order.id)
        
        <span class="comment"># Assert</span>
        <span class="keyword">assert</span> retrieved <span class="keyword">is not None</span>
        <span class="keyword">assert</span> retrieved.id == order.id
        <span class="keyword">assert</span> retrieved.symbol == order.symbol
    
    <span class="keyword">async def</span> <span class="function">test_get_active_by_user</span>(self, session, order_factory):
        <span class="comment"># Arrange</span>
        repo = SQLAlchemyOrderRepository(session)
        user_id = UserId(<span class="number">123</span>)
        
        <span class="comment"># –°–æ–∑–¥–∞—ë–º 3 –æ—Ä–¥–µ—Ä–∞: 2 pending, 1 filled</span>
        orders = [
            order_factory(user_id=user_id, status=OrderStatus.PENDING),
            order_factory(user_id=user_id, status=OrderStatus.PENDING),
            order_factory(user_id=user_id, status=OrderStatus.FILLED),
        ]
        <span class="keyword">for</span> o <span class="keyword">in</span> orders:
            <span class="keyword">await</span> repo.save(o)
        <span class="keyword">await</span> session.flush()
        
        <span class="comment"># Act</span>
        active = <span class="keyword">await</span> repo.get_active_by_user(user_id)
        
        <span class="comment"># Assert</span>
        <span class="keyword">assert</span> len(active) == <span class="number">2</span>
        <span class="keyword">assert</span> all(o.status == OrderStatus.PENDING <span class="keyword">for</span> o <span class="keyword">in</span> active)</code></pre>

                <h2>Property-based Testing —Å Hypothesis</h2>
                
                <p>
                    Hypothesis –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç—ã—Å—è—á–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–ª—É—á–∞–µ–≤, –Ω–∞—Ö–æ–¥—è edge cases, 
                    –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –±—ã –Ω–µ –ø—Ä–∏–¥—É–º–∞–ª.
                </p>

<pre><code><span class="comment"># tests/unit/domain/test_money_hypothesis.py</span>
<span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal
<span class="keyword">from</span> hypothesis <span class="keyword">import</span> given, strategies <span class="keyword">as</span> st

<span class="keyword">from</span> scaletrade.domain.value_objects.money <span class="keyword">import</span> Money, Currency


<span class="comment"># –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Money</span>
money_strategy = st.builds(
    Money,
    amount=st.decimals(
        min_value=Decimal(<span class="string">"0"</span>),
        max_value=Decimal(<span class="string">"1000000"</span>),
        places=<span class="number">4</span>,
        allow_nan=<span class="keyword">False</span>,
        allow_infinity=<span class="keyword">False</span>,
    ),
    currency=st.just(Currency.USD),
)


<span class="keyword">class</span> <span class="class-name">TestMoneyProperties</span>:
    <span class="string">"""Property-based —Ç–µ—Å—Ç—ã –¥–ª—è Money."""</span>
    
    <span class="decorator">@given</span>(money_strategy, money_strategy)
    <span class="keyword">def</span> <span class="function">test_addition_is_commutative</span>(self, a: Money, b: Money):
        <span class="string">"""a + b == b + a"""</span>
        <span class="keyword">assert</span> a + b == b + a
    
    <span class="decorator">@given</span>(money_strategy, money_strategy, money_strategy)
    <span class="keyword">def</span> <span class="function">test_addition_is_associative</span>(self, a: Money, b: Money, c: Money):
        <span class="string">"""(a + b) + c == a + (b + c)"""</span>
        <span class="keyword">assert</span> (a + b) + c == a + (b + c)
    
    <span class="decorator">@given</span>(money_strategy)
    <span class="keyword">def</span> <span class="function">test_addition_identity</span>(self, m: Money):
        <span class="string">"""m + 0 == m"""</span>
        zero = Money.zero(m.currency)
        <span class="keyword">assert</span> m + zero == m
    
    <span class="decorator">@given</span>(money_strategy, st.integers(min_value=<span class="number">1</span>, max_value=<span class="number">100</span>))
    <span class="keyword">def</span> <span class="function">test_multiplication_is_distributive</span>(self, m: Money, n: <span class="type">int</span>):
        <span class="string">"""m * n == m + m + ... (n —Ä–∞–∑)"""</span>
        result = Money.zero(m.currency)
        <span class="keyword">for</span> _ <span class="keyword">in</span> range(n):
            result = result + m
        <span class="keyword">assert</span> m * n == result</code></pre>

                <h2>Mocking –≤–Ω–µ—à–Ω–∏—Ö API (respx)</h2>

<pre><code><span class="comment"># tests/integration/test_external_api.py</span>
<span class="keyword">import</span> pytest
<span class="keyword">import</span> respx
<span class="keyword">from</span> httpx <span class="keyword">import</span> Response

<span class="keyword">from</span> scaletrade.infrastructure.external.price_service <span class="keyword">import</span> PriceService


<span class="decorator">@pytest.mark.asyncio</span>
<span class="keyword">class</span> <span class="class-name">TestPriceService</span>:
    
    <span class="decorator">@respx.mock</span>
    <span class="keyword">async def</span> <span class="function">test_get_price_success</span>(self):
        <span class="comment"># Arrange</span>
        respx.get(<span class="string">"https://api.exchange.com/price/BTC"</span>).mock(
            return_value=Response(
                <span class="number">200</span>,
                json={<span class="string">"symbol"</span>: <span class="string">"BTC"</span>, <span class="string">"price"</span>: <span class="string">"50000.00"</span>}
            )
        )
        
        service = PriceService()
        
        <span class="comment"># Act</span>
        price = <span class="keyword">await</span> service.get_price(<span class="string">"BTC"</span>)
        
        <span class="comment"># Assert</span>
        <span class="keyword">assert</span> price == Decimal(<span class="string">"50000.00"</span>)
    
    <span class="decorator">@respx.mock</span>
    <span class="keyword">async def</span> <span class="function">test_get_price_api_error_retries</span>(self):
        <span class="comment"># –ú–æ–∫–∞–µ–º 2 –æ—à–∏–±–∫–∏, –ø–æ—Ç–æ–º —É—Å–ø–µ—Ö</span>
        route = respx.get(<span class="string">"https://api.exchange.com/price/BTC"</span>)
        route.side_effect = [
            Response(<span class="number">500</span>),
            Response(<span class="number">500</span>),
            Response(<span class="number">200</span>, json={<span class="string">"price"</span>: <span class="string">"50000.00"</span>}),
        ]
        
        service = PriceService()
        price = <span class="keyword">await</span> service.get_price(<span class="string">"BTC"</span>)
        
        <span class="keyword">assert</span> price == Decimal(<span class="string">"50000.00"</span>)
        <span class="keyword">assert</span> route.call_count == <span class="number">3</span></code></pre>

                <h2>Freezegun: –∫–æ–Ω—Ç—Ä–æ–ª—å –≤—Ä–µ–º–µ–Ω–∏</h2>

<pre><code><span class="comment"># tests/unit/test_time_sensitive.py</span>
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta
<span class="keyword">from</span> freezegun <span class="keyword">import</span> freeze_time


<span class="keyword">class</span> <span class="class-name">TestOrderExpiration</span>:
    
    <span class="decorator">@freeze_time</span>(<span class="string">"2024-01-15 12:00:00"</span>)
    <span class="keyword">def</span> <span class="function">test_order_not_expired</span>(self, order_factory):
        order = order_factory()
        <span class="keyword">assert not</span> order.is_expired
    
    <span class="keyword">def</span> <span class="function">test_order_expires_after_24h</span>(self, order_factory):
        <span class="keyword">with</span> freeze_time(<span class="string">"2024-01-15 12:00:00"</span>):
            order = order_factory()
        
        <span class="comment"># –ü–µ—Ä–µ–º–∞—Ç—ã–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ 25 —á–∞—Å–æ–≤ –≤–ø–µ—Ä—ë–¥</span>
        <span class="keyword">with</span> freeze_time(<span class="string">"2024-01-16 13:00:00"</span>):
            <span class="keyword">assert</span> order.is_expired</code></pre>

                <h2>ü™® –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏</h2>
                <div class="accordion">
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>1. Over-Mocking</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ï—Å–ª–∏ –≤ –≤–∞—à–µ–º —Ç–µ—Å—Ç–µ –º–æ–∫–æ–≤ –±–æ–ª—å—à–µ, —á–µ–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ ‚Äî –≤—ã —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç–µ —Å–≤–æ–∏ —Ñ–∞–Ω—Ç–∞–∑–∏–∏ –æ —Ç–æ–º, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ–¥, –∞ –Ω–µ —Å–∞–º –∫–æ–¥. –ï—Å–ª–∏ –≤—ã –∑–∞–º–æ–∫–∞–ª–∏ –ë–î, Redis –∏ HTTP-–∫–ª–∏–µ–Ω—Ç, —Ç–æ —á—Ç–æ –≤—ã —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç–µ? –õ–æ–≥–∏–∫—É —Å–∫–ª–µ–π–∫–∏ –º–æ–∫–æ–≤? –°—Ç—Ä–µ–º–∏—Ç–µ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Testcontainers –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>2. Flaky Tests (–ú–æ—Ä–≥–∞—é—â–∏–µ —Ç–µ—Å—Ç—ã)</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–¢–µ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ç–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç, —Ç–æ –ø–∞–¥–∞–µ—Ç (–∏–∑-–∑–∞ <code>random</code>, –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –≥–æ–Ω–∫–∏ –≤ –ë–î) ‚Äî —Ö—É–∂–µ, —á–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–µ—Å—Ç–∞. –û–Ω –ø–æ–¥—Ä—ã–≤–∞–µ—Ç –¥–æ–≤–µ—Ä–∏–µ –∫ CI. –ï—Å–ª–∏ —Ç–µ—Å—Ç –Ω–∞—á–∞–ª "–º–æ—Ä–≥–∞—Ç—å" ‚Äî —á–∏–Ω–∏—Ç–µ –µ–≥–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∏–ª–∏ —É–¥–∞–ª—è–π—Ç–µ.</p>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <strong>3. –û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</strong>
                        </div>
                        <div class="accordion-content">
                            <p>–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ª–∞–≥–∞–π—Ç–µ—Å—å –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤. –ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–∞–º —Å–µ–±–µ –≥–æ—Ç–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ (–≤ –∏–¥–µ–∞–ª–µ) —á–∏—Å—Ç–∏—Ç—å –∑–∞ —Å–æ–±–æ–π. –ï—Å–ª–∏ —Ç–µ—Å—Ç –ê –≤—Å—Ç–∞–≤–∏–ª –∑–∞–ø–∏—Å—å –≤ –ë–î, –∞ —Ç–µ—Å—Ç –ë —É–ø–∞–ª, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–∂–∏–¥–∞–ª –ø—É—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É ‚Äî —ç—Ç–æ –ø–ª–æ—Ö–∏–µ —Ç–µ—Å—Ç—ã.</p>
                        </div>
                    </div>
                </div>

                <h2>üí° –õ–∞–π—Ñ—Ö–∞–∫–∏</h2>
                <ul>
                    <li><strong>Hypothesis:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Property-based testing. –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å <code>assert add(2, 2) == 4</code>, –≤—ã –æ–ø–∏—Å—ã–≤–∞–µ—Ç–µ —Å–≤–æ–π—Å—Ç–≤–æ: <code>–¥–ª—è –ª—é–±—ã—Ö a –∏ b: add(a, b) == add(b, a)</code>. Hypothesis —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ—Ç–Ω–∏ –∫—Ä–∞–µ–≤—ã—Ö —Å–ª—É—á–∞–µ–≤ (–Ω–æ–ª–∏, –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏, unicode) –∏ –ø–æ–ø—Ä–æ–±—É–µ—Ç —Å–ª–æ–º–∞—Ç—å –≤–∞—à –∫–æ–¥.</li>
                    <li><strong>Mutation Testing:</strong> –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ç–∏–ø–∞ <code>mutmut</code> –º–µ–Ω—è—é—Ç –≤–∞—à –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, <code>></code> –Ω–∞ <code>>=</code>) –∏ –∑–∞–ø—É—Å–∫–∞—é—Ç —Ç–µ—Å—Ç—ã. –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ ("–º—É—Ç–∞–Ω—Ç –≤—ã–∂–∏–ª") ‚Äî –∑–Ω–∞—á–∏—Ç, –≤–∞—à —Ç–µ—Å—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç—Ä–æ–≥.</li>
                    <li><strong>Pytest Plugins:</strong>
                        <ul>
                            <li><code>pytest-xdist</code>: –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –Ω–∞ –≤—Å–µ—Ö —è–¥—Ä–∞—Ö.</li>
                            <li><code>pytest-deadfixtures</code>: –ø–æ–∏—Å–∫ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ñ–∏–∫—Å—Ç—É—Ä.</li>
                            <li><code>pytest-cov</code>: –ø–æ–∫—Ä—ã—Ç–∏–µ (–Ω–µ –≥–æ–Ω–∏—Ç–µ—Å—å –∑–∞ 100%, 80-90% –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ).</li>
                        </ul>
                    </li>
                </ul>

                <div class="task-box">
                    <h4>üìã –ó–∞–¥–∞–Ω–∏–µ</h4>
                    <ul class="task-list">
                        <li>–ù–∞—Å—Ç—Ä–æ–π Testcontainers –¥–ª—è PostgreSQL –∏ Redis</li>
                        <li>–°–æ–∑–¥–∞–π —Ñ–∞–±—Ä–∏–∫—É –¥–ª—è Order —Å factory_boy</li>
                        <li>–ù–∞–ø–∏—à–∏ unit —Ç–µ—Å—Ç—ã –¥–ª—è –¥–æ–º–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ Order</li>
                        <li>–ù–∞–ø–∏—à–∏ integration —Ç–µ—Å—Ç—ã –¥–ª—è OrderRepository</li>
                        <li>–î–æ–±–∞–≤—å property-based —Ç–µ—Å—Ç—ã –¥–ª—è Money —Å Hypothesis</li>
                    </ul>
                </div>

                <div class="nav-footer">
                    <a href="part3_redis.html">
                        <div>
                            <div class="nav-label">–ù–∞–∑–∞–¥</div>
                            <div class="nav-title">‚Üê 3.2 Redis Patterns</div>
                        </div>
                    </a>
                    <a href="part4_resiliency.html">
                        <div>
                            <div class="nav-label">–î–∞–ª–µ–µ</div>
                            <div class="nav-title">4.2 Resiliency ‚Üí</div>
                        </div>
                    </a>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
